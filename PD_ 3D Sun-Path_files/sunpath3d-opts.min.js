/**! @preserve
 * ============================================================================
 * PERFORMATIVE DESIGN WEB APP SOURCE CODE
 * This work is protected by copyright laws and international treaties.
 * Copyright (c) 2014-2018, Dr. Andrew J. Marsh.
 * All Rights Reserved.
 * ============================================================================
 */
/**
 * @license
 * Copyright 2000, Silicon Graphics, Inc. All Rights Reserved.
 * Copyright 2014, Google Inc. All Rights Reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to
 * deal in the Software without restriction, including without limitation the
 * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
 * sell copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice including the dates of first publication and
 * either this permission notice or a reference to http://oss.sgi.com/projects/FreeB/
 * shall be included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
 * SILICON GRAPHICS, INC. BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR
 * IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * Original Code. The Original Code is: OpenGL Sample Implementation,
 * Version 1.2.1, released January 26, 2000, developed by Silicon Graphics,
 * Inc. The Original Code is Copyright (c) 1991-2000 Silicon Graphics, Inc.
 * Copyright in any portions created by third parties is as indicated
 * elsewhere herein. All Rights Reserved.
 */
var libtess={DEBUG:!0,assert:function(e,t){if(libtess.DEBUG&&!e)throw new Error("Assertion failed"+(t?": "+t:""))},GLU_TESS_MAX_COORD:1e150,TRUE_PROJECT:!1,TESS_MAX_CACHE:100,GLU_TESS_DEFAULT_TOLERANCE:0,windingRule:{GLU_TESS_WINDING_ODD:100130,GLU_TESS_WINDING_NONZERO:100131,GLU_TESS_WINDING_POSITIVE:100132,GLU_TESS_WINDING_NEGATIVE:100133,GLU_TESS_WINDING_ABS_GEQ_TWO:100134},primitiveType:{GL_LINE_LOOP:2,GL_TRIANGLES:4,GL_TRIANGLE_STRIP:5,GL_TRIANGLE_FAN:6},errorType:{GLU_TESS_MISSING_BEGIN_POLYGON:100151,GLU_TESS_MISSING_END_POLYGON:100153,GLU_TESS_MISSING_BEGIN_CONTOUR:100152,GLU_TESS_MISSING_END_CONTOUR:100154,GLU_TESS_COORD_TOO_LARGE:100155,GLU_TESS_NEED_COMBINE_CALLBACK:100156},gluEnum:{GLU_TESS_BEGIN:100100,GLU_TESS_VERTEX:100101,GLU_TESS_END:100102,GLU_TESS_ERROR:100103,GLU_TESS_EDGE_FLAG:100104,GLU_TESS_COMBINE:100105,GLU_TESS_BEGIN_DATA:100106,GLU_TESS_VERTEX_DATA:100107,GLU_TESS_END_DATA:100108,GLU_TESS_ERROR_DATA:100109,GLU_TESS_EDGE_FLAG_DATA:100110,GLU_TESS_COMBINE_DATA:100111,GLU_TESS_MESH:100112,GLU_TESS_TOLERANCE:100142,GLU_TESS_WINDING_RULE:100140,GLU_TESS_BOUNDARY_ONLY:100141,GLU_INVALID_ENUM:100900,GLU_INVALID_VALUE:100901}};libtess.PQHandle,libtess.PQKey,libtess.geom={},libtess.geom.vertEq=function(e,t){return e.s===t.s&&e.t===t.t},libtess.geom.vertLeq=function(e,t){return e.s<t.s||e.s===t.s&&e.t<=t.t},libtess.geom.edgeEval=function(e,t,i){libtess.assert(libtess.geom.vertLeq(e,t)&&libtess.geom.vertLeq(t,i));var a=t.s-e.s,r=i.s-t.s;return 0<a+r?a<r?t.t-e.t+(e.t-i.t)*(a/(a+r)):t.t-i.t+(i.t-e.t)*(r/(a+r)):0},libtess.geom.edgeSign=function(e,t,i){libtess.assert(libtess.geom.vertLeq(e,t)&&libtess.geom.vertLeq(t,i));var a=t.s-e.s,r=i.s-t.s;return 0<a+r?(t.t-i.t)*a+(t.t-e.t)*r:0},libtess.geom.transLeq=function(e,t){return e.t<t.t||e.t===t.t&&e.s<=t.s},libtess.geom.transEval=function(e,t,i){libtess.assert(libtess.geom.transLeq(e,t)&&libtess.geom.transLeq(t,i));var a=t.t-e.t,r=i.t-t.t;return 0<a+r?a<r?t.s-e.s+(e.s-i.s)*(a/(a+r)):t.s-i.s+(i.s-e.s)*(r/(a+r)):0},libtess.geom.transSign=function(e,t,i){libtess.assert(libtess.geom.transLeq(e,t)&&libtess.geom.transLeq(t,i));var a=t.t-e.t,r=i.t-t.t;return 0<a+r?(t.s-i.s)*a+(t.s-e.s)*r:0},libtess.geom.edgeGoesLeft=function(e){return libtess.geom.vertLeq(e.dst(),e.org)},libtess.geom.edgeGoesRight=function(e){return libtess.geom.vertLeq(e.org,e.dst())},libtess.geom.vertL1dist=function(e,t){return Math.abs(e.s-t.s)+Math.abs(e.t-t.t)},libtess.geom.vertCCW=function(e,t,i){return 0<=e.s*(t.t-i.t)+t.s*(i.t-e.t)+i.s*(e.t-t.t)},libtess.geom.interpolate_=function(e,t,i,a){return(e=e<0?0:e)<=(i=i<0?0:i)?0===i?(t+a)/2:t+e/(e+i)*(a-t):a+i/(e+i)*(t-a)},libtess.geom.edgeIntersect=function(e,t,i,a,r){var n,s,o;libtess.geom.vertLeq(e,t)||(o=e,e=t,t=o),libtess.geom.vertLeq(i,a)||(o=i,i=a,a=o),libtess.geom.vertLeq(e,i)||(o=e,e=i,i=o,o=t,t=a,a=o),libtess.geom.vertLeq(i,t)?libtess.geom.vertLeq(t,a)?((n=libtess.geom.edgeEval(e,i,t))+(s=libtess.geom.edgeEval(i,t,a))<0&&(n=-n,s=-s),r.s=libtess.geom.interpolate_(n,i.s,s,t.s)):((n=libtess.geom.edgeSign(e,i,t))+(s=-libtess.geom.edgeSign(e,a,t))<0&&(n=-n,s=-s),r.s=libtess.geom.interpolate_(n,i.s,s,a.s)):r.s=(i.s+t.s)/2,libtess.geom.transLeq(e,t)||(o=e,e=t,t=o),libtess.geom.transLeq(i,a)||(o=i,i=a,a=o),libtess.geom.transLeq(e,i)||(o=e,e=i,i=o,o=t,t=a,a=o),libtess.geom.transLeq(i,t)?libtess.geom.transLeq(t,a)?((n=libtess.geom.transEval(e,i,t))+(s=libtess.geom.transEval(i,t,a))<0&&(n=-n,s=-s),r.t=libtess.geom.interpolate_(n,i.t,s,t.t)):((n=libtess.geom.transSign(e,i,t))+(s=-libtess.geom.transSign(e,a,t))<0&&(n=-n,s=-s),r.t=libtess.geom.interpolate_(n,i.t,s,a.t)):r.t=(i.t+t.t)/2},libtess.mesh={},libtess.mesh.makeEdge=function(e){var t=libtess.mesh.makeEdgePair_(e.eHead);return libtess.mesh.makeVertex_(t,e.vHead),libtess.mesh.makeVertex_(t.sym,e.vHead),libtess.mesh.makeFace_(t,e.fHead),t},libtess.mesh.meshSplice=function(e,t){var i=!1,a=!1;e!==t&&(t.org!==e.org&&(a=!0,libtess.mesh.killVertex_(t.org,e.org)),t.lFace!==e.lFace&&(i=!0,libtess.mesh.killFace_(t.lFace,e.lFace)),libtess.mesh.splice_(t,e),a||(libtess.mesh.makeVertex_(t,e.org),e.org.anEdge=e),i||(libtess.mesh.makeFace_(t,e.lFace),e.lFace.anEdge=e))},libtess.mesh.deleteEdge=function(e){var t=e.sym,i=!1;e.lFace!==e.rFace()&&(i=!0,libtess.mesh.killFace_(e.lFace,e.rFace())),e.oNext===e?libtess.mesh.killVertex_(e.org,null):(e.rFace().anEdge=e.oPrev(),e.org.anEdge=e.oNext,libtess.mesh.splice_(e,e.oPrev()),i||libtess.mesh.makeFace_(e,e.lFace)),t.oNext===t?(libtess.mesh.killVertex_(t.org,null),libtess.mesh.killFace_(t.lFace,null)):(e.lFace.anEdge=t.oPrev(),t.org.anEdge=t.oNext,libtess.mesh.splice_(t,t.oPrev())),libtess.mesh.killEdge_(e)},libtess.mesh.addEdgeVertex=function(e){var t=libtess.mesh.makeEdgePair_(e),i=t.sym;return libtess.mesh.splice_(t,e.lNext),t.org=e.dst(),libtess.mesh.makeVertex_(i,t.org),t.lFace=i.lFace=e.lFace,t},libtess.mesh.splitEdge=function(e){var t=libtess.mesh.addEdgeVertex(e).sym;return libtess.mesh.splice_(e.sym,e.sym.oPrev()),libtess.mesh.splice_(e.sym,t),e.sym.org=t.org,t.dst().anEdge=t.sym,t.sym.lFace=e.rFace(),t.winding=e.winding,t.sym.winding=e.sym.winding,t},libtess.mesh.connect=function(e,t){var i=!1,a=libtess.mesh.makeEdgePair_(e),r=a.sym;return t.lFace!==e.lFace&&(i=!0,libtess.mesh.killFace_(t.lFace,e.lFace)),libtess.mesh.splice_(a,e.lNext),libtess.mesh.splice_(r,t),a.org=e.dst(),r.org=t.org,a.lFace=r.lFace=e.lFace,e.lFace.anEdge=r,i||libtess.mesh.makeFace_(a,e.lFace),a},libtess.mesh.zapFace=function(e){var t,i=e.anEdge,a=i.lNext;do{if(a=(t=a).lNext,(t.lFace=null)===t.rFace()){t.oNext===t?libtess.mesh.killVertex_(t.org,null):(t.org.anEdge=t.oNext,libtess.mesh.splice_(t,t.oPrev()));var r=t.sym;r.oNext===r?libtess.mesh.killVertex_(r.org,null):(r.org.anEdge=r.oNext,libtess.mesh.splice_(r,r.oPrev())),libtess.mesh.killEdge_(t)}}while(t!==i);var n=e.prev,s=e.next;(s.prev=n).next=s},libtess.mesh.meshUnion=function(e,t){var i=e.fHead,a=e.vHead,r=e.eHead,n=t.fHead,s=t.vHead,o=t.eHead;return n.next!==n&&(i.prev.next=n.next,n.next.prev=i.prev,(n.prev.next=i).prev=n.prev),s.next!==s&&(a.prev.next=s.next,s.next.prev=a.prev,(s.prev.next=a).prev=s.prev),o.next!==o&&(r.sym.next.sym.next=o.next,o.next.sym.next=r.sym.next,(o.sym.next.sym.next=r).sym.next=o.sym.next),e},libtess.mesh.deleteMesh=function(e){},libtess.mesh.makeEdgePair_=function(e){var t=new libtess.GluHalfEdge,i=new libtess.GluHalfEdge,a=e.sym.next;return(((i.next=a).sym.next=t).next=e).sym.next=i,t.sym=i,((t.oNext=t).lNext=i).sym=t,(i.oNext=i).lNext=t},libtess.mesh.splice_=function(e,t){var i=e.oNext,a=t.oNext;i.sym.lNext=t,(a.sym.lNext=e).oNext=a,t.oNext=i},libtess.mesh.makeVertex_=function(e,t){var i=t.prev,a=new libtess.GluVertex(t,i);i.next=a;for(var r=(t.prev=a).anEdge=e;r.org=a,(r=r.oNext)!==e;);},libtess.mesh.makeFace_=function(e,t){var i=t.prev,a=new libtess.GluFace(t,i);i.next=a,(t.prev=a).anEdge=e,a.inside=t.inside;for(var r=e;r.lFace=a,(r=r.lNext)!==e;);},libtess.mesh.killEdge_=function(e){var t=e.next,i=e.sym.next;(t.sym.next=i).sym.next=t},libtess.mesh.killVertex_=function(e,t){for(var i=e.anEdge,a=i;a.org=t,(a=a.oNext)!==i;);var r=e.prev,n=e.next;(n.prev=r).next=n},libtess.mesh.killFace_=function(e,t){for(var i=e.anEdge,a=i;a.lFace=t,(a=a.lNext)!==i;);var r=e.prev,n=e.next;(n.prev=r).next=n},libtess.normal={},libtess.normal.S_UNIT_X_=1,libtess.normal.S_UNIT_Y_=0,libtess.normal.projectPolygon=function(e){var t=!1,i=[e.normal[0],e.normal[1],e.normal[2]];0===i[0]&&0===i[1]&&0===i[2]&&(libtess.normal.computeNormal_(e,i),t=!0);var a=e.sUnit,r=e.tUnit,n=libtess.normal.longAxis_(i);if(libtess.TRUE_PROJECT){libtess.normal.normalize_(i),a[n]=0,a[(n+1)%3]=libtess.normal.S_UNIT_X_,a[(n+2)%3]=libtess.normal.S_UNIT_Y_;var s=libtess.normal.dot_(a,i);a[0]-=s*i[0],a[1]-=s*i[1],a[2]-=s*i[2],libtess.normal.normalize_(a),r[0]=i[1]*a[2]-i[2]*a[1],r[1]=i[2]*a[0]-i[0]*a[2],r[2]=i[0]*a[1]-i[1]*a[0],libtess.normal.normalize_(r)}else a[n]=0,a[(n+1)%3]=libtess.normal.S_UNIT_X_,a[(n+2)%3]=libtess.normal.S_UNIT_Y_,r[n]=0,r[(n+1)%3]=0<i[n]?-libtess.normal.S_UNIT_Y_:libtess.normal.S_UNIT_Y_,r[(n+2)%3]=0<i[n]?libtess.normal.S_UNIT_X_:-libtess.normal.S_UNIT_X_;for(var o=e.mesh.vHead,l=o.next;l!==o;l=l.next)l.s=libtess.normal.dot_(l.coords,a),l.t=libtess.normal.dot_(l.coords,r);t&&libtess.normal.checkOrientation_(e)},libtess.normal.dot_=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},libtess.normal.normalize_=function(e){var t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];libtess.assert(0<t),t=Math.sqrt(t),e[0]/=t,e[1]/=t,e[2]/=t},libtess.normal.longAxis_=function(e){var t=0;return Math.abs(e[1])>Math.abs(e[0])&&(t=1),Math.abs(e[2])>Math.abs(e[t])&&(t=2),t},libtess.normal.computeNormal_=function(e,t){var i,a=[-2*libtess.GLU_TESS_MAX_COORD,-2*libtess.GLU_TESS_MAX_COORD,-2*libtess.GLU_TESS_MAX_COORD],r=[2*libtess.GLU_TESS_MAX_COORD,2*libtess.GLU_TESS_MAX_COORD,2*libtess.GLU_TESS_MAX_COORD],n=[],s=[],o=e.mesh.vHead;for(i=o.next;i!==o;i=i.next)for(var l=0;l<3;++l){var d=i.coords[l];d<r[l]&&(r[l]=d,s[l]=i),d>a[l]&&(a[l]=d,n[l]=i)}var h=0;if(a[1]-r[1]>a[0]-r[0]&&(h=1),a[2]-r[2]>a[h]-r[h]&&(h=2),r[h]>=a[h])return t[0]=0,t[1]=0,void(t[2]=1);var c=0,p=s[h],u=n[h],g=[0,0,0],m=[p.coords[0]-u.coords[0],p.coords[1]-u.coords[1],p.coords[2]-u.coords[2]],f=[0,0,0];for(i=o.next;i!==o;i=i.next){f[0]=i.coords[0]-u.coords[0],f[1]=i.coords[1]-u.coords[1],f[2]=i.coords[2]-u.coords[2],g[0]=m[1]*f[2]-m[2]*f[1],g[1]=m[2]*f[0]-m[0]*f[2],g[2]=m[0]*f[1]-m[1]*f[0];var v=g[0]*g[0]+g[1]*g[1]+g[2]*g[2];c<v&&(c=v,t[0]=g[0],t[1]=g[1],t[2]=g[2])}c<=0&&(t[0]=t[1]=t[2]=0,t[libtess.normal.longAxis_(m)]=1)},libtess.normal.checkOrientation_=function(e){for(var t=0,i=e.mesh.fHead,a=i.next;a!==i;a=a.next){var r=a.anEdge;if(!(r.winding<=0))for(;t+=(r.org.s-r.dst().s)*(r.org.t+r.dst().t),(r=r.lNext)!==a.anEdge;);}if(t<0){for(var n=e.mesh.vHead,s=n.next;s!==n;s=s.next)s.t=-s.t;e.tUnit[0]=-e.tUnit[0],e.tUnit[1]=-e.tUnit[1],e.tUnit[2]=-e.tUnit[2]}},libtess.render={},libtess.render.renderMesh=function(e,t,i){for(var a=!1,r=-1,n=t.fHead.prev;n!==t.fHead;n=n.prev)if(n.inside){a||(e.callBeginOrBeginData(libtess.primitiveType.GL_TRIANGLES),a=!0);var s=n.anEdge;libtess.assert(s.lNext.lNext.lNext===s,"renderMesh called with non-triangulated mesh");do{if(i){var o=s.rFace().inside?0:1;r!==o&&(r=o,e.callEdgeFlagOrEdgeFlagData(!!r))}e.callVertexOrVertexData(s.org.data),s=s.lNext}while(s!==n.anEdge)}a&&e.callEndOrEndData()},libtess.render.renderBoundary=function(e,t){for(var i=t.fHead.next;i!==t.fHead;i=i.next)if(i.inside){e.callBeginOrBeginData(libtess.primitiveType.GL_LINE_LOOP);for(var a=i.anEdge;e.callVertexOrVertexData(a.org.data),(a=a.lNext)!==i.anEdge;);e.callEndOrEndData()}},libtess.sweep={},libtess.sweep.SENTINEL_COORD_=4*libtess.GLU_TESS_MAX_COORD,libtess.sweep.TOLERANCE_NONZERO_=!1,libtess.sweep.computeInterior=function(e){var t;for(e.fatalError=!1,libtess.sweep.removeDegenerateEdges_(e),libtess.sweep.initPriorityQ_(e),libtess.sweep.initEdgeDict_(e);null!==(t=e.pq.extractMin());){for(;;){var i=e.pq.minimum();if(null===i||!libtess.geom.vertEq(i,t))break;i=e.pq.extractMin(),libtess.sweep.spliceMergeVertices_(e,t.anEdge,i.anEdge)}libtess.sweep.sweepEvent_(e,t)}var a=e.dict.getMin().getKey();e.event=a.eUp.org,libtess.sweep.doneEdgeDict_(e),libtess.sweep.donePriorityQ_(e),libtess.sweep.removeDegenerateFaces_(e.mesh),e.mesh.checkMesh()},libtess.sweep.addWinding_=function(e,t){e.winding+=t.winding,e.sym.winding+=t.sym.winding},libtess.sweep.edgeLeq_=function(e,t,i){var a=e.event,r=t.eUp,n=i.eUp;if(r.dst()===a)return n.dst()===a?libtess.geom.vertLeq(r.org,n.org)?libtess.geom.edgeSign(n.dst(),r.org,n.org)<=0:0<=libtess.geom.edgeSign(r.dst(),n.org,r.org):libtess.geom.edgeSign(n.dst(),a,n.org)<=0;if(n.dst()===a)return 0<=libtess.geom.edgeSign(r.dst(),a,r.org);var s=libtess.geom.edgeEval(r.dst(),a,r.org);return libtess.geom.edgeEval(n.dst(),a,n.org)<=s},libtess.sweep.deleteRegion_=function(e,t){t.fixUpperEdge&&libtess.assert(0===t.eUp.winding),t.eUp.activeRegion=null,e.dict.deleteNode(t.nodeUp),t.nodeUp=null},libtess.sweep.fixUpperEdge_=function(e,t){libtess.assert(e.fixUpperEdge),libtess.mesh.deleteEdge(e.eUp),e.fixUpperEdge=!1,(e.eUp=t).activeRegion=e},libtess.sweep.topLeftRegion_=function(e){for(var t=e.eUp.org;(e=e.regionAbove()).eUp.org===t;);if(e.fixUpperEdge){var i=libtess.mesh.connect(e.regionBelow().eUp.sym,e.eUp.lNext);libtess.sweep.fixUpperEdge_(e,i),e=e.regionAbove()}return e},libtess.sweep.topRightRegion_=function(e){for(var t=e.eUp.dst();(e=e.regionAbove()).eUp.dst()===t;);return e},libtess.sweep.addRegionBelow_=function(e,t,i){var a=new libtess.ActiveRegion;return a.eUp=i,a.nodeUp=e.dict.insertBefore(t.nodeUp,a),i.activeRegion=a},libtess.sweep.isWindingInside_=function(e,t){switch(e.windingRule){case libtess.windingRule.GLU_TESS_WINDING_ODD:return 0!=(1&t);case libtess.windingRule.GLU_TESS_WINDING_NONZERO:return 0!==t;case libtess.windingRule.GLU_TESS_WINDING_POSITIVE:return 0<t;case libtess.windingRule.GLU_TESS_WINDING_NEGATIVE:return t<0;case libtess.windingRule.GLU_TESS_WINDING_ABS_GEQ_TWO:return 2<=t||t<=-2}return libtess.assert(!1),!1},libtess.sweep.computeWinding_=function(e,t){t.windingNumber=t.regionAbove().windingNumber+t.eUp.winding,t.inside=libtess.sweep.isWindingInside_(e,t.windingNumber)},libtess.sweep.finishRegion_=function(e,t){var i=t.eUp,a=i.lFace;a.inside=t.inside,a.anEdge=i,libtess.sweep.deleteRegion_(e,t)},libtess.sweep.finishLeftRegions_=function(e,t,i){for(var a=t,r=t.eUp;a!==i;){a.fixUpperEdge=!1;var n=a.regionBelow(),s=n.eUp;if(s.org!==r.org){if(!n.fixUpperEdge){libtess.sweep.finishRegion_(e,a);break}s=libtess.mesh.connect(r.lPrev(),s.sym),libtess.sweep.fixUpperEdge_(n,s)}r.oNext!==s&&(libtess.mesh.meshSplice(s.oPrev(),s),libtess.mesh.meshSplice(r,s)),libtess.sweep.finishRegion_(e,a),r=n.eUp,a=n}return r},libtess.sweep.addRightEdges_=function(e,t,i,a,r,n){for(var s=!0,o=i;libtess.assert(libtess.geom.vertLeq(o.org,o.dst())),libtess.sweep.addRegionBelow_(e,t,o.sym),(o=o.oNext)!==a;);null===r&&(r=t.regionBelow().eUp.rPrev());for(var l,d=t,h=r;(o=(l=d.regionBelow()).eUp.sym).org===h.org;)o.oNext!==h&&(libtess.mesh.meshSplice(o.oPrev(),o),libtess.mesh.meshSplice(h.oPrev(),o)),l.windingNumber=d.windingNumber-o.winding,l.inside=libtess.sweep.isWindingInside_(e,l.windingNumber),d.dirty=!0,!s&&libtess.sweep.checkForRightSplice_(e,d)&&(libtess.sweep.addWinding_(o,h),libtess.sweep.deleteRegion_(e,d),libtess.mesh.deleteEdge(h)),s=!1,d=l,h=o;d.dirty=!0,libtess.assert(d.windingNumber-o.winding===l.windingNumber),n&&libtess.sweep.walkDirtyRegions_(e,d)},libtess.sweep.callCombine_=function(e,t,i,a,r){var n=[t.coords[0],t.coords[1],t.coords[2]];t.data=null,t.data=e.callCombineOrCombineData(n,i,a),null===t.data&&(r?e.fatalError||(e.callErrorOrErrorData(libtess.errorType.GLU_TESS_NEED_COMBINE_CALLBACK),e.fatalError=!0):t.data=i[0])},libtess.sweep.spliceMergeVertices_=function(e,t,i){var a=[null,null,null,null];a[0]=t.org.data,a[1]=i.org.data,libtess.sweep.callCombine_(e,t.org,a,[.5,.5,0,0],!1),libtess.mesh.meshSplice(t,i)},libtess.sweep.vertexWeights_=function(e,t,i,a,r){var n=libtess.geom.vertL1dist(t,e),s=libtess.geom.vertL1dist(i,e),o=r,l=r+1;a[o]=.5*s/(n+s),a[l]=.5*n/(n+s),e.coords[0]+=a[o]*t.coords[0]+a[l]*i.coords[0],e.coords[1]+=a[o]*t.coords[1]+a[l]*i.coords[1],e.coords[2]+=a[o]*t.coords[2]+a[l]*i.coords[2]},libtess.sweep.getIntersectData_=function(e,t,i,a,r,n){var s=[0,0,0,0],o=[i.data,a.data,r.data,n.data];t.coords[0]=t.coords[1]=t.coords[2]=0,libtess.sweep.vertexWeights_(t,i,a,s,0),libtess.sweep.vertexWeights_(t,r,n,s,2),libtess.sweep.callCombine_(e,t,o,s,!0)},libtess.sweep.checkForRightSplice_=function(e,t){var i=t.regionBelow(),a=t.eUp,r=i.eUp;if(libtess.geom.vertLeq(a.org,r.org)){if(0<libtess.geom.edgeSign(r.dst(),a.org,r.org))return!1;libtess.geom.vertEq(a.org,r.org)?a.org!==r.org&&(e.pq.remove(a.org.pqHandle),libtess.sweep.spliceMergeVertices_(e,r.oPrev(),a)):(libtess.mesh.splitEdge(r.sym),libtess.mesh.meshSplice(a,r.oPrev()),t.dirty=i.dirty=!0)}else{if(libtess.geom.edgeSign(a.dst(),r.org,a.org)<0)return!1;t.regionAbove().dirty=t.dirty=!0,libtess.mesh.splitEdge(a.sym),libtess.mesh.meshSplice(r.oPrev(),a)}return!0},libtess.sweep.checkForLeftSplice_=function(e,t){var i,a=t.regionBelow(),r=t.eUp,n=a.eUp;if(libtess.assert(!libtess.geom.vertEq(r.dst(),n.dst())),libtess.geom.vertLeq(r.dst(),n.dst())){if(libtess.geom.edgeSign(r.dst(),n.dst(),r.org)<0)return!1;t.regionAbove().dirty=t.dirty=!0,i=libtess.mesh.splitEdge(r),libtess.mesh.meshSplice(n.sym,i),i.lFace.inside=t.inside}else{if(0<libtess.geom.edgeSign(n.dst(),r.dst(),n.org))return!1;t.dirty=a.dirty=!0,i=libtess.mesh.splitEdge(n),libtess.mesh.meshSplice(r.lNext,n.sym),i.rFace().inside=t.inside}return!0},libtess.sweep.checkForIntersect_=function(e,t){var i=t.regionBelow(),a=t.eUp,r=i.eUp,n=a.org,s=r.org,o=a.dst(),l=r.dst(),d=new libtess.GluVertex;if(libtess.assert(!libtess.geom.vertEq(l,o)),libtess.assert(libtess.geom.edgeSign(o,e.event,n)<=0),libtess.assert(0<=libtess.geom.edgeSign(l,e.event,s)),libtess.assert(n!==e.event&&s!==e.event),libtess.assert(!t.fixUpperEdge&&!i.fixUpperEdge),n===s)return!1;var h=Math.min(n.t,o.t);if(Math.max(s.t,l.t)<h)return!1;if(libtess.geom.vertLeq(n,s)){if(0<libtess.geom.edgeSign(l,n,s))return!1}else if(libtess.geom.edgeSign(o,s,n)<0)return!1;libtess.geom.edgeIntersect(o,n,l,s,d),libtess.assert(Math.min(n.t,o.t)<=d.t),libtess.assert(d.t<=Math.max(s.t,l.t)),libtess.assert(Math.min(l.s,o.s)<=d.s),libtess.assert(d.s<=Math.max(s.s,n.s)),libtess.geom.vertLeq(d,e.event)&&(d.s=e.event.s,d.t=e.event.t);var c=libtess.geom.vertLeq(n,s)?n:s;if(libtess.geom.vertLeq(c,d)&&(d.s=c.s,d.t=c.t),libtess.geom.vertEq(d,n)||libtess.geom.vertEq(d,s))return libtess.sweep.checkForRightSplice_(e,t),!1;if(!libtess.geom.vertEq(o,e.event)&&0<=libtess.geom.edgeSign(o,e.event,d)||!libtess.geom.vertEq(l,e.event)&&libtess.geom.edgeSign(l,e.event,d)<=0){if(l===e.event)return libtess.mesh.splitEdge(a.sym),libtess.mesh.meshSplice(r.sym,a),a=(t=libtess.sweep.topLeftRegion_(t)).regionBelow().eUp,libtess.sweep.finishLeftRegions_(e,t.regionBelow(),i),libtess.sweep.addRightEdges_(e,t,a.oPrev(),a,a,!0),!0;if(o===e.event){libtess.mesh.splitEdge(r.sym),libtess.mesh.meshSplice(a.lNext,r.oPrev()),i=t;var p=(t=libtess.sweep.topRightRegion_(t)).regionBelow().eUp.rPrev();return i.eUp=r.oPrev(),r=libtess.sweep.finishLeftRegions_(e,i,null),libtess.sweep.addRightEdges_(e,t,r.oNext,a.rPrev(),p,!0),!0}return 0<=libtess.geom.edgeSign(o,e.event,d)&&(t.regionAbove().dirty=t.dirty=!0,libtess.mesh.splitEdge(a.sym),a.org.s=e.event.s,a.org.t=e.event.t),libtess.geom.edgeSign(l,e.event,d)<=0&&(t.dirty=i.dirty=!0,libtess.mesh.splitEdge(r.sym),r.org.s=e.event.s,r.org.t=e.event.t),!1}return libtess.mesh.splitEdge(a.sym),libtess.mesh.splitEdge(r.sym),libtess.mesh.meshSplice(r.oPrev(),a),a.org.s=d.s,a.org.t=d.t,a.org.pqHandle=e.pq.insert(a.org),libtess.sweep.getIntersectData_(e,a.org,n,o,s,l),t.regionAbove().dirty=t.dirty=i.dirty=!0,!1},libtess.sweep.walkDirtyRegions_=function(e,t){for(var i=t.regionBelow();;){for(;i.dirty;)i=(t=i).regionBelow();if(!(t.dirty||null!==(t=(i=t).regionAbove())&&t.dirty))return;t.dirty=!1;var a=t.eUp,r=i.eUp;if(a.dst()!==r.dst()&&libtess.sweep.checkForLeftSplice_(e,t)&&(i.fixUpperEdge?(libtess.sweep.deleteRegion_(e,i),libtess.mesh.deleteEdge(r),r=(i=t.regionBelow()).eUp):t.fixUpperEdge&&(libtess.sweep.deleteRegion_(e,t),libtess.mesh.deleteEdge(a),a=(t=i.regionAbove()).eUp)),a.org!==r.org)if(a.dst()===r.dst()||t.fixUpperEdge||i.fixUpperEdge||a.dst()!==e.event&&r.dst()!==e.event)libtess.sweep.checkForRightSplice_(e,t);else if(libtess.sweep.checkForIntersect_(e,t))return;a.org===r.org&&a.dst()===r.dst()&&(libtess.sweep.addWinding_(r,a),libtess.sweep.deleteRegion_(e,t),libtess.mesh.deleteEdge(a),t=i.regionAbove())}},libtess.sweep.connectRightVertex_=function(e,t,i){var a,r=i.oNext,n=t.regionBelow(),s=t.eUp,o=n.eUp,l=!1;(s.dst()!==o.dst()&&libtess.sweep.checkForIntersect_(e,t),libtess.geom.vertEq(s.org,e.event)&&(libtess.mesh.meshSplice(r.oPrev(),s),r=(t=libtess.sweep.topLeftRegion_(t)).regionBelow().eUp,libtess.sweep.finishLeftRegions_(e,t.regionBelow(),n),l=!0),libtess.geom.vertEq(o.org,e.event)&&(libtess.mesh.meshSplice(i,o.oPrev()),i=libtess.sweep.finishLeftRegions_(e,n,null),l=!0),l)?libtess.sweep.addRightEdges_(e,t,i.oNext,r,r,!0):(a=libtess.geom.vertLeq(o.org,s.org)?o.oPrev():s,a=libtess.mesh.connect(i.lPrev(),a),libtess.sweep.addRightEdges_(e,t,a,a.oNext,a.oNext,!1),a.sym.activeRegion.fixUpperEdge=!0,libtess.sweep.walkDirtyRegions_(e,t))},libtess.sweep.connectLeftDegenerate_=function(e,t,i){var a=t.eUp;if(libtess.geom.vertEq(a.org,i))return libtess.assert(libtess.sweep.TOLERANCE_NONZERO_),void(libtess.sweep.TOLERANCE_NONZERO_&&libtess.sweep.spliceMergeVertices_(e,a,i.anEdge));if(!libtess.geom.vertEq(a.dst(),i))return libtess.mesh.splitEdge(a.sym),t.fixUpperEdge&&(libtess.mesh.deleteEdge(a.oNext),t.fixUpperEdge=!1),libtess.mesh.meshSplice(i.anEdge,a),void libtess.sweep.sweepEvent_(e,i);if(libtess.assert(libtess.sweep.TOLERANCE_NONZERO_),libtess.sweep.TOLERANCE_NONZERO_){var r=(t=libtess.sweep.topRightRegion_(t)).regionBelow(),n=r.eUp.sym,s=n.oNext,o=s;r.fixUpperEdge&&(libtess.assert(s!==n),libtess.sweep.deleteRegion_(e,r),libtess.mesh.deleteEdge(n),n=s.oPrev()),libtess.mesh.meshSplice(i.anEdge,n),libtess.geom.edgeGoesLeft(s)||(s=null),libtess.sweep.addRightEdges_(e,t,n.oNext,o,s,!0)}},libtess.sweep.connectLeftVertex_=function(e,t){var i=new libtess.ActiveRegion;i.eUp=t.anEdge.sym;var a=e.dict.search(i).getKey(),r=a.regionBelow(),n=a.eUp,s=r.eUp;if(0!==libtess.geom.edgeSign(n.dst(),t,n.org)){var o,l=libtess.geom.vertLeq(s.dst(),n.dst())?a:r;if(a.inside||l.fixUpperEdge){if(l===a)o=libtess.mesh.connect(t.anEdge.sym,n.lNext);else o=libtess.mesh.connect(s.dNext(),t.anEdge).sym;l.fixUpperEdge?libtess.sweep.fixUpperEdge_(l,o):libtess.sweep.computeWinding_(e,libtess.sweep.addRegionBelow_(e,a,o)),libtess.sweep.sweepEvent_(e,t)}else libtess.sweep.addRightEdges_(e,a,t.anEdge,t.anEdge,null,!0)}else libtess.sweep.connectLeftDegenerate_(e,a,t)},libtess.sweep.sweepEvent_=function(e,t){for(var i=(e.event=t).anEdge;null===i.activeRegion;)if((i=i.oNext)===t.anEdge)return void libtess.sweep.connectLeftVertex_(e,t);var a=libtess.sweep.topLeftRegion_(i.activeRegion),r=a.regionBelow(),n=r.eUp,s=libtess.sweep.finishLeftRegions_(e,r,null);s.oNext===n?libtess.sweep.connectRightVertex_(e,a,s):libtess.sweep.addRightEdges_(e,a,s.oNext,n,n,!0)},libtess.sweep.addSentinel_=function(e,t){var i=new libtess.ActiveRegion,a=libtess.mesh.makeEdge(e.mesh);a.org.s=libtess.sweep.SENTINEL_COORD_,a.org.t=t,a.dst().s=-libtess.sweep.SENTINEL_COORD_,a.dst().t=t,e.event=a.dst(),i.eUp=a,i.windingNumber=0,i.inside=!1,i.fixUpperEdge=!1,i.sentinel=!0,i.dirty=!1,i.nodeUp=e.dict.insert(i)},libtess.sweep.initEdgeDict_=function(e){e.dict=new libtess.Dict(e,libtess.sweep.edgeLeq_),libtess.sweep.addSentinel_(e,-libtess.sweep.SENTINEL_COORD_),libtess.sweep.addSentinel_(e,libtess.sweep.SENTINEL_COORD_)},libtess.sweep.doneEdgeDict_=function(e){for(var t,i=0;null!==(t=e.dict.getMin().getKey());)t.sentinel||(libtess.assert(t.fixUpperEdge),libtess.assert(1==++i)),libtess.assert(0===t.windingNumber),libtess.sweep.deleteRegion_(e,t);e.dict=null},libtess.sweep.removeDegenerateEdges_=function(e){for(var t,i=e.mesh.eHead,a=i.next;a!==i;a=t){t=a.next;var r=a.lNext;libtess.geom.vertEq(a.org,a.dst())&&a.lNext.lNext!==a&&(libtess.sweep.spliceMergeVertices_(e,r,a),libtess.mesh.deleteEdge(a),r=(a=r).lNext),r.lNext===a&&(r!==a&&(r!==t&&r!==t.sym||(t=t.next),libtess.mesh.deleteEdge(r)),a!==t&&a!==t.sym||(t=t.next),libtess.mesh.deleteEdge(a))}},libtess.sweep.initPriorityQ_=function(e){var t=new libtess.PriorityQ(libtess.geom.vertLeq);e.pq=t;var i,a=e.mesh.vHead;for(i=a.next;i!==a;i=i.next)i.pqHandle=t.insert(i);t.init()},libtess.sweep.donePriorityQ_=function(e){e.pq.deleteQ(),e.pq=null},libtess.sweep.removeDegenerateFaces_=function(e){for(var t,i=e.fHead.next;i!==e.fHead;i=t){t=i.next;var a=i.anEdge;libtess.assert(a.lNext!==a),a.lNext.lNext===a&&(libtess.sweep.addWinding_(a.oNext,a),libtess.mesh.deleteEdge(a))}},libtess.tessmono={},libtess.tessmono.tessellateMonoRegion_=function(e){var t=e.anEdge;for(libtess.assert(t.lNext!==t&&t.lNext.lNext!==t);libtess.geom.vertLeq(t.dst(),t.org);t=t.lPrev());for(;libtess.geom.vertLeq(t.org,t.dst());t=t.lNext);for(var i=t.lPrev();t.lNext!==i;)if(libtess.geom.vertLeq(t.dst(),i.org)){for(;i.lNext!==t&&(libtess.geom.edgeGoesLeft(i.lNext)||libtess.geom.edgeSign(i.org,i.dst(),i.lNext.dst())<=0);)i=libtess.mesh.connect(i.lNext,i).sym;i=i.lPrev()}else{for(;i.lNext!==t&&(libtess.geom.edgeGoesRight(t.lPrev())||0<=libtess.geom.edgeSign(t.dst(),t.org,t.lPrev().org));)t=libtess.mesh.connect(t,t.lPrev()).sym;t=t.lNext}for(libtess.assert(i.lNext!==t);i.lNext.lNext!==t;)i=libtess.mesh.connect(i.lNext,i).sym},libtess.tessmono.tessellateInterior=function(e){for(var t,i=e.fHead.next;i!==e.fHead;i=t)t=i.next,i.inside&&libtess.tessmono.tessellateMonoRegion_(i)},libtess.tessmono.discardExterior=function(e){for(var t,i=e.fHead.next;i!==e.fHead;i=t)t=i.next,i.inside||libtess.mesh.zapFace(i)},libtess.tessmono.setWindingNumber=function(e,t,i){for(var a,r=e.eHead.next;r!==e.eHead;r=a)a=r.next,r.rFace().inside!==r.lFace.inside?r.winding=r.lFace.inside?t:-t:i?libtess.mesh.deleteEdge(r):r.winding=0},libtess.Dict=function(e,t){this.head_=new libtess.DictNode,this.frame_=e,this.leq_=t},libtess.Dict.prototype.deleteDict_=function(){},libtess.Dict.prototype.insertBefore=function(e,t){for(;null!==(e=e.prev).key&&!this.leq_(this.frame_,e.key,t););var i=new libtess.DictNode(t,e.next,e);return e.next.prev=i,e.next=i},libtess.Dict.prototype.insert=function(e){return this.insertBefore(this.head_,e)},libtess.Dict.prototype.deleteNode=function(e){e.next.prev=e.prev,e.prev.next=e.next},libtess.Dict.prototype.search=function(e){for(var t=this.head_;null!==(t=t.next).key&&!this.leq_(this.frame_,e,t.key););return t},libtess.Dict.prototype.getMin=function(){return this.head_.next},libtess.Dict.prototype.getMax=function(){return this.head_.prev},libtess.DictNode=function(e,t,i){this.key=e||null,this.next=t||this,this.prev=i||this},libtess.DictNode.prototype.getKey=function(){return this.key},libtess.DictNode.prototype.getSuccessor=function(){return this.next},libtess.DictNode.prototype.getPredecessor=function(){return this.prev},libtess.CachedVertex=function(){this.coords=[0,0,0],this.data=null},libtess.GluTesselator=function(){this.state=libtess.GluTesselator.tessState_.T_DORMANT,this.lastEdge_=null,this.mesh=null,this.callError_=null,this.normal=[0,0,0],this.sUnit=[0,0,0],this.tUnit=[0,0,0],this.relTolerance=libtess.GLU_TESS_DEFAULT_TOLERANCE,this.windingRule=libtess.windingRule.GLU_TESS_WINDING_ODD,this.fatalError=!1,this.dict=null,this.pq=null,this.event=null,this.callCombine_=null,this.boundaryOnly=!1,this.callBegin_=null,this.callEdgeFlag_=null,this.callVertex_=null,this.callEnd_=null,this.callMesh_=null,this.callBeginData_=null,this.callEdgeFlagData_=null,this.callVertexData_=null,this.callEndData_=null,this.callErrorData_=null,this.callCombineData_=null,this.polygonData_=null,this.emptyCache=!1,this.cacheCount=0,this.cache=new Array(libtess.TESS_MAX_CACHE);for(var e=0;e<libtess.TESS_MAX_CACHE;e++)this.cache[e]=new libtess.CachedVertex},libtess.GluTesselator.tessState_={T_DORMANT:0,T_IN_POLYGON:1,T_IN_CONTOUR:2},libtess.GluTesselator.prototype.gluDeleteTess=function(){this.requireState_(libtess.GluTesselator.tessState_.T_DORMANT)},libtess.GluTesselator.prototype.gluTessProperty=function(e,t){switch(e){case libtess.gluEnum.GLU_TESS_TOLERANCE:if(t<0||1<t)break;return void(this.relTolerance=t);case libtess.gluEnum.GLU_TESS_WINDING_RULE:var i=t;switch(i){case libtess.windingRule.GLU_TESS_WINDING_ODD:case libtess.windingRule.GLU_TESS_WINDING_NONZERO:case libtess.windingRule.GLU_TESS_WINDING_POSITIVE:case libtess.windingRule.GLU_TESS_WINDING_NEGATIVE:case libtess.windingRule.GLU_TESS_WINDING_ABS_GEQ_TWO:return void(this.windingRule=i)}break;case libtess.gluEnum.GLU_TESS_BOUNDARY_ONLY:return void(this.boundaryOnly=!!t);default:return void this.callErrorOrErrorData(libtess.gluEnum.GLU_INVALID_ENUM)}this.callErrorOrErrorData(libtess.gluEnum.GLU_INVALID_VALUE)},libtess.GluTesselator.prototype.gluGetTessProperty=function(e){switch(e){case libtess.gluEnum.GLU_TESS_TOLERANCE:return libtess.assert(0<=this.relTolerance&&this.relTolerance<=1),this.relTolerance;case libtess.gluEnum.GLU_TESS_WINDING_RULE:var t=this.windingRule;return libtess.assert(t===libtess.windingRule.GLU_TESS_WINDING_ODD||t===libtess.windingRule.GLU_TESS_WINDING_NONZERO||t===libtess.windingRule.GLU_TESS_WINDING_POSITIVE||t===libtess.windingRule.GLU_TESS_WINDING_NEGATIVE||t===libtess.windingRule.GLU_TESS_WINDING_ABS_GEQ_TWO),t;case libtess.gluEnum.GLU_TESS_BOUNDARY_ONLY:return libtess.assert(!0===this.boundaryOnly||!1===this.boundaryOnly),this.boundaryOnly;default:this.callErrorOrErrorData(libtess.gluEnum.GLU_INVALID_ENUM)}return!1},libtess.GluTesselator.prototype.gluTessNormal=function(e,t,i){this.normal[0]=e,this.normal[1]=t,this.normal[2]=i},libtess.GluTesselator.prototype.gluTessCallback=function(e,t){var i=t||null;switch(e){case libtess.gluEnum.GLU_TESS_BEGIN:return void(this.callBegin_=i);case libtess.gluEnum.GLU_TESS_BEGIN_DATA:return void(this.callBeginData_=i);case libtess.gluEnum.GLU_TESS_EDGE_FLAG:return void(this.callEdgeFlag_=i);case libtess.gluEnum.GLU_TESS_EDGE_FLAG_DATA:return void(this.callEdgeFlagData_=i);case libtess.gluEnum.GLU_TESS_VERTEX:return void(this.callVertex_=i);case libtess.gluEnum.GLU_TESS_VERTEX_DATA:return void(this.callVertexData_=i);case libtess.gluEnum.GLU_TESS_END:return void(this.callEnd_=i);case libtess.gluEnum.GLU_TESS_END_DATA:return void(this.callEndData_=i);case libtess.gluEnum.GLU_TESS_ERROR:return void(this.callError_=i);case libtess.gluEnum.GLU_TESS_ERROR_DATA:return void(this.callErrorData_=i);case libtess.gluEnum.GLU_TESS_COMBINE:return void(this.callCombine_=i);case libtess.gluEnum.GLU_TESS_COMBINE_DATA:return void(this.callCombineData_=i);case libtess.gluEnum.GLU_TESS_MESH:return void(this.callMesh_=i);default:return void this.callErrorOrErrorData(libtess.gluEnum.GLU_INVALID_ENUM)}},libtess.GluTesselator.prototype.gluTessVertex=function(e,t){var i=!1,a=[0,0,0];this.requireState_(libtess.GluTesselator.tessState_.T_IN_CONTOUR),this.emptyCache&&(this.emptyCache_(),this.lastEdge_=null);for(var r=0;r<3;++r){var n=e[r];n<-libtess.GLU_TESS_MAX_COORD&&(n=-libtess.GLU_TESS_MAX_COORD,i=!0),n>libtess.GLU_TESS_MAX_COORD&&(n=libtess.GLU_TESS_MAX_COORD,i=!0),a[r]=n}if(i&&this.callErrorOrErrorData(libtess.errorType.GLU_TESS_COORD_TOO_LARGE),null===this.mesh){if(this.cacheCount<libtess.TESS_MAX_CACHE)return void this.cacheVertex_(a,t);this.emptyCache_()}this.addVertex_(a,t)},libtess.GluTesselator.prototype.gluTessBeginPolygon=function(e){this.requireState_(libtess.GluTesselator.tessState_.T_DORMANT),this.state=libtess.GluTesselator.tessState_.T_IN_POLYGON,this.cacheCount=0,this.emptyCache=!1,this.mesh=null,this.polygonData_=e},libtess.GluTesselator.prototype.gluTessBeginContour=function(){this.requireState_(libtess.GluTesselator.tessState_.T_IN_POLYGON),this.state=libtess.GluTesselator.tessState_.T_IN_CONTOUR,this.lastEdge_=null,0<this.cacheCount&&(this.emptyCache=!0)},libtess.GluTesselator.prototype.gluTessEndContour=function(){this.requireState_(libtess.GluTesselator.tessState_.T_IN_CONTOUR),this.state=libtess.GluTesselator.tessState_.T_IN_POLYGON},libtess.GluTesselator.prototype.gluTessEndPolygon=function(){if(this.requireState_(libtess.GluTesselator.tessState_.T_IN_POLYGON),this.state=libtess.GluTesselator.tessState_.T_DORMANT,null===this.mesh&&this.emptyCache_(),libtess.normal.projectPolygon(this),libtess.sweep.computeInterior(this),!this.fatalError){var e=this.mesh;if(this.boundaryOnly?libtess.tessmono.setWindingNumber(e,1,!0):libtess.tessmono.tessellateInterior(e),this.mesh.checkMesh(),this.callBegin_||this.callEnd_||this.callVertex_||this.callEdgeFlag_||this.callBeginData_||this.callEndData_||this.callVertexData_||this.callEdgeFlagData_)if(this.boundaryOnly)libtess.render.renderBoundary(this,this.mesh);else{var t=!(!this.callEdgeFlag_&&!this.callEdgeFlagData_);libtess.render.renderMesh(this,this.mesh,t)}if(this.callMesh_)return libtess.tessmono.discardExterior(this.mesh),this.callMesh_(this.mesh),this.mesh=null,void(this.polygonData_=null)}libtess.mesh.deleteMesh(this.mesh),this.polygonData_=null,this.mesh=null},libtess.GluTesselator.prototype.makeDormant_=function(){this.mesh&&libtess.mesh.deleteMesh(this.mesh),this.state=libtess.GluTesselator.tessState_.T_DORMANT,this.lastEdge_=null,this.mesh=null},libtess.GluTesselator.prototype.requireState_=function(e){this.state!==e&&this.gotoState_(e)},libtess.GluTesselator.prototype.gotoState_=function(e){for(;this.state!==e;)if(this.state<e)switch(this.state){case libtess.GluTesselator.tessState_.T_DORMANT:this.callErrorOrErrorData(libtess.errorType.GLU_TESS_MISSING_BEGIN_POLYGON),this.gluTessBeginPolygon(null);break;case libtess.GluTesselator.tessState_.T_IN_POLYGON:this.callErrorOrErrorData(libtess.errorType.GLU_TESS_MISSING_BEGIN_CONTOUR),this.gluTessBeginContour()}else switch(this.state){case libtess.GluTesselator.tessState_.T_IN_CONTOUR:this.callErrorOrErrorData(libtess.errorType.GLU_TESS_MISSING_END_CONTOUR),this.gluTessEndContour();break;case libtess.GluTesselator.tessState_.T_IN_POLYGON:this.callErrorOrErrorData(libtess.errorType.GLU_TESS_MISSING_END_POLYGON),this.makeDormant_()}},libtess.GluTesselator.prototype.addVertex_=function(e,t){var i=this.lastEdge_;null===i?(i=libtess.mesh.makeEdge(this.mesh),libtess.mesh.meshSplice(i,i.sym)):(libtess.mesh.splitEdge(i),i=i.lNext),i.org.data=t,i.org.coords[0]=e[0],i.org.coords[1]=e[1],i.org.coords[2]=e[2],i.winding=1,i.sym.winding=-1,this.lastEdge_=i},libtess.GluTesselator.prototype.cacheVertex_=function(e,t){var i=this.cache[this.cacheCount];i.data=t,i.coords[0]=e[0],i.coords[1]=e[1],i.coords[2]=e[2],++this.cacheCount},libtess.GluTesselator.prototype.emptyCache_=function(){this.mesh=new libtess.GluMesh;for(var e=0;e<this.cacheCount;e++){var t=this.cache[e];this.addVertex_(t.coords,t.data)}this.cacheCount=0,this.emptyCache=!1},libtess.GluTesselator.prototype.callBeginOrBeginData=function(e){this.callBeginData_?this.callBeginData_(e,this.polygonData_):this.callBegin_&&this.callBegin_(e)},libtess.GluTesselator.prototype.callVertexOrVertexData=function(e){this.callVertexData_?this.callVertexData_(e,this.polygonData_):this.callVertex_&&this.callVertex_(e)},libtess.GluTesselator.prototype.callEdgeFlagOrEdgeFlagData=function(e){this.callEdgeFlagData_?this.callEdgeFlagData_(e,this.polygonData_):this.callEdgeFlag_&&this.callEdgeFlag_(e)},libtess.GluTesselator.prototype.callEndOrEndData=function(){this.callEndData_?this.callEndData_(this.polygonData_):this.callEnd_&&this.callEnd_()},libtess.GluTesselator.prototype.callCombineOrCombineData=function(e,t,i){var a;return this.callCombineData_?a=this.callCombineData_(e,t,i,this.polygonData_):this.callCombine_&&(a=this.callCombine_(e,t,i)),void 0===a&&(a=null),a},libtess.GluTesselator.prototype.callErrorOrErrorData=function(e){this.callErrorData_?this.callErrorData_(e,this.polygonData_):this.callError_&&this.callError_(e)},libtess.GluFace=function(e,t){this.next=e||this,this.prev=t||this,this.anEdge=null,this.data=null,this.inside=!1},libtess.GluHalfEdge=function(e){this.next=e||this,this.sym=null,this.oNext=null,this.lNext=null,this.org=null,this.lFace=null,this.activeRegion=null,this.winding=0},libtess.GluHalfEdge.prototype.rFace=function(){return this.sym.lFace},libtess.GluHalfEdge.prototype.dst=function(){return this.sym.org},libtess.GluHalfEdge.prototype.oPrev=function(){return this.sym.lNext},libtess.GluHalfEdge.prototype.lPrev=function(){return this.oNext.sym},libtess.GluHalfEdge.prototype.dPrev=function(){return this.lNext.sym},libtess.GluHalfEdge.prototype.rPrev=function(){return this.sym.oNext},libtess.GluHalfEdge.prototype.dNext=function(){return this.rPrev().sym},libtess.GluHalfEdge.prototype.rNext=function(){return this.oPrev().sym},libtess.GluMesh=function(){this.vHead=new libtess.GluVertex,this.fHead=new libtess.GluFace,this.eHead=new libtess.GluHalfEdge,this.eHeadSym=new libtess.GluHalfEdge,this.eHead.sym=this.eHeadSym,this.eHeadSym.sym=this.eHead},libtess.GluMesh.prototype.checkMesh=function(){if(libtess.DEBUG){var e,t,i,a=this.fHead,r=this.vHead,n=this.eHead,s=a;for(s=a;(t=s.next)!==a;s=t)for(libtess.assert(t.prev===s),e=t.anEdge;libtess.assert(e.sym!==e),libtess.assert(e.sym.sym===e),libtess.assert(e.lNext.oNext.sym===e),libtess.assert(e.oNext.sym.lNext===e),libtess.assert(e.lFace===t),(e=e.lNext)!==t.anEdge;);libtess.assert(t.prev===s&&null===t.anEdge&&null===t.data);var o=r;for(o=r;(i=o.next)!==r;o=i)for(libtess.assert(i.prev===o),e=i.anEdge;libtess.assert(e.sym!==e),libtess.assert(e.sym.sym===e),libtess.assert(e.lNext.oNext.sym===e),libtess.assert(e.oNext.sym.lNext===e),libtess.assert(e.org===i),(e=e.oNext)!==i.anEdge;);libtess.assert(i.prev===o&&null===i.anEdge&&null===i.data);var l=n;for(l=n;(e=l.next)!==n;l=e)libtess.assert(e.sym.next===l.sym),libtess.assert(e.sym!==e),libtess.assert(e.sym.sym===e),libtess.assert(null!==e.org),libtess.assert(null!==e.dst()),libtess.assert(e.lNext.oNext.sym===e),libtess.assert(e.oNext.sym.lNext===e);libtess.assert(e.sym.next===l.sym&&e.sym===this.eHeadSym&&e.sym.sym===e&&null===e.org&&null===e.dst()&&null===e.lFace&&null===e.rFace())}},libtess.GluVertex=function(e,t){this.next=e||this,this.prev=t||this,this.anEdge=null,this.data=null,this.coords=[0,0,0],this.s=0,this.t=0,this.pqHandle=null},libtess.PQHandleElem=function(){this.key=null,this.node=0},libtess.PQHandleElem.realloc=function(e,t){var i=new Array(t),a=0;if(null!==e)for(;a<e.length;a++)i[a]=e[a];for(;a<t;a++)i[a]=new libtess.PQHandleElem;return i},libtess.PQNode=function(){this.handle=0},libtess.PQNode.realloc=function(e,t){var i=new Array(t),a=0;if(null!==e)for(;a<e.length;a++)i[a]=e[a];for(;a<t;a++)i[a]=new libtess.PQNode;return i},libtess.PriorityQ=function(e){this.keys_=libtess.PriorityQ.prototype.PQKeyRealloc_(null,libtess.PriorityQ.INIT_SIZE_),this.order_=null,this.size_=0,this.max_=libtess.PriorityQ.INIT_SIZE_,this.initialized_=!1,this.leq_=e,this.heap_=new libtess.PriorityQHeap(this.leq_)},libtess.PriorityQ.INIT_SIZE_=32,libtess.PriorityQ.prototype.deleteQ=function(){this.heap_.deleteHeap(),this.heap_=null,this.order_=null,this.keys_=null},libtess.PriorityQ.prototype.init=function(){this.order_=[];for(var e=0;e<this.size_;e++)this.order_[e]=e;var i,a,t=(i=this.keys_,a=this.leq_,function(e,t){return a(i[e],i[t])?1:-1});if(this.order_.sort(t),this.max_=this.size_,this.initialized_=!0,this.heap_.init(),libtess.DEBUG){var r=0+this.size_-1;for(e=0;e<r;++e)libtess.assert(this.leq_(this.keys_[this.order_[e+1]],this.keys_[this.order_[e]]))}},libtess.PriorityQ.prototype.insert=function(e){if(this.initialized_)return this.heap_.insert(e);var t=this.size_;return++this.size_>=this.max_&&(this.max_*=2,this.keys_=libtess.PriorityQ.prototype.PQKeyRealloc_(this.keys_,this.max_)),this.keys_[t]=e,-(t+1)},libtess.PriorityQ.prototype.PQKeyRealloc_=function(e,t){var i=new Array(t),a=0;if(null!==e)for(;a<e.length;a++)i[a]=e[a];for(;a<t;a++)i[a]=null;return i},libtess.PriorityQ.prototype.keyLessThan_=function(e,t){var i=this.keys_[e],a=this.keys_[t];return!this.leq_(a,i)},libtess.PriorityQ.prototype.keyGreaterThan_=function(e,t){var i=this.keys_[e],a=this.keys_[t];return!this.leq_(i,a)},libtess.PriorityQ.prototype.extractMin=function(){if(0===this.size_)return this.heap_.extractMin();var e=this.keys_[this.order_[this.size_-1]];if(!this.heap_.isEmpty()){var t=this.heap_.minimum();if(this.leq_(t,e))return this.heap_.extractMin()}for(;--this.size_,0<this.size_&&null===this.keys_[this.order_[this.size_-1]];);return e},libtess.PriorityQ.prototype.minimum=function(){if(0===this.size_)return this.heap_.minimum();var e=this.keys_[this.order_[this.size_-1]];if(!this.heap_.isEmpty()){var t=this.heap_.minimum();if(this.leq_(t,e))return t}return e},libtess.PriorityQ.prototype.isEmpty_=function(){return 0===this.size_&&this.heap_.isEmpty()},libtess.PriorityQ.prototype.remove=function(e){if(0<=e)this.heap_.remove(e);else for(e=-(e+1),libtess.assert(e<this.max_&&null!==this.keys_[e]),this.keys_[e]=null;0<this.size_&&null===this.keys_[this.order_[this.size_-1]];)--this.size_},libtess.PriorityQHeap=function(e){this.nodes_=libtess.PQNode.realloc(null,libtess.PriorityQHeap.INIT_SIZE_+1),this.handles_=libtess.PQHandleElem.realloc(null,libtess.PriorityQHeap.INIT_SIZE_+1),this.size_=0,this.max_=libtess.PriorityQHeap.INIT_SIZE_,this.freeList_=0,this.initialized_=!1,this.leq_=e,this.nodes_[1].handle=1},libtess.PriorityQHeap.INIT_SIZE_=32,libtess.PriorityQHeap.prototype.deleteHeap=function(){this.handles_=null,this.nodes_=null},libtess.PriorityQHeap.prototype.init=function(){for(var e=this.size_;1<=e;--e)this.floatDown_(e);this.initialized_=!0},libtess.PriorityQHeap.prototype.insert=function(e){var t,i=++this.size_;return 2*i>this.max_&&(this.max_*=2,this.nodes_=libtess.PQNode.realloc(this.nodes_,this.max_+1),this.handles_=libtess.PQHandleElem.realloc(this.handles_,this.max_+1)),0===this.freeList_?t=i:(t=this.freeList_,this.freeList_=this.handles_[t].node),this.nodes_[i].handle=t,this.handles_[t].node=i,this.handles_[t].key=e,this.initialized_&&this.floatUp_(i),t},libtess.PriorityQHeap.prototype.isEmpty=function(){return 0===this.size_},libtess.PriorityQHeap.prototype.minimum=function(){return this.handles_[this.nodes_[1].handle].key},libtess.PriorityQHeap.prototype.extractMin=function(){var e=this.nodes_,t=this.handles_,i=e[1].handle,a=t[i].key;return 0<this.size_&&(e[1].handle=e[this.size_].handle,t[e[1].handle].node=1,t[i].key=null,t[i].node=this.freeList_,this.freeList_=i,0<--this.size_&&this.floatDown_(1)),a},libtess.PriorityQHeap.prototype.remove=function(e){var t=this.nodes_,i=this.handles_;libtess.assert(1<=e&&e<=this.max_&&null!==i[e].key);var a=i[e].node;t[a].handle=t[this.size_].handle,(i[t[a].handle].node=a)<=--this.size_&&(a<=1||this.leq_(i[t[a>>1].handle].key,i[t[a].handle].key)?this.floatDown_(a):this.floatUp_(a)),i[e].key=null,i[e].node=this.freeList_,this.freeList_=e},libtess.PriorityQHeap.prototype.floatDown_=function(e){for(var t=this.nodes_,i=this.handles_,a=t[e].handle;;){var r=e<<1;r<this.size_&&this.leq_(i[t[r+1].handle].key,i[t[r].handle].key)&&++r,libtess.assert(r<=this.max_);var n=t[r].handle;if(r>this.size_||this.leq_(i[a].key,i[n].key)){i[t[e].handle=a].node=e;break}i[t[e].handle=n].node=e,e=r}},libtess.PriorityQHeap.prototype.floatUp_=function(e){for(var t=this.nodes_,i=this.handles_,a=t[e].handle;;){var r=e>>1,n=t[r].handle;if(0===r||this.leq_(i[n].key,i[a].key)){i[t[e].handle=a].node=e;break}i[t[e].handle=n].node=e,e=r}},libtess.ActiveRegion=function(){this.eUp=null,this.nodeUp=null,this.windingNumber=0,this.inside=!1,this.sentinel=!1,this.dirty=!1,this.fixUpperEdge=!1},libtess.ActiveRegion.prototype.regionBelow=function(){return this.nodeUp.getPredecessor().getKey()},libtess.ActiveRegion.prototype.regionAbove=function(){return this.nodeUp.getSuccessor().getKey()},"undefined"!=typeof module&&(module.exports=libtess),function(){function K(e){if(pdGL&&pdGL.Scene3D&&pdGL.Scene3D.getActiveEnvironment()){var t=pdGL.Scene3D.getActiveEnvironment().surfaceMaterial;if(t)return t}else if(pdGL)return pdGL.Material.VariableColorUniformPointSize(e.materialOptions);return new pd3D.Material}pd3D.parseOBJ=function(e,i){if(!e||!e.result||!e.result.length)throw new TypeError("ERROR: File is empty or invalid.");(i=i||{}).meshOptions=i.meshOptions||{normals:!0,colors:!0,defaultColor:[.55,.55,.55,1],twoSided:!0},i.progressIncrement=pd.toNumber(i.progressIncrement,.1),i.callbackComplete=i.callbackComplete||null,i.callbackProgress=i.callbackProgress||null,i.materialOptions=i.materialOptions||{},i.materials=i.materials||{},i.groups=i.groups||{};var t,a,r,n,s,o,l,d,h,c,p=null,u=[],g=[],m=[],f=[],v=0,_=0,x=0,b=0,y=[],S=[.65,.65,.65,1],M=[0,0,0],w=[0,0,1],L=[0,0],D=0,E=null,T=0,A=new pd3D.Mesh(i.meshOptions),P=i.node||new pd3D.Node("OBJ_File"),C=i.defaultMaterial||null,O=!!A.normals,N=!!A.coords,G=!!A.colors,I=P,R=i.flipY?1:-1;function k(e){var t=parseInt(e,10);return isNaN(t)?NaN:0<=t?t-1:t+u.length}function V(e){var t=parseInt(e,10);return isNaN(t)?NaN:0<=t?t-1:t+m.length}function B(e){var t=A.color();A=new pd3D.Mesh(i.meshOptions),I.addMesh(A,C),O=!!A.normals,N=!!A.coords,G=!!A.colors,A.color(t),A.name=e}C||(C=K(i)),P.addMesh(A,C);var U,F,H=e.result.split("\n"),z=H.length,W=0,j=0;i.debug&&console.time("parseOBJ");for(var X=0;X<z;X++){var Y,q=H[X].trim();if(1<q.length)switch(q.charAt(0)){case"#":break;case"v":case"V":switch(q.charAt(1)){case" ":case"\t":3<(Y=q.match(/\S+/g)).length&&(u.push([parseFloat(Y[1]),parseFloat(Y[3])*R,parseFloat(Y[2])]),G&&6<Y.length&&f.push([parseFloat(Y[4]),parseFloat(Y[5]),parseFloat(Y[6]),pd.toNumber(Y[7],1)]));break;case"n":3<(Y=q.match(/\S+/g)).length&&g.push([parseFloat(Y[1]),parseFloat(Y[3])*R,parseFloat(Y[2])]);break;case"t":2<(Y=q.match(/\S+/g)).length&&m.push([parseFloat(Y[1]),parseFloat(Y[2])])}break;case"f":case"F":if(b=0,y.length=0,65500<A.vertices.length&&B("ext"+pd.toStringWithLeadingZeros(++T,4)),2<(D=(l=q.match(/\S+/g)).length)){for(c=1;c<D;c++)0<(o=l[c].split("/")).length&&(t=k(o[0]),isNaN(t)||(r=V(o[1]),U=o[2],void 0,F=parseInt(U,10),a=isNaN(F)?NaN:0<=F?F-1:F+g.length,isNaN(a)||b++,y.push({vtx:t,tex:r,nrm:a})));if(2<y.length){if(x=f.length,E=null,b<(_=y.length))for(c=2;c<_;c++)if(pd3D.VectorArray.calcNormalFromTriangle(M,u[y[c-0].vtx],u[y[c-1].vtx],u[y[c-2].vtx])){E=M.slice(),A.defaultNormal=E;break}if(4<_){for(n=[],c=0;c<_;c++)n.push(u[y[c].vtx]);var J=new this.Polygon;J.setBoundary(n),J.tesselate3D(),J.copyTrianglesToMesh(A)}else{for(s=A.vertices.length,c=0;c<_;c++)v=y[c].vtx,A.vertices.push(u[v]),G&&(v<x?A.colors.push(f[v]):A.colors.push(A.defaultColor)),N&&(isNaN(y[c].tex)?A.coords.push(L):A.coords.push(m[y[c].tex])),O&&(isNaN(y[c].nrm)?E?A.normals.push(E):A.normals.push(A.defaultNormal):A.normals.push(g[y[c].nrm]));4==_?(A.triangles.push([s,s+1,s+2]),A.triangles.push([s,s+2,s+3])):3==_&&A.triangles.push([s,s+1,s+2])}}}break;case"l":case"L":if(_=0,65500<A.vertices.length&&B("ext"+pd.toStringWithLeadingZeros(++T,4)),A.lines||A.addIndexBuffer("lines"),1<(D=(l=q.match(/\S+/g)).length))for(s=A.vertices.length,c=1;c<D;c++)0<(o=l[c].split("/")).length&&(t=k(o[0]),isNaN(t)||(A.vertices.push(u[t]),G&&(t<x?A.colors.push(f[t]):A.colors.push(A.defaultLineColor)),N&&(r=V(o[1]),isNaN(r)?A.coords.push(L):A.coords.push(m[r])),O&&A.normals.push(w),1<c&&A.lines.push([s+(c-2),s+(c-1)]),_++));break;case"p":case"P":if(65500<A.vertices.length&&B("ext"+pd.toStringWithLeadingZeros(++T,4)),A.points||A.addIndexBuffer("points"),1<(D=(l=q.match(/\S+/g)).length))for(s=A.vertices.length,c=1;c<D;c++)0<(o=l[c].split("/")).length&&(t=k(o[0]),isNaN(t)||(A.vertices.push(u[t]),G&&(t<x?A.colors.push(f[t]):A.colors.push(A.defaultColor)),N&&A.coords.push(L),O&&A.normals.push(w),A.points.push(s+c)));break;case"o":case"O":B(1<(l=q.match(/\S+/g)).length&&0<l[1].length?l[1]:"obj"+pd.toStringWithLeadingZeros(++T,4));break;case"g":case"G":h=1<(l=q.match(/\S+/g)).length&&0<l[1].length?l[1]:"grp"+pd.toStringWithLeadingZeros(++T,4),i.groups[h]?I=i.groups[h]:(I=new pd3D.Node(h),P.addChild(I),B(h),i.groups[h]=I);break;case"m":case"M":if(pd.startsWith(q,"mtllib")){var Q=q.substring(6).trim().split("/").pop();Q&&0<Q.length&&(i.materials[Q]||(i.materials[Q]={}),p=i.materials[Q])}break;case"u":case"U":if(1<(l=q.match(/\S+/g)).length&&"usemtl"==l[0]&&0<l[1].length)if(p){var Z=l[1];p[Z]||(p[Z]={diffuseColor:S,specularColor:[.85,.85,.85,1],ambientColor:[.45,.45,.45,1],shininess:25,opacity:1}),i.meshOptions.colors||B(h),d=p[Z].diffuseColor,A.color([d[0],d[1],d[2],p[Z].opacity])}else A.color(S)}W<=(j=X/z)&&(i.callbackProgress&&i.callbackProgress(j),W+=i.progressIncrement)}return i.debug&&console.timeEnd("parseOBJ"),i.callbackProgress&&i.callbackProgress(1),i.callbackComplete&&i.callbackComplete(),P.compile(),p&&(P.materials=p),P},pd3D.parseMTL=function(e,t){if(e&&e.result&&e.result.length){t=t||{};for(var i,a=e.result.split("\n"),r=a.length,n=null,s=0;s<r;s++){var o=a[s].trim();if(1<o.length)switch(o.charAt(0)){case"#":break;case"n":case"N":"e"==o.charAt(1)?1<(i=o.match(/\S+/g)).length&&"newmtl"==i[0]&&0<i[1].length&&(n=t[i[1]]={diffuseColor:[Math.random(),Math.random(),Math.random(),1],specularColor:[.85,.85,.85,1],ambientColor:[.45,.45,.45,1],shininess:25,opacity:1}):"s"==o.charAt(1)&&n&&1<(i=o.match(/\S+/g)).length&&(n.shininess=pd.constrainTo(parseFloat(i[1]),0,1e9));break;case"k":case"K":if(n&&3<(i=o.match(/\S+/g)).length){var l=1,d=1,h=1,c=1;switch(o.charAt(1)){case"a":l=parseFloat(i[1]),d=parseFloat(i[2]),h=parseFloat(i[3]),c=4<i.length?parseFloat(i[4]):1,n.ambientColor=[l,d,h,c];break;case"d":l=parseFloat(i[1]),d=parseFloat(i[2]),h=parseFloat(i[3]),c=4<i.length?parseFloat(i[4]):1,n.diffuseColor=[l,d,h,c];break;case"s":l=parseFloat(i[1]),d=parseFloat(i[2]),h=parseFloat(i[3]),c=4<i.length?parseFloat(i[4]):1,n.specularColor=[l,d,h,c]}}break;case"t":case"T":n&&"r"==o.charAt(1)&&1<(i=o.match(/\S+/g)).length&&(n.opacity=1-pd.constrainTo(parseFloat(i[1]),0,1));break;case"d":case"D":n&&1<(i=o.match(/\S+/g)).length&&(n.opacity=pd.constrainTo(parseFloat(i[1]),0,1))}}return t}},pd3D.formatAsOBJ=function(e,t){if(t=t||{},!(e&&e instanceof pd3D.Mesh))throw new TypeError("The given mesh must be a valid instance of 'pd3D.Mesh'.");var i,a,r=pd.toBoolean(t.triangles,!1)&&e.triangles&&0<e.triangles.length,n=pd.toBoolean(t.outlines,!1)&&e.hasLines&&0<e.lines.length,s=pd.toBoolean(t.normals,!1)&&e.hasVertexNormals,o=pd.toBoolean(t.coords,!1)&&e.hasVertexCoords,l=pd.toBoolean(t.colors,!1)&&e.hasVertexColors,d=pd.toBoolean(t.alpha,l),h=o||s,c="# PerformativeDesign.com - OBJ Export.\n";if(l&&(c+="# Vertex format:  v x y z r g b",d&&(c+=" a"),c+="\n"),c+="o "+(t.name||"pd3D.Mesh")+"\n",e.vertices)for(var p=0,u=e.vertices.length;p<u;++p)i=e.vertices[p],c+="v "+pd.toStringWithPrecisionRange(i[0],1,9)+" "+pd.toStringWithPrecisionRange(i[2],1,9)+" "+pd.toStringWithPrecisionRange(i[1],1,9),l&&(c+=" "+(i=e.colors[p])[0].toFixed(5)+" "+i[1].toFixed(5)+" "+i[2].toFixed(5),d&&(c+=" "+i[3].toFixed(5))),c+="\n";if(s)for(p=0,u=e.normals.length;p<u;++p)c+="vn "+(i=e.normals[p])[0].toFixed(5)+" "+i[2].toFixed(5)+" "+i[1].toFixed(5)+"\n";if(o)for(p=0,u=e.coords.length;p<u;++p)c+="vt "+(i=e.coords[p])[0].toFixed(5)+" "+i[1].toFixed(5)+"\n";if(r)for(p=0,u=e.triangles.length;p<u;++p)if(i=e.triangles[p],h){c+="f";for(var g=0;g<3;++g)c+=" "+(a=(i[g]+1).toFixed(0))+"/"+(o?a:"")+"/"+(s?a:"");c+="\n"}else c+="f "+(i[0]+1).toFixed(0)+" "+(i[1]+1).toFixed(0)+" "+(i[2]+1).toFixed(0)+"\n";if(n)for(p=0,u=e.lines.length;p<u;++p)c+="l "+((i=e.lines[p])[0]+1).toFixed(0)+" "+(i[1]+1).toFixed(0)+"\n";return c},pd3D.parseSTL=function(e,t){if(!e||!e.result||!e.result.length)throw new TypeError("ERROR: File is empty or invalid.");(t=t||{}).meshOptions=t.meshOptions||{normals:!0,defaultColor:[.55,.55,.55,1],twoSided:!0},t.progressIncrement=pd.toNumber(t.progressIncrement,.1),t.callbackComplete=t.callbackComplete||null,t.callbackProgress=t.callbackProgress||null,t.materialOptions=t.materialOptions||{};var i,a,r,n=0,s=e.result.split("\n"),o=s.length,l=0,d=0,h=!1,c=new pd3D.Mesh(t.meshOptions),p=t.node||new pd3D.Node("STL_File"),u=t.defaultMaterial||null,g=[0,0,1],m=[0,0,1],f=0,v=[];u||(u=K(t)),p.addMesh(c,u),t.debug&&console.time("parseSTL");for(var _=0;_<o;_++){var x=s[_].trim();if(1<x.length)switch(x.charAt(0)){case"#":break;case"e":pd.startsWith(x,"endloop")&&(h&&2<f&&(65500<c.vertices.length&&(a="ext"+pd.toStringWithLeadingZeros(++n,4),void 0,r=c.color(),c=new pd3D.Mesh(t.meshOptions),p.addMesh(c,u),c.color(r),c.name=a),pd3D.VectorArray.calcNormalFromTriangle(m,v[0],v[1],v[2])?c.normal(m[0],m[1],m[2]):c.normal(g),c.addTriangle(c.addVertex(v[0]),c.addVertex(v[1]),c.addVertex(v[2]))),f=0,h=!1);break;case"v":case"V":h&&pd.startsWith(x,"vertex")&&3<(i=x.match(/\S+/g)).length&&f<3&&(v[f++]=[pd.toNumber(i[1],0),pd.toNumber(i[2],0),pd.toNumber(i[3],0)]);break;case"o":case"O":pd.startsWith(x,"outer")&&(h=!(f=0));break;case"f":case"F":pd.startsWith(x,"facet")&&(3<(i=x.match(/\S+/g)).length&&"normal"==i[1]?(!0,m=[pd.toNumber(i[1],0),pd.toNumber(i[2],0),pd.toNumber(i[3],0)]):!1)}l<=(d=_/o)&&(t.callbackProgress&&t.callbackProgress(d),l+=t.progressIncrement)}return t.debug&&console.timeEnd("parseSTL"),t.callbackProgress&&t.callbackProgress(1),t.callbackComplete&&t.callbackComplete(),p.compile(),p},pd3D.formatAsSTL=function(e,t){if(t=t||{},!(e&&e instanceof pd3D.Mesh))throw new TypeError("The given mesh must be a 'pd3D.Mesh' or variant");var i,a,r,n,s,o,l,d=pd.toBoolean(t.normals,!0),h="solid "+(t.name||"pd3D.Mesh")+"\n",c=[0,0,0],p=[0,0,0],u=e.getAABB();if(u.min.x<0&&(p[0]=-u.min.x),u.min.y<0&&(p[1]=-u.min.y),u.min.z<0&&(p[2]=-u.min.z),e.triangles)for(var g=0,m=e.triangles.length;g<m;++g){a=e.vertices[e.triangles[g][0]],r=e.vertices[e.triangles[g][1]],n=e.vertices[e.triangles[g][2]],d&&pd3D.VectorArray.calcNormalFromTriangle(c,n,r,a)?(s=c[0],o=c[1],l=c[2]):s=o=l=0,h+="\tfacet normal "+s.toExponential()+" "+o.toExponential()+" "+l.toExponential()+"\n",h+="\t\touter loop\n";for(var f=2;0<=f;--f)s=(i=e.vertices[e.triangles[g][f]])[0]+p[0],o=i[1]+p[1],l=i[2]+p[2],h+="\t\t\tvertex "+s.toExponential()+" "+o.toExponential()+" "+l.toExponential()+"\n";h+="\t\tendloop\n",h+="\tendfacet\n"}return h+="endsolid\n"},pd3D.parsePLY=function(e,t){if(!e||!e.result||!e.result.length)throw new TypeError("ERROR: File is empty or invalid.");(t=t||{}).meshOptions=t.meshOptions||{normals:!0,colors:!0,defaultColor:[.55,.55,.55,1],twoSided:!0},t.progressIncrement=pd.toNumber(t.progressIncrement,.1),t.callbackComplete=t.callbackComplete||null,t.callbackProgress=t.callbackProgress||null,t.materialOptions=t.materialOptions||{};var i,a,r,n,s,o=e.result.split("\n"),l=o.length,d=0,h=0,c=new pd3D.Mesh(t.meshOptions),p=t.node||new pd3D.Node("PLY_File"),u=t.defaultMaterial||null,g=0,m=0,f=0,v=0,_=0,x=0,b=-1,y=-1,S=-1,M=-1,w=-1,L=-1,D=-1,E=-1,T=-1,A=-1,P=1,C=-1,O=-1;u||(u=K(t)),t.debug&&console.time("parsePLY");for(var N=0;N<l;N++){if(1<(I=o[N].trim()).length)switch(I.charAt(0)){case"c":case"#":break;case"e":if(pd.startsWith(I,"element"))2<(i=I.match(/\S+/g)).length&&(pd.startsWith(i[1],"vert")?(v=pd.toInteger(i[2],0),f=1,g=0):pd.startsWith(i[1],"face")||pd.startsWith(i[1],"poly")||pd.startsWith(i[1],"tri")?(_=pd.toInteger(i[2],0),f=2,g=0):(pd.startsWith(i[1],"edg")||pd.startsWith(i[1],"lin"))&&(x=pd.toInteger(i[2],0),f=3,g=0));else if(pd.startsWith(I,"end_header")){m=N;break}break;case"f":if(pd.startsWith(I,"format")&&2<(i=I.match(/\S+/g)).length&&!pd.startsWith(i[1],"asci"))throw new Error("Sorry, binary PLY files are not currently supported.");break;case"p":if(pd.startsWith(I,"property")){if(2<(i=I.match(/\S+/g)).length)switch(f){case 1:switch(i[2].charAt(0)){case"x":case"X":b=g;break;case"y":case"Y":y=g;break;case"z":case"Z":S=g;break;case"n":case"N":"x"==(a=i[2].charAt(1))||"X"==a?M=g:"y"==a||"Y"==a?w=g:"z"!=a&&"Z"!=a||(L=g);break;case"r":case"R":D=g,"u"!=(a=i[1].charAt(0))&&"U"!=a&&"c"!=a&&"C"!=a||(P=1/255);break;case"g":case"G":E=g;break;case"b":case"B":T=g;break;case"a":case"A":A=g;break;case"u":case"U":case"s":case"S":C=g;break;case"v":case"V":case"t":case"T":O=g}}g++}}}if(r=0<=M&&0<=w&&0<=L,n=0<=D&&0<=E&&0<=T,s=0<=C&&0<=O,m<1||!(0<=b&&0<=y&&0<=S))throw new Error("ERROR: File does not match PLY format.");p.addMesh(c,u);for(var G=0;G<v;++G){0<(i=(I=o[++m].trim()).match(/\S+/g)).length&&(r&&c.normal([pd.toNumber(i[M],0),pd.toNumber(i[w],0),pd.toNumber(i[L],0)]),n&&c.color([pd.toNumber(i[D],0)*P,pd.toNumber(i[E],0)*P,pd.toNumber(i[T],0)*P,pd.toNumber(i[A],1/P)]),s&&c.texCoord([pd.toNumber(i[C],0),pd.toNumber(i[O],0)]),c.vertex([pd.toNumber(i[b],0),pd.toNumber(i[y],0),pd.toNumber(i[S],0)])),d<=(h=m/l)&&(t.callbackProgress&&t.callbackProgress(h),d+=t.progressIncrement)}0<_&&!c.triangles&&c.addIndexBuffer("triangles");for(G=0;G<_;++G){if(1<(I=o[++m].trim()).length&&(i=I.match(/\S+/g),v=pd.toInteger(i[0],0),i.length>v))switch(v){default:break;case 3:c.addTriangle(pd.toInteger(i[1],0),pd.toInteger(i[2],0),pd.toInteger(i[3],0));break;case 4:c.addQuad(pd.toInteger(i[1],0),pd.toInteger(i[2],0),pd.toInteger(i[3],0),pd.toInteger(i[4],0))}d<=(h=m/l)&&(t.callbackProgress&&t.callbackProgress(h),d+=t.progressIncrement)}0<x&&!c.lines&&c.addIndexBuffer("lines");for(G=0;G<x;++G){var I;1<(I=o[++m].trim()).length&&1<(i=I.match(/\S+/g)).length&&c.addLine(pd.toInteger(i[0],0),pd.toInteger(i[1],0)),d<=(h=m/l)&&(t.callbackProgress&&t.callbackProgress(h),d+=t.progressIncrement)}return t.debug&&console.timeEnd("parsePLY"),t.callbackProgress&&t.callbackProgress(1),t.callbackComplete&&t.callbackComplete(),p.compile(),p},pd3D.formatAsPLY=function(e,t){if(t=t||{},!(e&&e instanceof pd3D.Mesh))throw new TypeError("The given mesh must be a 'pd3D.Mesh' or variant");pd.constrainTo(pd.toInteger(t.decimals,1),0,12);var i,a=pd.toBoolean(t.triangles,e.triangles&&0<e.triangles.length),r=pd.toBoolean(t.outlines,e.hasLines&&0<e.lines.length),n=pd.toBoolean(t.normals,e.hasVertexNormals),s=pd.toBoolean(t.coords,e.hasVertexCoords),o=pd.toBoolean(t.colors,e.hasVertexColors),l=pd.toBoolean(t.alpha,o),d="ply\nformat ascii 1.0\ncomment PerformativeDesign.com - PLY Export.\nelement vertex "+e.vertices.length+"\nproperty float x\nproperty float y\nproperty float z\n";if(n&&(d+="property float nx\nproperty float ny\nproperty float nz\n"),o&&(d+="property float r\nproperty float g\nproperty float b\nproperty float a\n"),s&&(d+="property float u\nproperty float v\n"),a&&(d+="element face "+e.triangles.length+"\nproperty list uchar uint vertex_indices\n"),r&&(d+="element edge "+e.lines.length+"\nproperty int vertex1\nproperty int vertex2\n"),d+="end_header\n",e.vertices)for(var h=0,c=e.vertices.length;h<c;++h)i=e.vertices[h],d+=pd.toStringWithPrecisionRange(i[0],1,9)+" "+pd.toStringWithPrecisionRange(i[1],1,9)+" "+pd.toStringWithPrecisionRange(i[2],1,9),n&&(d+=" "+(i=e.normals[h])[0].toFixed(5)+" "+i[1].toFixed(5)+" "+i[2].toFixed(5)),o&&(d+=" "+(i=e.colors[h])[0].toFixed(5)+" "+i[1].toFixed(5)+" "+i[2].toFixed(5),l&&(d+=" "+i[3].toFixed(5))),s&&(d+=" "+(i=e.coords[h])[0].toFixed(5)+" "+i[1].toFixed(5)),d+="\n";if(a)for(h=0,c=e.triangles.length;h<c;++h)d+="3 "+(i=e.triangles[h])[2].toFixed(0)+" "+i[1].toFixed(0)+" "+i[0].toFixed(0)+"\n";if(r)for(h=0,c=e.lines.length;h<c;++h)d+=+(i=e.lines[h])[0].toFixed(0)+" "+i[1].toFixed(0)+"\n";return d},pd3D.parseMOD=function(e,t){if(!e||!e.result||!e.result.length)throw new TypeError("ERROR: File is empty or invalid.");(t=t||{}).meshOptions=t.meshOptions||{lines:!0,normals:!0,defaultColor:[.55,.55,.55,1],twoSided:!0},t.progressIncrement=pd.toNumber(t.progressIncrement,.1),t.callbackComplete=t.callbackComplete||null,t.callbackProgress=t.callbackProgress||null,t.materialOptions=t.materialOptions||{};var i,a,r,n,s,o=e.result.split("\n"),l=o.length,d=0,h=0,c=0,p=t.node||new pd3D.Node("MOD_File"),u=t.defaultMaterial||null,g=[0,0,1],m={},f=0,v={name:"",flags:0,color:null,node:null,mesh:null},_={zone:"",node:null,vertices:[],normal:[],flags:0};u||(u=K(t)),t.debug&&console.time("parseMOD");for(var x=0;x<l;x++){var b=o[x].trim();if(0<b.length&&"/"!=(a=b.charAt(0)))if(1==c){if("}"==a)16&v.flags&&!t.includeAllZones||(v.node=new pd3D.Node(v.name),v.mesh=new pd3D.Mesh(t.meshOptions),v.node.addMesh(v.mesh,u),v.mesh.color(v.color),p.addChild(v.node),(16&v.flags||128&v.flags)&&(v.node.visible=!1),v.mesh.name=v.name,m[v.name]={name:v.name,flags:v.flags,color:v.color,node:v.node,mesh:v.mesh},f++),c=0;else if(1<(i=b.match(/\S+/g)).length)switch(i[0]){case"name:":i.shift(),v.name=i.join(" ").trim()||"Zone_"+pd.toStringWithLeadingZeros(f,3);break;case"flags:":v.flags=pd.toInteger(i[1]);break;case"colors:":s=pd.toInteger(i[1]),v.color=[(255&s)/255,((65280&s)>>8)/255,((16711680&s)>>16)/255,1]}}else if(2==c){if("}"==a){if(_.node=m[_.zone],_.node&&_.node.mesh)if(16384&_.flags&&_.vertices.reverse(),2<_.vertices.length&&4&_.flags&&8&_.flags)new pd3D.Polygon({contours:[_.vertices]}).copyToMesh(_.node.mesh,!1);else if(1&_.flags){(r=_.node.mesh).begin(gl.POINTS),r.normal(g);for(var y=0,S=_.vertices.length;y<S;++y)r.vertex(_.vertices[y]);r.end()}else if(2&_.flags);else{r=_.node.mesh,n=8&_.flags?gl.LINE_LOOP:gl.LINE_STRIP,r.begin(n),r.normal(g);for(y=0,S=_.vertices.length;y<S;++y)r.vertex(_.vertices[y]);r.end()}c=0}else if(1<(i=b.match(/\S+/g)).length)switch(i[0]){case"zone:":i.shift(),_.zone=i.join(" ").trim();break;case"flags:":_.flags=pd.toInteger(i[1]);break;case"vertex:":3<i.length&&_.vertices.push([parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3])]);break;case"normal:":3<i.length&&(_.normal[0]=parseFloat(i[1]),_.normal[1]=parseFloat(i[2]),_.normal[2]=parseFloat(i[3]))}}else"Z"==a&&pd.startsWith(b,"ZONE")?(v.name="Zone_"+pd.toStringWithLeadingZeros(f,3),c=1):"E"==a&&pd.startsWith(b,"ENTITY")&&(_.normal[0]=g[0],_.normal[1]=g[1],_.normal[2]=g[2],_.vertices.length=0,c=2);d<=(h=x/l)&&(t.callbackProgress&&t.callbackProgress(h),d+=t.progressIncrement)}return t.debug&&console.timeEnd("parseMOD"),t.callbackProgress&&t.callbackProgress(1),t.callbackComplete&&t.callbackComplete(),p.compile(),p}}();var pdSVG,pdGL=pdGL||{};!function(){var h,c,p=305397760,l=Math.PI/180,d=180/Math.PI;function s(e){var t=Object.prototype.toString.call(e);return"[object Array]"==t||"[object Float32Array]"==t}pdGL.version="0.1.2",pdGL.keys={};var u=!(pdGL.keyCount=0),g=null;function m(e,t,i){e.addEventListener(t,i)}function f(e){pdGL.keys.SHIFT=e.shiftKey,pdGL.keys.CONTROL=e.ctrlKey,pdGL.keys.META=e.metaKey,pdGL.keys.ALT=e.altKey}pdGL.create=function(e){var r,t,d,o,i,a,n,s,l=(e=e||{}).canvas;l||((l=document.createElement("canvas")).height=e.height||600,l.width=e.width||800),e.antialias=pd.toBoolean(e.antialias,!1),e.alpha=pd.toBoolean(e.alpha,!1);try{h=l.getContext("webgl",e)}catch(e){}try{h=h||l.getContext("experimental-webgl",e)}catch(e){}if(!h)throw new Error("WebGL is either not supported or is disabled.");return c=[h.TRIANGLES,h.LINES,h.POINTS],d=new pd3D.Matrix,o=new pd3D.Matrix,i=new pd3D.Matrix,a=[],s=!(n=[]),h.MODELVIEW=1|p,h.PROJECTION=2|p,h.modelviewMatrix=new pd3D.Matrix,h.projectionMatrix=new pd3D.Matrix,h.getModelviewProjectionMatrix=function(){return s&&(i=pd3D.Matrix.multiply(h.projectionMatrix,h.modelviewMatrix,i),s=!1),i},h.matrixMode=function(e){switch(e){case h.MODELVIEW:r=h.modelviewMatrix,t=n;break;case h.PROJECTION:r=h.projectionMatrix,t=a;break;default:throw new TypeError("invalid matrix mode "+e)}},h.loadIdentity=function(){pd3D.Matrix.identity(r),s=!0},h.loadMatrix=function(e){for(var t=e.m,i=r.m,a=0;a<16;++a)i[a]=t[a];s=!0},h.multMatrix=function(e){h.loadMatrix(pd3D.Matrix.multiply(r,e,o))},h.perspective=function(e,t,i,a){h.multMatrix(pd3D.Matrix.perspective(e,t,i,a,d))},h.frustum=function(e,t,i,a,r,n){h.multMatrix(pd3D.Matrix.frustum(e,t,i,a,r,n,d))},h.ortho=function(e,t,i,a,r,n){h.multMatrix(pd3D.Matrix.ortho(e,t,i,a,r,n,d))},h.scale=function(e,t,i){1==arguments.length?pd.isNumeric(e)?h.multMatrix(pd3D.Matrix.scale(e,e,e,d)):pd.isArray(e)&&h.multMatrix(pd3D.Matrix.scale(+e[0]||0,+e[1]||0,+e[2]||0,d)):3==arguments.length&&h.multMatrix(pd3D.Matrix.scale(+e||0,+t||0,+i||0,d))},h.translate=function(e,t,i){h.multMatrix(pd3D.Matrix.translate(e,t,i,d))},h.rotate=function(e,t,i,a){h.multMatrix(pd3D.Matrix.rotate(e,t,i,a,d))},h.lookAt=function(e,t,i,a,r,n,s,o,l){h.multMatrix(pd3D.Matrix.lookAt(e,t,i,a,r,n,s,o,l,d))},h.pushMatrix=function(){t.push(Array.prototype.slice.call(r.m))},h.popMatrix=function(){var e=t.pop();r=pd3D.Matrix.fromArray(e,r),s=!0},h.project=function(e,t,i,a,r,n){a=a||h.modelviewMatrix,r=r||h.projectionMatrix,n=n||h.getParameter(h.VIEWPORT);var s=r.transformPoint(a.transformPoint(new pd3D.Vector(e,t,i)));return new pd3D.Vector(n[0]+n[2]*(.5*s.x+.5),n[1]+n[3]*(.5*s.y+.5),.5*s.z+.5)},h.unproject=function(e,t,i,a,r,n){a=a||h.modelviewMatrix,r=r||h.projectionMatrix,n=n||h.getParameter(h.VIEWPORT);var s=new pd3D.Vector((e-n[0])/n[2]*2-1,(t-n[1])/n[3]*2-1,2*i-1);return pd3D.Matrix.inverse(pd3D.Matrix.multiply(r,a,d),o).transformPoint(s)},h.cleanup=function(){g&&g.endRender()},h.matrixMode(h.MODELVIEW),function(){var t=h;function i(e){(h=t).onlongpress&&h.onlongpress(e)}t.frameIndex=0,m(document,"keydown",function(e){f(e);var t=e.keyCode||event.which;27!=t||e.altKey||e.ctrlKey||e.metaKey||h.canvas.focus()}),m(document,"keyup",function(e){f(e)});var a=pdDOM.Interaction.makeInteractive(h.canvas,{onmove:function(e){h.onmousemove&&h.onmousemove(e)},onpress:function(e){(h=t).canvas.focus(),h.onmousedown&&h.onmousedown(e)},ondrag:function(e){(h=t).onmousedrag&&h.onmousedrag(e)},onrelease:function(e){(h=t).onmouseup&&h.onmouseup(e)},ondoubletap:function(e){(h=t).ondoubletap&&h.ondoubletap(e)},onlongclick:function(e){(h=t).onlongclick&&h.onlongclick(e)},onscroll:function(e){(h=t).onmousewheel&&h.onmousewheel(e)},onkeydown:function(e){f(e),h.onkeydown&&h.onkeydown(e);if(!e.altKey&&!e.ctrlKey&&!e.metaKey){var t=v(e.keyCode);t&&(pdGL.keys[t]=!0),pdGL.keys[e.keyCode]||pdGL.keyCount++,pdGL.keys[e.keyCode]=!0,_(e)}},onkeyup:function(e){f(e),h.onkeyup&&h.onkeyup(e);if(27==e.keyCode&&1<pdGL.keyCount)for(var t in pdGL.keyCount=0,pdGL.keys)0<+t&&pdGL.keys[t]&&pdGL.keyCount++;if(!e.altKey&&!e.ctrlKey&&!e.metaKey){var i=v(e.keyCode);i&&(pdGL.keys[i]=!1),pdGL.keys[e.keyCode]&&pdGL.keyCount--,pdGL.keys[e.keyCode]=!1,_(e)}}});h.addLongPress=function(e){a.setCallback("onlongpress",i),h.onlongpress=e}}(),function(){e=h,h.makeCurrent=function(){h=e};var e;var t=!0,i=!0;h.setCullFace=function(e){null==e&&(e=t),i!=e&&(e?h.enable(h.CULL_FACE):h.disable(h.CULL_FACE),i=e)},h.setCullFaceDefault=function(e){0<arguments.length&&(t=!!e,h.setCullFace())};var a=[],r=h.getParameter(h.ALIASED_LINE_WIDTH_RANGE);function n(e){return e.preventDefault(),e.stopPropagation(),!1}h.minLineWidth=r[0],h.maxLineWidth=r[1],h.activeLineWidth=1,h.readActiveLineWidth=function(){return h.activeLineWidth=h.getParameter(h.LINE_WIDTH),h.activeLineWidth},h.pushLineWidth=function(e){a.push(h.activeLineWidth),1024<=a.length&&(1024==a.length&&console.warn("WARNING: pdGL line width stack getting excessively large."),2048<a.length&&a.shift()),e&&0<e&&(h.activeLineWidth=e,h.lineWidth(e))},h.popLineWidth=function(){var e=0<a.length?a.pop():1;e&&.1<e&&(h.activeLineWidth=e,h.lineWidth(e))},h.getCanvasLineWidthThin=function(){return pdDOM.devicePixelRatio<1.25?.75:pdDOM.devicePixelRatio<2.25?1.5:2},h.getCanvasLineWidth=function(){return pdDOM.devicePixelRatio},h.getCanvasLineWidthThick=function(){return pdDOM.devicePixelRatio<1.25?1.55:pdDOM.devicePixelRatio<2.25?2.5:4},h.getCanvasLineWidthThicker=function(){return pdDOM.devicePixelRatio<1.25?3:pdDOM.devicePixelRatio<2.25?5:6},h.frameIndex=0,h.animationQueue=pdDOM.getGlobalAnimationQueue(),h.animate=function(){var i=h;return h.canvas.focus(),h.animationQueue.add(function(e,t){(h=i).onupdate&&(h.onupdate(e,t)||u)&&(u=!1,h.frameIndex=t,h.ondraw&&h.ondraw());return!1}),h.animationQueue.start(),h.animationQueue},h.fullscreen=function(e){var t=(e=e||{}).paddingTop||0,i=e.paddingLeft||0,a=e.paddingRight||0,r=e.paddingBottom||0;if(!document.body)throw new Error("document.body doesn't exist yet (call gl.fullscreen() from window.onload() or from inside the <body> tag)");function n(){h.canvas.width=window.innerWidth-i-a,h.canvas.height=window.innerHeight-t-r,h.viewport(0,0,h.canvas.width,h.canvas.height),h.orbitalView?h.orbitalView.applyProjection():!e.camera&&"camera"in e||(h.matrixMode(h.PROJECTION),h.loadIdentity(),h.perspective(e.fov||90,h.canvas.width/h.canvas.height,e.near||.1,e.far||1e3),h.matrixMode(h.MODELVIEW)),h.onresize&&h.onresize(),h.ondraw&&h.ondraw()}document.body.appendChild(h.canvas),document.body.style.overflow="hidden",h.canvas.style.position="absolute",h.canvas.style.left=i+"px",h.canvas.style.top=t+"px",h.canvas.style.msTouchAction="none",h.canvas.style.touchAction="none",m(window,"resize",n),n()},h.QUADS=7,h.QUAD_STRIP=8,h.HALF_FLOAT=h.HALF_FLOAT||36193,h.update=function(){u=!0},h.useOrbitalView=function(e){h.orbitalView=new pdGL.OrbitalView(e)},h.disableContextMenu=function(e){var t,i,a;h.canvas&&(e?m(h.canvas,"contextmenu",n):(t=h.canvas,i="contextmenu",a=n,t.removeEventListener(i,a)))}}(),h.enable(h.DEPTH_TEST),h.frontFace(h.CCW),h.enable(h.CULL_FACE),h.cullFace(h.BACK),h.enable(h.POLYGON_OFFSET_FILL),h.polygonOffset(1,1),h.enable(h.BLEND),h.blendFuncSeparate(h.SRC_ALPHA,h.ONE_MINUS_SRC_ALPHA,h.ONE,h.ONE_MINUS_SRC_ALPHA),h.canvas.setAttribute("tabindex","0"),h};var t={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"};function v(e){return t[e]||(65<=e&&e<=90?String.fromCharCode(e):null)}function _(e,t){e.getModifierState&&(t=t||"CapsLock",pdGL.keys[t]=e.getModifierState(t))}var e=null;pdGL.getDefaultMaterialFixedColor=function(){return e||(e=pdGL.Material.FixedColorUniformPointSize({name:"pdGL.DefaultMaterialFixedColor",uniforms:{color:[1,0,0,1],opacity:1}})),e};var i=null;pdGL.getDefaultMaterialMeshColor=function(){return i||(i=pdGL.Material.VariableColorUniformPointSize({name:"pdGL.DefaultMaterialMeshColor",uniforms:{color:[1,0,0,1],opacity:1}})),i},pdGL.OrbitalView=function(e){return e=e||{},this.defaultTarget=e.defaultTarget||new pd3D.Vector(0,0,0),this.defaultDistance=pd.toNumber(e.defaultDistance,8),this.defaultAzi=pd.toNumber(e.defaultAzi,60),this.defaultAlt=pd.toNumber(e.defaultAlt,30),this.defaultFOV=pd.toNumber(e.defaultFOV,45),this.zoomByDollying=pd.toBoolean(e.zoomByDollying,!1),this.animationSpeed=pd.toNumber(e.animationSpeed,2),this.farFieldFactor=pd.toNumber(e.farFieldFactor,2.5),this.farFieldMin=pd.toNumber(e.farFieldMin,0),this.kbdNav={active:!1,moveInOut:0,moveLeftRight:0,moveUpDown:0,lookLeftRight:0,lookUpDown:0,slowDown:.9,speedUp:.03,maxSpeed:.5},this.orbitMode=!0,this.handlePointerMove=e.handlePointerMove||null,this.handlePointerDown=e.handlePointerDown||null,this.handlePointerDrag=e.handlePointerDrag||null,this.handlePointerUp=e.handlePointerUp||null,this.target=new pd3D.Vector(this.defaultTarget.x,this.defaultTarget.y,this.defaultTarget.z),this.cameraDistance=this.defaultDistance,this.cameraAzi=this.defaultAzi,this.cameraAlt=this.defaultAlt,this.cameraFOV=this.defaultFOV,this.camera=new pd3D.Vector(0,this.defaultDistance,0),this.eyePos=new pd3D.Vector(0,this.defaultDistance,0),this.eyePosAsArray=[0,0,0],this.zoomFactor=1,this.mouseWheelIncrement=1,this.aspectRatio=0<h.canvas.height?h.canvas.width/h.canvas.height:1,this.snapGrid=pd.toNumber(e.snapGrid,0),this.hasChanged=h.PROJECTION,this.orthoMode=0,this._unprojectMatrix=new pd3D.Matrix,this._unprojectViewport=[0,0,640,480],this._unprojectValid=!1,this._localProjectionMatrix=null,this._localModelViewMatrix=null,this._localHUD=!1,this._zoomFactorMin=pd.toNumber(e.zoomFactorMin,.01),this._inertiaAction=0,this._inertiaThresholdTime=50,this._inertiaThresholdDelta=2,this._inertiaDampingFactor=.9,this._inertiaMinimumValue=.05,this._inertiaTimeStamp=0,this._inertiaDeltaX=0,this._inertiaDeltaY=0,this._inertiaZoom=0,this._rotationLock=!0,this._rotationThreshold=5,this._rotationAccum=0,this._animateSourceView=null,this._animateTargetView=null,this._animating=!1,pd.addSimpleEventHandling(this),e.callbackOnChange&&this.on("change",e.callbackOnChange),this.initialise(),this},pdGL.OrbitalView.prototype={getOrthoModeFieldOfView:function(){var e;switch(this.orthoMode){default:e=this.cameraFOV;break;case 1:e=this.defaultFOV*Math.abs(pd.cosDegrees(this.cameraAlt));break;case 2:e=this.defaultFOV*Math.abs(pd.sinDegrees(this.cameraAlt))}return pd.constrainTo(e,.1,160)},getFieldOfViewFactor:function(){var e=pd.constrainTo(this.cameraFOV,.1,160),t=.25/(this.zoomFactor*Math.tan(.25*e*l));return pd.constrainTo(t,.01,1e4)},apply:function(e){var t=this.getFieldOfViewFactor();(e||this.hasChanged>h.MODELVIEW)&&this.applyProjection(t),this._localHUD=!1,h.matrixMode(h.MODELVIEW),h.loadIdentity();var i=this.cameraAzi*l,a=pd.constrainTo(this.cameraAlt,-89.99,89.99)*l,r=this.cameraDistance*Math.cos(a),n=r*Math.cos(i),s=r*Math.sin(i),o=this.cameraDistance*Math.sin(a);return this.camera.init(this.target.x+n*t,this.target.y+s*t,this.target.z+o*t),this.eyePos.init(this.eyePosAsArray[0]=this.target.x+n,this.eyePosAsArray[1]=this.target.y+s,this.eyePosAsArray[2]=this.target.z+o),h.lookAt(this.camera.x,this.camera.y,this.camera.z,this.target.x,this.target.y,this.target.z,0,0,1),this.hasChanged&&(this.emit("change"),this.callbackOnChange&&this.callbackOnChange(this),this.hasChanged=0),this},applyProjection:function(e){var t=h.canvas.width,i=h.canvas.height;h.matrixMode(h.PROJECTION),h.loadIdentity(),this.aspectRatio=0<i?t/i:1,this._unprojectViewport[2]=t,this._unprojectViewport[3]=i,e=pd.toNumber(e,this.getFieldOfViewFactor());var a=this.farFieldFactor/pd.constrainTo(this.zoomFactor,.001,1)*this.defaultDistance,r=e*this.cameraDistance;return h.perspective(pd.constrainTo(this.cameraFOV,.1,160),this.aspectRatio,Math.max(r-a,.0025*this.defaultDistance),r+Math.max(a,this.farFieldMin)),this._unprojectValid=!1,h.setCullFace(),this},startOverlay2D:function(e,t){var i=e||h.canvas.width,a=t||h.canvas.height;return this._localProjectionMatrix=pd3D.Matrix.clone(h.projectionMatrix,this._localProjectionMatrix),this._localModelViewMatrix=pd3D.Matrix.clone(h.modelviewMatrix,this._localModelViewMatrix),this._localHUD=!0,h.matrixMode(h.PROJECTION),h.loadIdentity(),h.ortho(.5,i+.5,.5,a+.5,-100,100),h.matrixMode(h.MODELVIEW),h.loadIdentity(),this},endOverlay2D:function(){return pd3D.Matrix.clone(this._localProjectionMatrix,h.projectionMatrix),pd3D.Matrix.clone(this._localModelViewMatrix,h.modelviewMatrix),this._localHUD=!1,this},copyViewDataTo:function(e,t){return e||(e={}),t||(t=this),null!=t.defaultAzi&&(e.defaultAzi=t.defaultAzi),null!=t.defaultAlt&&(e.defaultAlt=t.defaultAlt),null!=t.defaultFOV&&(e.defaultFOV=t.defaultFOV),null!=t.defaultDistance&&(e.defaultDistance=t.defaultDistance),null!=t.cameraAzi&&(e.cameraAzi=t.cameraAzi),null!=t.cameraAlt&&(e.cameraAlt=t.cameraAlt),null!=t.cameraFOV&&(e.cameraFOV=t.cameraFOV),null!=t.cameraDistance&&(e.cameraDistance=t.cameraDistance),pd.isNumeric(t.zoom)&&(e.zoomFactor=t.zoom),null!=t.zoomFactor&&(e.zoomFactor=t.zoomFactor),null!=t.farFieldFactor&&(e.farFieldFactor=t.farFieldFactor),null!=t.farFieldMin&&(e.farFieldMin=t.farFieldMin),null!=t.snapGrid&&(e.snapGrid=t.snapGrid),null!=t.defaultTarget&&(pd.isArray(t.defaultTarget)?e.defaultTarget=pd3D.Vector.fromArray(t.defaultTarget):t.defaultTarget instanceof pd3D.Vector&&(e.defaultTarget?e.defaultTarget.init(t.defaultTarget):e.defaultTarget=new pd3D.Vector(t.defaultTarget))),null!=t.target&&(pd.isArray(t.target)?e.target=pd3D.Vector.fromArray(t.target):t.target instanceof pd3D.Vector&&(e.target?e.target.init(t.target):e.target=new pd3D.Vector(t.target))),null!=t.camera&&(pd.isArray(t.camera)?e.camera=pd3D.Vector.fromArray(t.camera):t.camera instanceof pd3D.Vector&&(e.camera?e.camera.init(t.camera):e.camera=new pd3D.Vector(t.camera))),e},interpolateBetween:function(e,t,i){if(t&&e){var a=1-(i=pd.constrainTo(i,0,1));if(this.orbitMode=!0,null!=t.defaultDistance?(this.defaultDistance=a*e.defaultDistance+i*t.defaultDistance,this.cameraDistance=a*e.cameraDistance+i*t.defaultDistance):null!=t.cameraDistance&&(this.cameraDistance=a*e.cameraDistance+i*t.cameraDistance),null!=t.defaultAzi?(this.defaultAzi=pd.wrapAt(a*e.defaultAzi+i*t.defaultAzi,-180,180),this.cameraAzi=pd.wrapAt(a*e.cameraAzi+i*t.defaultAzi,-180,180)):null!=t.cameraAzi&&(this.cameraAzi=pd.wrapAt(a*e.cameraAzi+i*t.cameraAzi,-180,180)),null!=t.defaultAlt?(this.defaultAlt=pd.constrainTo(a*e.defaultAlt+i*t.defaultAlt,-90,90),this.cameraAlt=pd.constrainTo(a*e.cameraAlt+i*t.defaultAlt,-90,90)):null!=t.cameraAlt&&(this.cameraAlt=pd.constrainTo(a*e.cameraAlt+i*t.cameraAlt,-90,90)),null!=t.defaultFOV?(this.defaultFOV=a*e.defaultFOV+i*t.defaultFOV,this.cameraFOV=a*e.cameraFOV+i*t.defaultFOV):null!=t.cameraFOV&&(this.cameraFOV=a*e.cameraFOV+i*t.cameraFOV),null!=t.zoomFactor&&(this.zoomFactor=Math.max(this._zoomFactorMin,a*e.zoomFactor+i*t.zoomFactor)),null!=t.farFieldFactor&&(this.farFieldFactor=a*e.farFieldFactor+i*t.farFieldFactor),null!=t.farFieldMin&&(this.farFieldMin=a*e.farFieldMin+i*t.farFieldMin),null!=t.snapGrid&&(this.snapGrid=a*e.snapGrid+i*t.snapGrid),null!=t.defaultTarget?(this.defaultTarget.x=a*e.target.x+i*t.defaultTarget.x,this.defaultTarget.y=a*e.target.y+i*t.defaultTarget.y,this.defaultTarget.z=a*e.target.z+i*t.defaultTarget.z,this.target.init(this.defaultTarget)):null!=t.target&&(this.target.x=a*e.target.x+i*t.target.x,this.target.y=a*e.target.y+i*t.target.y,this.target.z=a*e.target.z+i*t.target.z),null!=t.camera){var r=this.getFieldOfViewFactor();this.camera.x=a*e.camera.x+i*t.camera.x,this.camera.y=a*e.camera.y+i*t.camera.y,this.camera.z=a*e.camera.z+i*t.camera.z,this.cameraDistance=this.camera.distanceTo(this.target)/r,this.cameraAlt=function(e,t){var i=t.z-e.z;if(Math.abs(i)<1e-6)return 0;var a=Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y));return Math.abs(a)<1e-6?i<0?-90:90:Math.atan2(i,a)*d}(this.target,this.camera),this.cameraAzi=(n=this.target,s=this.camera,o=s.x-n.x,l=s.y-n.y,Math.abs(o)<1e-6?Math.abs(l)<1e-6?0:l<0?-90:90:Math.atan2(l,o)*d),this.orbitMode=!1}this.hasChanged=h.PROJECTION,this._unprojectValid=!1}var n,s,o,l;return this},animateTo:function(e,t){var i=this,a=0;if(this._animating)return this;this._animateSourceView=this.copyViewDataTo(this._animateSourceView),this._animateTargetView=this.copyViewDataTo(null,e),this._animating=!0;var r=pd.toNumber(e.cameraFOV,this.cameraFOV);return pd.closeTo(r,0,1e-4)?this._rotationThreshold=15:this._rotationThreshold=5,this._rotationLock=!0,h.animationQueue.addOrReplace(function(e){return 1<(a+=i.animationSpeed*pd.constrainTo(e,.001,.2))&&(a=1),i.interpolateBetween(i._animateSourceView,i._animateTargetView,pd.Easing.inOutSine(a)),t&&t(i,a),h.update(),.999<a&&(i._animating=!1,!(i._animateTargetView=null))}).start(),this},setView:function(e){e=e||{};var t={target:this.defaultTarget,cameraDistance:this.defaultDistance,zoomFactor:1};return this.copyViewDataTo(t,e),this.interpolateBetween(this,t,1),this._unprojectValid=!1,h.update(),this},setCamera:function(e,t,i,a){return pd.isNumeric(e)&&(e=pd.wrapAt(e,-180,180),pd.closeTo(this.cameraAzi,e,.01)||(this.hasChanged=h.MODELVIEW,this.cameraAzi=e)),pd.isNumeric(t)&&(t=pd.constrainTo(t,-90,90),pd.closeTo(this.cameraAlt,t,.01)||(this.hasChanged=h.MODELVIEW,this.cameraAlt=t)),pd.isNumeric(i)&&(i=pd.constrainTo(i,0,160),pd.closeTo(this.cameraFOV,i,.01)||(this.hasChanged=h.PROJECTION,this.cameraFOV=i)),pd.isNumeric(a)&&(a=pd.constrainTo(a,.001,1e3),pd.closeTo(this.zoomFactor,a,1e-4)||(this.zoomFactor=Math.max(this._zoomFactorMin,a),this.hasChanged=h.PROJECTION)),pd.closeTo(this.cameraFOV,0,1e-4)?this._rotationThreshold=15:this._rotationThreshold=5,this._rotationLock=!0,this.hasChanged&&(this._unprojectValid=!1,this._animating=!1,h.update()),0!=this.hasChanged},setZoomFactor:function(e){return e=pd.constrainTo(pd.toNumber(e,0),.01,3),this.zoomFactor=Math.max(this._zoomFactorMin,e),this.zoomByDollying&&(this.cameraDistance=this.defaultDistance/this.zoomFactor),this.hasChanged=h.PROJECTION,this._unprojectValid=!1,h.update(),this},reset:function(e,t){return this._unprojectValid=!1,this._animating=!1,e?(this.cameraAzi=this.defaultAzi,this.cameraAlt=this.defaultAlt,this.cameraFOV=this.defaultFOV,this.hasChanged=h.PROJECTION,h.update()):this.animateTo({cameraAzi:this.defaultAzi,cameraAlt:this.defaultAlt,cameraFOV:this.defaultFOV,cameraDistance:this.defaultDistance,target:this.defaultTarget,zoomFactor:1},t),this},center:function(e,t){e=e||{};var i={target:this.defaultTarget,cameraDistance:this.defaultDistance,zoomFactor:1};return this.copyViewDataTo(i,e),this._unprojectValid=!1,this._animating=!1,this.orbitMode=!0,e.noAnimation?(this.interpolateBetween(this,i,1),h.update()):this.animateTo(i,t),this},isCenter:function(){return(!this.zoomByDollying||this.cameraDistance==this.defaultDistance)&&(this.target.equals(this.defaultTarget)&&1==this.zoomFactor)},redraw:function(){return h.update(),this},getPointSize:function(){return.01*this.defaultDistance},getVectorToCamera:function(e,t,i){arguments.length<1&&(e=this.target.x,t=this.target.y,i=this.target.z);var a=this.camera.x-e,r=this.camera.y-t,n=this.camera.z-i,s=a*a+r*r+n*n;return 0<s&&(a*=s=1/Math.sqrt(s),r*=s,n*=s),[a,r,n]},checkUnprojectMatrix:function(e){return this._unprojectValid&&!e||(this._localHUD?pd3D.Matrix.inverse(pd3D.Matrix.multiply(this._localProjectionMatrix,this._localModelViewMatrix),this._unprojectMatrix):pd3D.Matrix.inverse(pd3D.Matrix.multiply(h.projectionMatrix,h.modelviewMatrix),this._unprojectMatrix),this._unprojectValid=!0),this},modelToCanvas:function(e,t){var i,a=this._unprojectViewport;return this.checkUnprojectMatrix(),this._localHUD?(i=this._localProjectionMatrix.transformPoint(this._localModelViewMatrix.transformPoint(new pd3D.Vector(t[0],t[1],t[2]))),e[0]=a[0]+a[2]*(.5*i.x+.5),e[1]=a[1]+a[3]*(.5*i.y+.5)):(i=h.projectionMatrix.transformPoint(h.modelviewMatrix.transformPoint(new pd3D.Vector(t[0],t[1],t[2]))),e[0]=(a[0]+a[2]*(.5*i.x+.5))/pdDOM.devicePixelRatio,e[1]=(a[3]-(a[1]+a[3]*(.5*i.y+.5)))/pdDOM.devicePixelRatio),e[2]=.5*i.z+.5,e},canvasToModel:function(e,t,i){this.checkUnprojectMatrix();var a=this._unprojectViewport;return e*=pdDOM.devicePixelRatio,t=a[3]-t*pdDOM.devicePixelRatio,this._unprojectMatrix.transformPoint(new pd3D.Vector((e-a[0])/a[2]*2-1,(t-a[1])/a[3]*2-1,2*i-1))},zoom:function(e){return e*=.5,this.zoomFactor=Math.max(this._zoomFactorMin,this.zoomFactor+e),this.zoomByDollying&&(this.cameraDistance=this.defaultDistance/this.zoomFactor),this.hasChanged=h.PROJECTION,this._unprojectValid=!1,h.update(),this},walk:function(e){var t=this.target.subtract(this.camera).normalize().multiply(.25*e*this.cameraDistance*this.getFieldOfViewFactor());return this.camera.init(this.camera.x+t.x,this.camera.y+t.y,this.camera.z+t.z),this.target.init(this.target.x+t.x,this.target.y+t.y,this.target.z+t.z),this.hasChanged=h.PROJECTION,this._unprojectValid=!1,this.orbitMode=!1,h.update(),this},rotate:function(e,t){if(this.cameraAzi=pd.wrapAt(this.cameraAzi-e,-180,180),this.cameraAlt=Math.max(-90,Math.min(90,this.cameraAlt+t)),!this.orbitMode){var i=this.camera.distanceTo(this.target),a=pd.wrapAt(this.cameraAzi+180,-180,180);pd3D.Vector.sphericalToCartesian3D(a*l,-this.cameraAlt*l,i,this.target),pd3D.Vector.add(this.target,this.camera,this.target)}return this.hasChanged=h.MODELVIEW,this._unprojectValid=!1,h.update(),this},pan:function(e,t,i){var a,r=!1,n=.25*this.defaultDistance/this.zoomFactor,s=this.target.subtract(this.camera).normalize();if(1e-4<Math.abs(t)){t*=n;var o=(a=pd3D.Vector.UnitZ.cross(s).normalize()).cross(s).normalize().multiply(t);this.target.init(this.target.x-o.x,this.target.y-o.y,this.target.z-o.z),this.camera.init(this.camera.x-o.x,this.camera.y-o.y,this.camera.z-o.z),r=!0}return 1e-4<Math.abs(e)&&(e*=n,a=pd3D.Vector.UnitZ.cross(s).normalize().multiply(e),this.target.init(this.target.x+a.x,this.target.y+a.y,this.target.z+a.z),this.camera.init(this.camera.x+a.x,this.camera.y+a.y,this.camera.z+a.z),r=!0),r&&i&&(this.hasChanged=h.MODELVIEW,this._unprojectValid=!1,h.update()),this},clearInertia:function(){return this._inertiaAction=0,this._inertiaTimeStamp=0,this._inertiaDeltaX=0,this._inertiaDeltaY=0,this._inertiaZoom=0,this},updateView:function(e){if(1==this._inertiaAction)this.rotate(.25*this._inertiaDeltaX,.25*this._inertiaDeltaY);else if(2==this._inertiaAction)this.pan(.0075*this._inertiaDeltaX,.0075*this._inertiaDeltaY,!0);else if(3==this._inertiaAction)this.zoom(this._inertiaZoom);else if(4==this._inertiaAction)this.pan(.0075*this._inertiaDeltaX,.0075*this._inertiaDeltaY,!1),e&&this.rotate(e,0),this.zoom(this._inertiaZoom);else if(5==this._inertiaAction){var t=pd.constrainTo(this.cameraFOV-150*this._inertiaZoom,0,160);t!=this.cameraFOV&&(this.cameraFOV=t,this.zoom(this.zoomFactor*this._inertiaZoom))}return this},updateInertia:function(){return 0<this._inertiaAction&&(Math.abs(this._inertiaDeltaX)>this._inertiaMinimumValue||Math.abs(this._inertiaDeltaY)>this._inertiaMinimumValue||1e-4<Math.abs(this._inertiaZoom))?(this._inertiaDeltaX=this._inertiaDeltaX*this._inertiaDampingFactor,this._inertiaDeltaY=this._inertiaDeltaY*this._inertiaDampingFactor,this._inertiaZoom=this._inertiaZoom*this._inertiaDampingFactor,this.updateView(),!1):(this.clearInertia(),!0)},handleKbdNavigation:function(e){var t=!1;if(pdGL.keyCount||this.kbdNav.active)if(this.orbitMode)(pdGL.keys.CapsLock||pdGL.keys.SHIFT)&&(e*=5),(pdGL.keys.A||pdGL.keys.D||pdGL.keys.Q||pdGL.keys.Z)&&(this.pan(e*((pdGL.keys.A||0)-(pdGL.keys.D||0)),e*((pdGL.keys.Q||0)-(pdGL.keys.Z||0)),!0),t=!0),(pdGL.keys.LEFT||pdGL.keys.RIGHT||pdGL.keys.UP||pdGL.keys.DOWN)&&(this.rotate(25*e*((pdGL.keys.LEFT||0)-(pdGL.keys.RIGHT||0)),25*e*((pdGL.keys.UP||0)-(pdGL.keys.DOWN||0))),t=!0),(pdGL.keys.W||pdGL.keys.S)&&(this.walk(e*this.kbdNav.speedUp*((pdGL.keys.W||0)-(pdGL.keys.S||0))),t=!0);else{var i=this.kbdNav,a=i.slowDown,r=i.speedUp,n=this.kbdNav.maxSpeed;if((pdGL.keys.CapsLock||pdGL.keys.SHIFT)&&(n*=10),pdGL.keys.W||pdGL.keys.S?(i.moveInOut+=r*((pdGL.keys.W||0)-(pdGL.keys.S||0)),i.moveInOut=pd.constrainTo(i.moveInOut,-n,n)):i.moveInOut*=a,pdGL.keys.A||pdGL.keys.D?(i.moveLeftRight+=r*((pdGL.keys.A||0)-(pdGL.keys.D||0)),i.moveLeftRight=pd.constrainTo(i.moveLeftRight,-n,n)):i.moveLeftRight*=a,pdGL.keys.Q||pdGL.keys.Z?(i.moveUpDown+=r*((pdGL.keys.Q||0)-(pdGL.keys.Z||0)),i.moveUpDown=pd.constrainTo(i.moveUpDown,-n,n)):i.moveUpDown*=a,pdGL.keys.LEFT||pdGL.keys.RIGHT?(i.lookLeftRight+=25*r*((pdGL.keys.RIGHT||0)-(pdGL.keys.LEFT||0)),i.lookLeftRight=pd.constrainTo(i.lookLeftRight,-100*n,100*n)):i.lookLeftRight*=a,pdGL.keys.UP&&pdGL.keys.DOWN?i.lookUpDown=this.cameraAlt/e*-.1:pdGL.keys.UP||pdGL.keys.DOWN?(i.lookUpDown+=15*r*((pdGL.keys.DOWN||0)-(pdGL.keys.UP||0)),i.lookUpDown=pd.constrainTo(i.lookUpDown,-100*n,100*n)):i.lookUpDown*=a,i.active=!1,(1e-4<Math.abs(i.moveLeftRight)||1e-4<Math.abs(i.moveUpDown))&&(this.pan(.5*e*i.moveLeftRight,.5*e*i.moveUpDown,!0),t=i.active=!0),1e-4<Math.abs(i.lookLeftRight)||1e-4<Math.abs(i.lookUpDown)){if(this.cameraFOV<1){var s=Math.max(.05,this.cameraFOV);this.pan(e*s*-i.lookLeftRight,e*s*-i.lookUpDown,!0)}else this.rotate(e*i.lookLeftRight,e*i.lookUpDown);t=i.active=!0}1e-4<Math.abs(i.moveInOut)&&(this.cameraFOV<1?this.zoom(e*i.moveInOut):this.walk(e*i.moveInOut),t=i.active=!0)}return t},initialise:function(){var a=this,r=-1,n=!1,s=0;function t(){return a.updateInertia()}return h.onmousemove=function(e){a.handlePointerMove&&a.handlePointerMove(e)},h.onmousedown=function(e){a.clearInertia(),s=e.touchCount,a.handlePointerDown&&(n=a.handlePointerDown(e)),a._rotationAccum=0,r=e.button},h.onmousedrag=function(e){var t=e.button;if(e.button<0&&(t=e.button=r),s<e.touchCount&&(s=e.touchCount),!(n&&a.handlePointerDrag&&a.handlePointerDrag(e)))if((a._inertiaAction=0)==t||2==t&&!e.touchCount){if(e.ctrlKey||e.metaKey)e.shiftKey?(a._inertiaAction=5,a._inertiaTimeStamp=e.timeStamp,a._inertiaDeltaX=e.dragX,a._inertiaDeltaY=e.dragY,a._inertiaZoom=.0015*-(a._inertiaDeltaX-a._inertiaDeltaY)):(a._inertiaAction=3,a._inertiaTimeStamp=e.timeStamp,a._inertiaDeltaX=e.dragX,a._inertiaDeltaY=e.dragY,a._inertiaZoom=.005*(a._inertiaDeltaX-a._inertiaDeltaY)),a.updateView();else if(e.shiftKey){var i=1;a._inertiaAction=2,a._inertiaTimeStamp=e.timeStamp,a._inertiaDeltaX=i*e.dragX,a._inertiaDeltaY=i*e.dragY,a._inertiaZoom=0,a.updateView()}else if(e.hasMoved(e.isTouchEvent?10:4)){i=a.orbitMode?1:pd.mapAndConstrainTo(a.cameraFOV,0,90,.001,1);a._inertiaAction=1,a._inertiaTimeStamp=e.timeStamp,a._inertiaDeltaX=i*e.dragX,a._inertiaDeltaY=i*e.dragY,a._inertiaZoom=0,a.updateView()}}else 1==t?(a._inertiaTimeStamp=e.timeStamp,a._inertiaDeltaX=e.dragX,a._inertiaDeltaY=e.dragY,a._inertiaAction=4,a._inertiaZoom=1.5*(e.scale-1),.25<Math.abs(a._inertiaZoom)&&(a._inertiaZoom=0,e.rotation=0),a._rotationLock&&a.orbitMode&&!pd.closeTo(e.rotation,0,1e-4)&&(a._rotationAccum+=e.rotation,Math.abs(a._rotationAccum)>a._rotationThreshold?a._rotationLock=!1:e.rotation=0),a.updateView(e.rotation)):2==t&&(2<e.touchCount?a._inertiaAction=2:a._inertiaAction=1,a._inertiaTimeStamp=e.timeStamp,a._inertiaDeltaX=e.dragX,a._inertiaDeltaY=e.dragY,a._inertiaZoom=0,a.updateView())},h.onmouseup=function(e){n&&a.handlePointerUp&&a.handlePointerUp(e)||(n=!1,pdDOM.Interaction.hasMoved(5*pdDOM.devicePixelRatio)&&e.timeStamp-a._inertiaTimeStamp<a._inertiaThresholdTime&&(Math.abs(a._inertiaDeltaX)>a._inertiaThresholdDelta||Math.abs(a._inertiaDeltaY)>a._inertiaThresholdDelta||.01<Math.abs(a._inertiaZoom))&&h.animationQueue.addOrReplace(t).start(),h.oncontextmenu&&2==event.button&&!pdDOM.Interaction.hasMoved()&&h.oncontextmenu(e),r=-1,a._rotationLock||(a._rotationThreshold=5))},h.onmousewheel=function(e){if(e.delta){var t=e.delta<0?-1:1;e.shiftKey?t*=10:(e.ctrlKey||e.metaKey)&&(t*=.1),e.timeStamp-a._inertiaTimeStamp<a._inertiaThresholdTime?(a.mouseWheelIncrement+=.1,0<=t?t+=a.mouseWheelIncrement:t-=a.mouseWheelIncrement):a.mouseWheelIncrement=0,a._inertiaTimeStamp=e.timeStamp,a.zoom(.05*t)}},this}};var a=0,r={};function n(e){return e in r||(r[e]=h.getExtension(e)),r[e]}pdGL.Texture=function(e,t,i){i=i||{},a||(a=h.getParameter(h.MAX_COMBINED_TEXTURE_IMAGE_UNITS)),this.width=pd.toInteger(e,64),this.height=pd.toInteger(t,64),this.unit=pd.toInteger(i.unit,0),this.type=pd.toInteger(i.type,h.UNSIGNED_BYTE),this.format=pd.toInteger(i.format,h.RGBA),this.type==h.FLOAT?(n("OES_texture_float")||console.warn("ERROR: Device or browser does not support 'OES_texture_float'."),n("OES_texture_float_linear")||(i.filter=h.NEAREST)):this.type==h.HALF_FLOAT&&(n("OES_texture_half_float")||console.warn("ERROR: Device or browser does not support 'OES_texture_half_float'."),n("OES_texture_half_float_linear")||(i.filter=h.NEAREST)),i.imageData||(i.imageData=null),this.textureId=h.createTexture(),h.activeTexture(h.TEXTURE0+this.unit),h.bindTexture(h.TEXTURE_2D,this.textureId),h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!0),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,i.filter||i.magFilter||h.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,i.filter||i.minFilter||h.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,i.wrap||i.wrapS||h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,i.wrap||i.wrapT||h.CLAMP_TO_EDGE),h.texImage2D(h.TEXTURE_2D,0,this.format,this.width,this.height,0,this.format,this.type,i.imageData),this.bound=!1};var o,x=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];pdGL.Texture.prototype={_frameBuffer:null,_depthBuffer:null,_setUpFramebuffer:function(e){var t=!1;if(h.viewport(0,0,this.width,this.height),this._frameBuffer||(this._frameBuffer=h.createFramebuffer(),t=!0),h.bindFramebuffer(h.FRAMEBUFFER,this._frameBuffer),h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,this.textureId,0),!1!==e){this._depthBuffer||(this._depthBuffer=h.createRenderbuffer());var i=this._depthBuffer;h.bindRenderbuffer(h.RENDERBUFFER,i),this.width==i.width&&this.height==i.height||(i.width=this.width,i.height=this.height,h.renderbufferStorage(h.RENDERBUFFER,h.DEPTH_COMPONENT16,this.width,this.height)),h.framebufferRenderbuffer(h.FRAMEBUFFER,h.DEPTH_ATTACHMENT,h.RENDERBUFFER,i)}return t},bind:function(e){return 0<=(e=e||this.unit||0)&&e<16?x[e]!=this.textureId&&(h.activeTexture(h.TEXTURE0+e),h.bindTexture(h.TEXTURE_2D,this.textureId),x[e]=this.textureId):(h.activeTexture(h.TEXTURE0+e),h.bindTexture(h.TEXTURE_2D,this.textureId)),this.bound=!0,this},unbind:function(e){return 0<=(e=e||this.unit||0)&&e<16?x[e]==this.textureId&&(h.activeTexture(h.TEXTURE0+e),h.bindTexture(h.TEXTURE_2D,null),x[e]=-1):(h.activeTexture(h.TEXTURE0+e),h.bindTexture(h.TEXTURE_2D,null)),this.bound=!1,this},drawTo:function(e,t){t=t||{};var i=h.getParameter(h.VIEWPORT);return this._setUpFramebuffer(t.depth),e&&e(),h.bindFramebuffer(h.FRAMEBUFFER,null),h.bindRenderbuffer(h.RENDERBUFFER,null),h.viewport(i[0],i[1],i[2],i[3]),this},drawToCanvas:function(e,t,i){i=i||{};var a=h.getParameter(h.VIEWPORT);if(this._setUpFramebuffer(i.depth),t&&t(),e&&e.getContext&&this._frameBuffer){var r=new Uint8Array(this.width*this.height*4);h.readPixels(0,0,this.width,this.height,h.RGBA,h.UNSIGNED_BYTE,r);var n=e.getContext("2d"),s=n.createImageData(this.width,this.height);s.data.set(r),n.putImageData(s,0,0)}return h.bindFramebuffer(h.FRAMEBUFFER,null),h.bindRenderbuffer(h.RENDERBUFFER,null),h.viewport(a[0],a[1],a[2],a[3]),this},swapWith:function(e){var t;return t=e.textureId,e.textureId=this.textureId,this.textureId=t,t=e.width,e.width=this.width,this.width=t,t=e.height,e.height=this.height,this.height=t,this},destroy:function(){return this._frameBuffer&&(h.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null),this._depthBuffer&&(h.deleteRenderbuffer(this._depthBuffer),this._depthBuffer=null),this.unbind(),h.deleteTexture(this.textureId),this}};var b=null;pdGL.Texture.placeholder=function(){return b||(b=new pdGL.Texture(1,1,{imageData:new Uint8Array([0,0,0,0])})),b},pdGL.Texture.fromImage=function(e,t){t=t||{};var i=new pdGL.Texture(e.width,e.height,t);try{h.texImage2D(h.TEXTURE_2D,0,i.format,i.format,i.type,e)}catch(e){throw"file:"==window.location.protocol?new Error('Image not loaded for security reasons (serve this page over "http://" instead)'):new Error("Image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)")}return t.minFilter&&t.minFilter!=h.NEAREST&&t.minFilter!=h.LINEAR&&h.generateMipmap(h.TEXTURE_2D),i},pdGL.Texture.fromCanvas=function(e,t){var i=e.getContext("2d");return pdGL.Texture.fromImage(i.canvas,t)},pdGL.Texture.fromURL=function(e,t){o=o||function(){var e=document.createElement("canvas").getContext("2d");e.canvas.width=e.canvas.height=128;for(var t=0;t<e.canvas.height;t+=16)for(var i=0;i<e.canvas.width;i+=16)e.fillStyle=16&(i^t)?"#FFF":"#DDD",e.fillRect(i,t,16,16);return e.canvas}();var i=pdGL.Texture.fromImage(o,t),a=new Image,r=h;return a.onload=function(){r.makeCurrent(),pdGL.Texture.fromImage(a,t).swapWith(i)},a.src=e,i},pdGL.Material=function(e){e=e||{},pd3D.Material.call(this,e),this._mode=pd.toInteger(e.mode,h.TRIANGLES),this._shader=e.shader||pdGL.Material.DefaultShader(),this._shadowMap=e.shadowMap||null,this._textureUnit=pd.toInteger(e.textureUnit,-1),this._texture=e.texture||null,this._uniforms=e.uniforms||{},this._callbackOnDrawMesh=null,this._cachedUniforms=null,this._rendering=!1,this._shadowMap&&(this._uniforms.shadowMap=0),this._texture&&(this._uniforms.texture=this._textureUnit)},pdGL.Material.prototype=Object.create(pd3D.Material.prototype),pdGL.Material.prototype.constructor=pdGL.Material,pdGL.Material.prototype.shader=function(e){return 0==arguments.length?this._shader:(this._shader=e,this)},pdGL.Material.prototype.uniform=function(e,t){if(1==arguments.length)return this._uniforms[e];if(2<=arguments.length&&(this._uniforms[e]=t,this._cachedUniforms)){if(!this._shader)throw'Attempted to set uniform "'+e+'" before assigning a valid shader.';var i=this._cachedUniforms[e];this._cachedUniforms[e]=this._shader.createCachedUniform(e,t,i),this._rendering&&this._shader.setCachedUniformValue(this._cachedUniforms[e])}return this},pdGL.Material.prototype.uniforms=function(e){return 0==arguments.length?this._uniforms:(this._uniforms=e||{},this._cachedUniforms=null,this)},pdGL.Material.prototype.createUniformCache=function(){var e={},t=this._uniforms,i=this._shader;for(var a in t)t.hasOwnProperty(a)&&(e[a]=i.createCachedUniform(a,t[a],e[a]));return this._cachedUniforms=e,this},pdGL.Material.prototype.getCachedUniform=function(e){return this._cachedUniforms||this.createUniformCache(),this._cachedUniforms[e]},pdGL.Material.prototype.setCachedUniform=function(e,t){return t&&(this._cachedUniforms||this.createUniformCache(),this._cachedUniforms[e]=t),this},pdGL.Material.prototype.setCachedUniforms=function(e){var t={},i=this._uniforms,a=this._shader;for(var r in i)i.hasOwnProperty(r)&&(t[r]=r in e?e[r]:a.createCachedUniform(r,i[r]));return this._cachedUniforms=t,this},pdGL.Material.prototype.pushUniform=function(e,t){return pdGL.Material.pushUniform(this,e,t),this},pdGL.Material.prototype.popUniform=function(){return pdGL.Material.popUniform(),this},pdGL.Material.prototype.texture=function(e,t){return 0==arguments.length?this._texture:(this._texture=e,this._textureUnit=0<t?t:1,this._texture?this._uniforms.texture=this._textureUnit:delete this._uniforms.texture,this)},pdGL.Material.prototype.shadowMap=function(e){return 0==arguments.length?this._shadowMap:(this._shadowMap=e,this._shadowMap?this._uniforms.shadowMap=0:delete this._uniforms.shadowMap,this)},pdGL.Material.prototype.mode=function(e){return 0==arguments.length?this._mode:(this._mode=e,this)};var y=-1;function S(e,t){return(e=pd.toNumber(e,t))<0?t:e}pdGL.Material.prototype.isRendering=function(){return this._rendering},pdGL.Material.prototype.startRender=function(){return g&&g.id==this.id||(g&&g.endRender(),this._shadowMap&&this._shadowMap.bind(0),0<this._textureUnit&&(this._texture?this._texture.bind(this._textureUnit):pdGL.Texture.placeholder().bind(this._textureUnit)),this._cachedUniforms||this.createUniformCache(),this._shader.setCachedUniformValues(this._cachedUniforms),this._shader.prepareMatrices(),this._rendering=!0,g=this),this},pdGL.Material.prototype.endRender=function(){return g=null,this._rendering=!1,this},pdGL.Material.prototype.unbindTextures=function(){return this._texture&&this._texture.unbind(this._textureUnit),this._shadowMap&&this._shadowMap.unbind(0),this},pdGL.Material.prototype._renderMesh=function(e,t,i){return i||(i=pdGL.Shader.getIndexBufferName(t)),e.checkToCompile(),this._callbackOnDrawMesh&&this._callbackOnDrawMesh(e,t),t>=h.TRIANGLES&&null!=e.twoSided&&h.setCullFace(!e.twoSided),e.callbackOnDraw&&e.callbackOnDraw(e,t,this),this._shader.renderPrimitive(e.vertexBuffers,e.indexBuffers[i],t),0<y&&(y=-1,h.popLineWidth()),this},pdGL.Material.prototype.renderMeshes=function(e,t){if(this._shader&&e){var i,a,r,n=pd.isArray(e)?e:[e];if(this._rendering||this.startRender(),this._cachedUniforms||(this.createUniformCache(),this._shader.setCachedUniformValues(this._cachedUniforms)),t===pd3D.RENDER_ALL&&(t=c),pd.isArray(t)){for(var s=t,o=0,l=n.length;o<l;++o)if((i=n[o])&&i.visible)for(var d=0;d<s.length;++d)t=S(s[d],this._mode),a=i[r=pdGL.Shader.getIndexBufferName(t)],(!t||a&&a.length)&&this._renderMesh(i,t,r)}else{t=S(t,this._mode),r=pdGL.Shader.getIndexBufferName(t);for(o=0,l=n.length;o<l;++o)a=(i=n[o])[r],i&&i.visible&&(!t||a&&a.length)&&this._renderMesh(i,t,r)}h.setCullFace()}return this},pdGL.Material.prototype.renderSurfaces=function(e){return this.renderMeshes(e,h.TRIANGLES)},pdGL.Material.prototype.renderOutlines=function(e){return this.renderMeshes(e,h.LINES)},pdGL.Material.prototype.renderPoints=function(e){return this.renderMeshes(e,h.POINTS)},pdGL.Material.prototype.renderNode3D=function(e,t){if(this.startRender(),pd.isArray(e))for(var i=0,a=e.length;i<a;++i)e[i].drawWithMaterial(this,t);else e.drawWithMaterial(this,t);return this.endRender(),this},pdGL.Material.prototype.draw=function(e,t){return this._shader&&e&&(this.startRender(),this.renderMeshes(e,t),this.endRender()),this},pdGL.Material.prototype.drawSurface=function(e){return this.draw(e,h.TRIANGLES)},pdGL.Material.prototype.drawOutline=function(e){return this.draw(e,h.LINES)},pdGL.Material.prototype.drawPoints=function(e){return this.draw(e,h.POINTS)},pdGL.Material.prototype.drawAll=function(e){return this.draw(e,pd3D.RENDER_ALL)};var M=[];function w(e,t){var i,a=e.length,r="";for(i=0;i<a;++i)e[i].vertHead&&(r+=e[i].vertHead);for(r+=pdGL.ShaderComponent.mainFunc+pdGL.ShaderComponent.position.vertMain,i=0;i<a;++i)e[i].vertMain&&(r+=e[i].vertMain);r+=pdGL.ShaderComponent.endFunc;var n="";for(i=0;i<a;++i)e[i].fragHead&&(n+=e[i].fragHead);for(n+=pdGL.ShaderComponent.mainFunc,i=0;i<a;++i)e[i].fragMain&&(n+=e[i].fragMain);if(t&&t.length)for(i=0,a=t.length;i<a;++i)t[i].fragColor&&(n+=t[i].fragColor);else for(i=0;i<a;++i)e[i].fragColor&&(n+=e[i].fragColor);return n+=pdGL.ShaderComponent.endFunc,new pdGL.Shader(r,n)}function L(e,t){this._shader.uniforms({color:t<h.TRIANGLES?e.defaultLineColor:e.defaultColor,useVertexColors:!(!e||!e.hasVertexColors)})}function D(e,t){this._shader.uniforms({useTexture:!(!this._texture||!e.coords),color:t<h.TRIANGLES?e.defaultLineColor:e.defaultColor,useVertexColors:!(!e||!e.hasVertexColors)})}pdGL.Material.pushUniform=function(e,t,i){var a={},r=e._uniforms;if(r.hasOwnProperty(t)&&r[t]!=i){if(a.material=e,a.old_value=r[t],a.old_cache=null,a.name=t,e._cachedUniforms)if(e._cachedUniforms.hasOwnProperty(t)){var n=e._cachedUniforms[t];a.old_cache={name:n.name,value:n.value,method:n.method,isMatrix:n.isMatrix,stale:n.stale}}else a.old_cache=e._shader.createCachedUniform(t,a.old_value);e.uniform(t,i)}M.push(a)},pdGL.Material.popUniform=function(){if(0<M.length){var e=M.pop(),t=e.material;t&&t._uniforms.hasOwnProperty(e.name)&&(t._uniforms[e.name]=e.old_value,t._cachedUniforms&&e.old_cache&&(t._cachedUniforms[e.name]=e.old_cache,t._rendering&&t._shader.setCachedUniformValue(e.old_cache)))}},pdGL.ShaderComponent={mainFunc:"\nvoid main() {\n",endFunc:"\n}\n",position:{vertHead:"",vertMain:"\n    gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;\n",fragHead:"",fragMain:""},POINT_SIZE_UNIFORM:{vertHead:"\nuniform float pointSize;\n",vertMain:"\n    gl_PointSize = pointSize;\n",fragHead:"",fragMain:"",checkUniforms:function(e){e.uniforms=e.uniforms||{},e.uniforms.pointSize=pd.toNumber(e.uniforms.pointSize,1)}},POINT_SIZE_ATTRIBUTE:{vertHead:"\nattribute float pointSize;\n",vertMain:"\n    gl_PointSize = pointSize;\n",fragHead:"",fragMain:""},COLOR_UNIFORM:{vertHead:"",vertMain:"",fragHead:"\nuniform vec4 color;\nuniform float opacity;\n",fragMain:"\n    float alpha = clamp(opacity * color.a, 0.0, 1.0);\n    gl_FragColor = vec4(color.rgb, alpha);\n    if (alpha < 0.001)\n        discard;\n",checkUniforms:function(e){e.uniforms=e.uniforms||{},e.uniforms.color=e.uniforms.color||[1,1,1,1],e.uniforms.opacity=pd.toNumber(e.uniforms.opacity,1)}},COLOR_ATTRIBUTE:{vertHead:"\nuniform vec4 color;\nuniform bool useVertexColors;\nvarying vec4 vColor;\n",vertMain:"\n    vColor = (useVertexColors == true) ? gl_Color : color;\n",fragHead:"\nuniform float opacity;\nvarying vec4 vColor;\n",fragMain:"\n    float alpha = clamp(opacity * vColor.a, 0.0, 1.0);\n    gl_FragColor = vec4(vColor.rgb, alpha);\n    if (alpha < 0.001)\n        discard;\n",checkUniforms:function(e){e.uniforms=e.uniforms||{},e.uniforms.color=e.uniforms.color||[1,1,1,1],e.uniforms.opacity=pd.toNumber(e.uniforms.opacity,1),e.useMeshColors=!0}},COLOR_BLINNPHONG:{vertHead:"\nuniform vec4 color;\nuniform bool useVertexColors;\nuniform vec3 sunPosition;\nvarying vec3 vNormal;\nvarying vec3 vVertex;\nvarying vec3 vLight;\nvarying vec4 vColor;\n",vertMain:"\n    vColor = (useVertexColors == true) ? gl_Color : color;\n    vec4 vtx = gl_ModelViewMatrix * gl_Vertex;\n    vVertex = vec3(vtx) / vtx.w;\n    vNormal = gl_NormalMatrix * gl_Normal;\n    vLight = sunPosition - vVertex;\n",fragHead:"\nuniform float opacity;\nuniform float shininess;\nuniform float sunIntensity;\nuniform vec3 specularColor;\nuniform vec3 ambientColor;\nvarying vec3 vNormal;\nvarying vec3 vVertex;\nvarying vec3 vLight;\nvarying vec4 vColor;\n",fragMain:"\n    float intensity = sunIntensity;\n    float specularCoefficient = 0.0;\n    vec3 normal = normalize(vNormal);\n    vec3 lightDir = normalize(vLight);\n    float alpha = clamp(opacity * vColor.a, 0.0, 1.0);\n    float diffuseCoefficient = max(0.0, dot(lightDir, normal));\n    if (diffuseCoefficient > 0.0) {\n        vec3 viewDir = normalize(-vVertex);\n        vec3 halfDir = normalize(lightDir + viewDir);\n        float specAngle = max(dot(normal, halfDir), 0.0);\n        specularCoefficient = pow(specAngle, shininess);\n    }\n\n    vec3 diffuse = (diffuseCoefficient * vColor.rgb);\n    vec3 specular = (specularCoefficient * specularColor);\n    vec3 ambient = (ambientColor * vColor.rgb);\n",fragColor:"\n    vec3 color = clamp(ambient + (intensity * (diffuse + specular)), 0.0, 1.0);\n\n    gl_FragColor = vec4(color, alpha);\n    if (alpha < 0.001) {\n        discard;\n    }\n",checkUniforms:function(e){e.uniforms=e.uniforms||{},e.uniforms.sunPosition=e.uniforms.sunPosition||[1,1,1],e.uniforms.ambientColor=e.uniforms.ambientColor||[.75,.75,.75],e.uniforms.specularColor=e.uniforms.specularColor||[.85,.85,.85],e.uniforms.sunIntensity=pd.toNumber(e.uniforms.sunIntensity,1),e.uniforms.shininess=pd.toNumber(e.uniforms.shininess,75),e.uniforms.opacity=pd.toNumber(e.uniforms.opacity,1),e.useMeshColors=!0}},SHADOW_MAP:{vertHead:"\nuniform mat4 shadowMatrix;\nvarying vec4 vCoords;\n",vertMain:"\n    vCoords = shadowMatrix * gl_Position;\n",fragHead:"\nuniform vec3 shadowColor;\nuniform sampler2D shadowMap;\nuniform float shadowOpacity;\nvarying vec4 vCoords;\n",fragMain:"\n    if (diffuseCoefficient > 0.0) {\n        if (vCoords.w > 0.0) {\n            float depth = 0.0;\n            vec2 sample = ((vCoords.xy / vCoords.w) * 0.5) + 0.5;\n            if (clamp(sample, 0.0, 1.0) == sample) {\n                float sampleDepth = texture2D(shadowMap, sample).r;\n                depth = (sampleDepth == 1.0) ? 1.0e12 : sampleDepth;\n            }\n            if (depth > 0.0) {\n                float shading = clamp(300.0 * (-0.002 + ((vCoords.z / vCoords.w) * 0.5) + 0.5 - depth), 0.0, 1.0);\n                if (length(shadowColor) > 0.01) {\n                    float mix_factor = intensity * shading * ((shadowOpacity > 0.0) ? shadowOpacity : 0.5);\n                    specular = mix(specular, shadowColor, mix_factor);\n                    diffuse = mix(diffuse, shadowColor, mix_factor);\n                    ambient = mix(ambient, shadowColor, mix_factor);\n                }\n                intensity *= (1.0 - shading);\n                if (shadowOpacity > 0.0) {\n                    alpha = max(alpha, min(shadowOpacity * shading, sunIntensity));\n                }\n            }\n        }\n    } else {\n        intensity = 0.0;\n    }\n",checkUniforms:function(e){e.uniforms=e.uniforms||{},e.uniforms.shadowColor=e.uniforms.shadowColor||[0,0,0],e.uniforms.shadowOpacity=pd.toNumber(e.uniforms.shadowOpacity,-1),e.uniforms.shadowMatrix=e.uniforms.shadowMatrix||null}},TEXTURE:{vertHead:"\nvarying vec4 vTexCoords;\n",vertMain:"\n    vTexCoords = gl_TexCoord;\n",fragHead:"\nuniform sampler2D texture;\nvarying vec4 vTexCoords;\n",fragMain:"",fragColor:"\n    gl_FragColor *= (alpha * texture2D(texture, vTexCoords.xy));\n",checkUniforms:function(e){e.useTexture=!0}}},pdGL.Material.compose=function(e,t,i){(e=e||{}).shader||(e.shader=w(t,i));for(var a=0,r=t.length;a<r;++a)t[a].checkUniforms&&t[a].checkUniforms(e);var n=new pdGL.Material(e);return e.callback?n._callbackOnDrawMesh=e.callback:e.useMeshColors&&(e.useTexture?n._callbackOnDrawMesh=D:n._callbackOnDrawMesh=L),n};var E=null;pdGL.Material.FixedColorVariablePointSize=function(e){(e=e||{}).uniforms=e.uniforms||{},e.uniforms.color=e.uniforms.color||[.5,.5,.5,1],e.name=e.name||"FixedColorVariablePointSize",e.mode=pd.toInteger(e.mode,h.POINTS),e.shader=E;var t=pdGL.Material.compose(e,[pdGL.ShaderComponent.POINT_SIZE_ATTRIBUTE,pdGL.ShaderComponent.COLOR_UNIFORM]);return E||(E=t._shader),t};var T=null;pdGL.Material.FixedColorUniformPointSize=function(e){(e=e||{}).uniforms=e.uniforms||{},e.uniforms.color=e.uniforms.color||[.2,.2,.2,1],e.name=e.name||"FixedColorUniformPointSize",e.shader=T;var t=pdGL.Material.compose(e,[pdGL.ShaderComponent.POINT_SIZE_UNIFORM,pdGL.ShaderComponent.COLOR_UNIFORM]);return T||(T=t._shader),t};var A=null;pdGL.Material.TexturedFixedColorUniformPointSize=function(e){(e=e||{}).uniforms=e.uniforms||{},e.uniforms.color=e.uniforms.color||[.2,.2,.2,1],e.name=e.name||"TexturedFixedColorUniformPointSize",e.shader=A,e.uniforms.useTexture=!0;var t=pdGL.Material.compose(e,[pdGL.ShaderComponent.COLOR_UNIFORM,pdGL.ShaderComponent.TEXTURE]);return A||(A=t._shader),t};var P=null;pdGL.Material.VariableColorUniformPointSize=function(e){(e=e||{}).uniforms=e.uniforms||{},e.uniforms.color=e.uniforms.color||[0,0,0,1],e.name=e.name||"VariableColorUniformPointSize",e.shader=P;var t=pdGL.Material.compose(e,[pdGL.ShaderComponent.POINT_SIZE_UNIFORM,pdGL.ShaderComponent.COLOR_ATTRIBUTE]);return P||(P=t._shader),t};var C=null;pdGL.Material.TexturedVariableColorUniformPointSize=function(e){(e=e||{}).uniforms=e.uniforms||{},e.uniforms.color=e.uniforms.color||[0,0,0,1],e.name=e.name||"TexturedVariableColorUniformPointSize",e.shader=C;var t=pdGL.Material.compose(e,[pdGL.ShaderComponent.COLOR_ATTRIBUTE,pdGL.ShaderComponent.TEXTURE]);return C||(C=t._shader),t};var O=null;pdGL.Material.DefaultShader=function(){return null==O&&(O=w([pdGL.ShaderComponent.COLOR_BLINNPHONG])),O},pdGL.Material.BlinnPhongColor=function(e){(e=e||{}).name=e.name||"BlinnPhongColor",e.shader=O;var t=pdGL.Material.compose(e,[pdGL.ShaderComponent.COLOR_BLINNPHONG]);return O||(O=t._shader),t};var N=null;pdGL.Material.TexturedBlinnPhongColor=function(e){(e=e||{}).name=e.name||"TexturedBlinnPhongColor",e.shader=N;var t=pdGL.Material.compose(e,[pdGL.ShaderComponent.COLOR_BLINNPHONG,pdGL.ShaderComponent.TEXTURE]);return N||(N=t._shader),t};var G=null;pdGL.Material.BlinnPhongColorShadow=function(e){(e=e||{}).name=e.name||"BlinnPhongColorShadow",e.shader=G;var t=pdGL.Material.compose(e,[pdGL.ShaderComponent.COLOR_BLINNPHONG,pdGL.ShaderComponent.SHADOW_MAP]);return G||(G=t._shader),t};pdGL.Material.TexturedBlinnPhongColorShadow=function(e){(e=e||{}).name=e.name||"TexturedBlinnPhongColorShadow",e.shader=null;var t=pdGL.Material.compose(e,[pdGL.ShaderComponent.COLOR_BLINNPHONG,pdGL.ShaderComponent.SHADOW_MAP,pdGL.ShaderComponent.TEXTURE]);return G||(G=t._shader),t};var I=null;function R(e,t,i){for(var a;null!==(a=e.exec(t));)i(a)}pdGL.Material.DepthMapShader=function(e){return(e=e||{}).name=e.name||"DepthMapShader",e.shader=(null==I&&(I=new pdGL.Shader("varying vec4 vWorldPosition;\nvoid main() {\n    gl_Position = vWorldPosition = gl_ModelViewProjectionMatrix * gl_Vertex;\n}\n","varying vec4 vWorldPosition;\nvoid main() {\n    float depth = vWorldPosition.z / vWorldPosition.w;\n    gl_FragColor = vec4(depth * 0.5 + 0.5);\n}\n")),I),new pdGL.Material(e)},pdGL.Material.BlinnPhongWithGrid=function(e){(e=e||{}).name=e.name||"BlinnPhongWithGrid"+(e.useShadowMap?"WithShadows":"");var t={vertHead:"\nvarying vec3 vNrm;\nvarying float vDist;\nvarying vec3 vPos;\n",vertMain:"\n    vNrm = gl_Normal.xyz;\n    vDist = gl_Position.w;\n    vPos = gl_Vertex.xyz;\n",fragHead:"\nuniform float modelSize;\nuniform float gridMinor;\nuniform float gridMajor;\nuniform vec4 gridColor;\n\nvarying vec3 vNrm;\nvarying float vDist;\nvarying vec3 vPos;\n\nfloat lineWidth = 0.0;\n\nfloat map(float value, float from1, float to1, float from2, float to2) {\n    float v = ((value - from1) / (to1 - from1) * (to2 - from2)) + from2;\n    return clamp(v, from2, to2);\n}\n\nfloat gridEffect(float nrm_1, float pos_1, float nrm_2, float pos_2) {\n    float grid1 = 2.5 * (1.0 - abs(nrm_1)) * (mod(pos_1, gridMinor) / lineWidth);\n    float grid2 = 2.5 * (1.0 - abs(nrm_2)) * (mod(pos_2, gridMinor) / lineWidth);\n    float grid3 = (1.0 - abs(nrm_1)) * (mod(pos_1, gridMajor) / lineWidth);\n    float grid4 = (1.0 - abs(nrm_2)) * (mod(pos_2, gridMajor) / lineWidth);\n    float g_max = min(max(grid1, grid2), max(grid3, grid4));\n    return (g_max > 0.99) ? 0.0 : clamp(1.0 - (g_max * g_max), 0.0, 1.0);\n}\n\nfloat gridFactor(in vec3 nrm, in vec3 pos) {\n    float _xy = gridEffect(nrm.x, pos.x, nrm.y, pos.y);\n    float _yz = gridEffect(nrm.y, pos.y, nrm.z, pos.z);\n    float _xz = gridEffect(nrm.x, pos.x, nrm.z, pos.z);\n    _xy = (abs(nrm.z) > 0.5) ? 0.0 : _xy;\n    _yz = (abs(nrm.x) > 0.5) ? 0.0 : _yz;\n    _xz = (abs(nrm.y) > 0.5) ? 0.0 : _xz;\n    return max(_xy, max(_yz, _xz));\n}\n",fragMain:"",fragColor:"\n    lineWidth = 0.00175 * vDist;\n    float grid_factor = gridColor.a * gridFactor(vNrm, vPos);\n    grid_factor = map(lineWidth, modelSize, 0.0, 0.0, grid_factor);\n    color = mix(color, gridColor.xyz, grid_factor);\n    gl_FragColor = vec4(color, alpha);\n",checkUniforms:function(e){e.uniforms=e.uniforms||{},e.uniforms.modelSize=e.uniforms.modelSize||1,e.uniforms.gridMajor=e.uniforms.gridMajor||1e3,e.uniforms.gridMinor=e.uniforms.gridMinor||200,pd.isArray(e.uniforms.gridColor)?e.uniforms.gridColor.length<4&&(e.uniforms.gridColor[3]=1):e.uniforms.gridColor=[0,0,0,1]}},i=[pdGL.ShaderComponent.COLOR_BLINNPHONG];return e.useShadowMap&&i.push(pdGL.ShaderComponent.SHADOW_MAP),i.push(t),pdGL.Material.compose(e,i)},pdGL.Material.RectangularBlockWithGrid=function(e){e=e||{};var t=[pdGL.ShaderComponent.COLOR_BLINNPHONG];return e.useShadowMap&&t.push(pdGL.ShaderComponent.SHADOW_MAP),t.push({vertHead:"\nvarying vec3 vNrm;\nvarying vec3 vPos;\n",vertMain:"\n    vNrm = gl_Normal.xyz;\n    vPos = gl_Vertex.xyz;\n",fragHead:"\nuniform float lineWidth;\nuniform float edgeEffect;\nuniform float gridMinor;\nuniform float gridMajor;\nuniform vec3 gridColor;\n\nvarying vec3 vNrm;\nvarying vec3 vPos;\n\nconst vec3 darkColor = vec3(0.0, 0.0, 0.0);\n\nfloat gridEffect(float nrm_1, float pos_1, float nrm_2, float pos_2) {\n    float grid1 = 2.5 * (1.0 - abs(nrm_1)) * (mod(pos_1, gridMinor) / lineWidth);\n    float grid2 = 2.5 * (1.0 - abs(nrm_2)) * (mod(pos_2, gridMinor) / lineWidth);\n    float grid3 = (1.0 - abs(nrm_1)) * (mod(pos_1, gridMajor) / lineWidth);\n    float grid4 = (1.0 - abs(nrm_2)) * (mod(pos_2, gridMajor) / lineWidth);\n    float g_max = min(max(grid1, grid2), max(grid3, grid4));\n    return (g_max > 0.95) ? 0.0 : clamp(1.0 - g_max, 0.0, 1.0);\n}\n\nfloat gridFactor(in vec3 nrm, in vec3 pos) {\n    float _xy = gridEffect(nrm.x, pos.x, nrm.y, pos.y);\n    float _yz = gridEffect(nrm.y, pos.y, nrm.z, pos.z);\n    float _xz = gridEffect(nrm.x, pos.x, nrm.z, pos.z);\n    _xy = (abs(nrm.z) > 0.5) ? 0.0 : _xy;\n    _yz = (abs(nrm.x) > 0.5) ? 0.0 : _yz;\n    _xz = (abs(nrm.y) > 0.5) ? 0.0 : _xz;\n    return max(_xy, max(_yz, _xz));\n}\n",fragMain:"\n    float darken = 0.0;\n    if ((abs(vNrm.z) < 0.5) || (abs(vPos.z) > edgeEffect)) {\n        darken = 1.0 - clamp(vPos.z / edgeEffect, 0.0, 1.0);\n    }\n",fragColor:"\n    color = mix(color, darkColor, 0.35 * (1.0 - (0.5 * ambientColor)) * darken * darken);\n    float grid_factor = (lineWidth > 1e-3) ? 0.35 * gridFactor(vNrm, vPos) : 0.0;\n    color = mix(color, gridColor, grid_factor);\n    gl_FragColor = vec4(color, alpha);\n",checkUniforms:function(e){e.uniforms=e.uniforms||{},e.uniforms.lineWidth=e.uniforms.lineWidth||1,e.uniforms.edgeEffect=e.uniforms.edgeEffect||1e3,e.uniforms.gridColor=e.uniforms.gridColor||[0,0,0],e.uniforms.gridMajor=e.uniforms.gridMajor||1e3,e.uniforms.gridMinor=e.uniforms.gridMinor||200}}),pdGL.Material.compose(e,t)},pd3D.Node.prototype.drawWithMaterial=function(e,t){if(this.visible&&e){for(var i in this.callbackOnDraw&&this.callbackOnDraw(this,t,e),this.transformMatrix&&(h.pushMatrix(),h.multMatrix(this.transformMatrix),e._rendering&&e._shader.prepareMatrices()),this.geometry)this.geometry.hasOwnProperty(i)&&e.renderMeshes(this.geometry[i].meshes,t);for(var a,r=0,n=this.children.length;r<n;++r)(a=this.children[r])&&a.drawWithMaterial&&a.drawWithMaterial(e,t);this.transformMatrix&&h.popMatrix()}return this},pd3D.Node.prototype._render=function(e){for(var t in this.callbackOnDraw&&this.callbackOnDraw(this,e),this.transformMatrix&&(h.pushMatrix(),h.multMatrix(this.transformMatrix)),this.geometry)if(this.geometry.hasOwnProperty(t)){var i=this.geometry[t];i.material.draw(i.meshes,e)}for(var a,r=0,n=this.children.length;r<n;++r)(a=this.children[r])&&a.draw&&a.draw(e);return this.transformMatrix&&h.popMatrix(),this},pd3D.Node.prototype.drawOutlines=function(e){return e?this.drawWithMaterial(e,h.LINES):this.visible&&this._render(h.LINES),this},pd3D.Node.prototype.drawSurfaces=function(e){return e?this.drawWithMaterial(e,h.TRIANGLES):this.visible&&this._render(h.TRIANGLES),this},pd3D.Node.prototype.draw=function(e){return this.visible&&this._render(e),this},pdGL.CachedUniform=function(e){e=e||{},this.name=e.name||"",this.value=e.value||null,this.method=e.method||null,this.isMatrix=pd.toBoolean(e.isMatrix,!1),this.stale=pd.toBoolean(e.stale,!0)},pdGL.CachedUniform.createOrUpdate=function(e,t,i){if(i||(i=new pdGL.CachedUniform),i.stale=!0,i.name=e,t instanceof pd3D.Vector?t=[t.x,t.y,t.z]:t instanceof pd3D.Matrix&&(t=t.m),s(t))switch(t.length){case 1:i.method=h.uniform1fv,i.value=new Float32Array(t);break;case 2:i.method=h.uniform2fv,i.value=new Float32Array(t);break;case 3:i.method=h.uniform3fv,i.value=new Float32Array(t);break;case 4:i.method=h.uniform4fv,i.value=new Float32Array(t);break;case 9:i.isMatrix=!0,i.method=h.uniformMatrix3fv,i.value=new Float32Array([t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]]);break;case 16:i.isMatrix=!0,i.method=h.uniformMatrix4fv,i.value=new Float32Array([t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]]);break;default:throw'Cannot pre-process uniform "'+e+'" of length '+t.length}else if("boolean"==typeof t)i.method=h.uniform1i,i.value=!0===t?1:0;else{if(!pd.isNumeric(t))throw'Attempted to set uniform "'+e+'" to invalid value '+t;i.method=h.uniform1f,i.value=t}return i},pdGL.CachedUniform.createOrUpdateTexture=function(e,t,i){return i||(i=new pdGL.CachedUniform),i.name=e,i.value=pd.toInteger(t,1),i.method=h.uniform1i,i.isMatrix=!1,i.stale=!0,i};var k="pd_web",V=-1;pdGL.Shader=function(e,t){var a=this;function i(e){if(!/\s/.test(e)){var t=document.getElementById(e);return t?t.text:e}return e}e=i(e),t=i(t);var r="uniform mat3 gl_NormalMatrix;\nuniform mat4 gl_ModelViewMatrix;\nuniform mat4 gl_ProjectionMatrix;\nuniform mat4 gl_ModelViewProjectionMatrix;\nuniform mat4 gl_ModelViewMatrixInverse;\nuniform mat4 gl_ProjectionMatrixInverse;\nuniform mat4 gl_ModelViewProjectionMatrixInverse;\n";this.usedMatrices={};var n=e+t;function s(e,t){var i={},a=/^((\s*\/\/.*\n|\s*#extension.*\n)+)\^*$/.exec(t);return t=a?a[1]+e+t.substr(a[1].length):e+t,R(/\bgl_\w+\b/g,e,function(e){e in i||(t=t.replace(new RegExp("\\b"+e+"\\b","g"),k+e),i[e]=!0)}),t}function o(e,t){var i=h.createShader(e);if(h.shaderSource(i,t),h.compileShader(i),!h.getShaderParameter(i,h.COMPILE_STATUS))throw new Error("compile error: "+h.getShaderInfoLog(i));return i}if(R(/\b(gl_[^;]*)\b;/g,r,function(e){var t=e[1];if(-1!=n.indexOf(t)){var i=t.replace(/[a-z_]/g,"");a.usedMatrices[i]=k+t}}),e=s("uniform mat3 gl_NormalMatrix;\nuniform mat4 gl_ModelViewMatrix;\nuniform mat4 gl_ProjectionMatrix;\nuniform mat4 gl_ModelViewProjectionMatrix;\nuniform mat4 gl_ModelViewMatrixInverse;\nuniform mat4 gl_ProjectionMatrixInverse;\nuniform mat4 gl_ModelViewProjectionMatrixInverse;\nattribute vec4 gl_Vertex;\nattribute vec4 gl_TexCoord;\nattribute vec3 gl_Normal;\nattribute vec4 gl_Color;\n",e),t=s("precision highp float;\nuniform mat3 gl_NormalMatrix;\nuniform mat4 gl_ModelViewMatrix;\nuniform mat4 gl_ProjectionMatrix;\nuniform mat4 gl_ModelViewProjectionMatrix;\nuniform mat4 gl_ModelViewMatrixInverse;\nuniform mat4 gl_ProjectionMatrixInverse;\nuniform mat4 gl_ModelViewProjectionMatrixInverse;\n",t),this.attributes={},this.uniformLocations={},this.program=h.createProgram(),h.attachShader(this.program,o(h.VERTEX_SHADER,e)),h.attachShader(this.program,o(h.FRAGMENT_SHADER,t)),h.bindAttribLocation(this.program,0,k+"gl_Vertex"),this.attributes.gl_Vertex=0,h.linkProgram(this.program),!h.getProgramParameter(this.program,h.LINK_STATUS))throw"link error: "+h.getProgramInfoLog(this.program);this.isSampler={},R(/uniform\s+sampler(1D|2D|3D|Cube)\s+(\w+)\s*;/g,e+t,function(e){a.isSampler[e[2]]=1})},pdGL.Shader.prototype={makeCurrent:function(){return V!=this.program&&(V=this.program,h.useProgram(this.program)),this},createCachedUniform:function(e,t,i){return pd.isInteger(t)&&this.isSampler[e]?pdGL.CachedUniform.createOrUpdateTexture(e,t,i):pdGL.CachedUniform.createOrUpdate(e,t,i)},setCachedUniformValue:function(e){var t=e.name,i=this.uniformLocations[t];return i||(i=h.getUniformLocation(this.program,t),this.uniformLocations[t]=i),i&&(e.isMatrix?e.method.call(h,i,!1,e.value):e.method.call(h,i,e.value)),e.stale=!1,this},setCachedUniformValues:function(e){for(var t in this.makeCurrent(),e)this.setCachedUniformValue(e[t]);return this},uniforms:function(e){for(var t in this.makeCurrent(),e){var i=this.uniformLocations[t];if(i||(i=h.getUniformLocation(this.program,t),this.uniformLocations[t]=i),i){var a=e[t];if("function"==typeof a&&(a=a()),a instanceof pd3D.Vector?a=[a.x,a.y,a.z]:a instanceof pd3D.Matrix&&(a=a.m),s(a))switch(a.length){case 1:h.uniform1fv(i,new Float32Array(a));break;case 2:h.uniform2fv(i,new Float32Array(a));break;case 3:h.uniform3fv(i,new Float32Array(a));break;case 4:h.uniform4fv(i,new Float32Array(a));break;case 9:h.uniformMatrix3fv(i,!1,new Float32Array([a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]]));break;case 16:h.uniformMatrix4fv(i,!1,new Float32Array([a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]));break;default:throw"don't know how to load array uniform \""+t+'" of length '+a.length}else if("boolean"==typeof a)h.uniform1i(i,!0===a?1:0);else{if(r=a,void 0,"[object Number]"!=(n=Object.prototype.toString.call(r))&&"[object Boolean]"!=n)throw'attempted to set uniform "'+t+'" to invalid value '+a;(this.isSampler[t]?h.uniform1i:h.uniform1f).call(h,i,a)}}}var r,n;return this},prepareMatrices:function(){this.makeCurrent();var e={},t=this.usedMatrices;if(t.MVM&&(e[t.MVM]=h.modelviewMatrix),(t.MVMI||t.NM)&&(e[t.MVMI]=h.modelviewMatrix.inverse()),t.PM&&(e[t.PM]=h.projectionMatrix),t.PMI&&(e[t.PMI]=h.projectionMatrix.inverse()),t.MVPM&&(e[t.MVPM]=h.getModelviewProjectionMatrix()),t.MVPMI&&(e[t.MVPMI]=h.getModelviewProjectionMatrix().inverse()),t.NM){var i=e[t.MVMI].m;e[t.NM]=[i[0],i[4],i[8],i[1],i[5],i[9],i[2],i[6],i[10]]}for(var a in this.lastFrameIndex=h.frameIndex,e){var r,n=this.uniformLocations[a];n||(n=h.getUniformLocation(this.program,a),this.uniformLocations[a]=n),n&&((r=e[a])instanceof pd3D.Matrix&&(r=r.m),r&&(9==r.length?h.uniformMatrix3fv(n,!1,new Float32Array([r[0],r[3],r[6],r[1],r[4],r[7],r[2],r[5],r[8]])):16==r.length&&h.uniformMatrix4fv(n,!1,new Float32Array([r[0],r[4],r[8],r[12],r[1],r[5],r[9],r[13],r[2],r[6],r[10],r[14],r[3],r[7],r[11],r[15]]))))}return this},prepareAttributes:function(e){var t,i=0;for(var a in e){var r=e[a],n=this.attributes[a];(null==n||n<0)&&(n=h.getAttribLocation(this.program,a.replace(/^(gl_.*)$/,k+"$1"))),0<=n&&r.buffer&&(this.attributes[a]=n,h.bindBuffer(h.ARRAY_BUFFER,r.buffer),h.enableVertexAttribArray(n),h.vertexAttribPointer(n,r.spacing,h.FLOAT,!1,0,0),i<(t=r.length/r.spacing)&&(i=t))}for(var a in this.attributes)a in e||0==this.attributes[a]||h.disableVertexAttribArray(this.attributes[a]);return i},renderPrimitive:function(e,t,i){var a=this.prepareAttributes(e);return 0<a&&(!t||t.buffer)&&(t&&t.buffer?(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,t.buffer),h.drawElements(i,t.length,h.UNSIGNED_SHORT,0)):h.drawArrays(i,0,a)),this},draw:function(e,t){return e&&e.visible&&(e.checkToCompile(),this.prepareMatrices(),t=pd.toInteger(t,h.TRIANGLES),this.renderPrimitive(e.vertexBuffers,e.indexBuffers[pdGL.Shader.getIndexBufferName(t)],t)),this},drawModes:function(e,t){var i,a,r;if(e&&e.visible)if(e.checkToCompile(),this.prepareMatrices(),t===pd3D.RENDER_ALL&&(t=c),pd.isArray(t))for(var n=0;n<t.length;++n)i=S(t[n],h.TRIANGLES),a=pdGL.Shader.getIndexBufferName(i),(r=e.indexBuffers[a])&&r.length&&this.renderPrimitive(e.vertexBuffers,r,i);else i=S(t,h.TRIANGLES),a=pdGL.Shader.getIndexBufferName(i),(r=e.indexBuffers[a])&&r.length&&this.renderPrimitive(e.vertexBuffers,r,i);return this},destroy:function(){if(this.program){for(var e=h.getAttachedShaders(this.program),t=0,i=e.length;t<i;++t)h.detachShader(this.program,e[t]),h.deleteShader(e[t]);h.deleteProgram(this.program)}return this}},pdGL.Shader.getIndexBufferName=function(e){switch(e=pd.toInteger(e,h.TRIANGLES)){case h.POINTS:return"points";case h.LINES:case h.LINE_LOOP:case h.LINE_STRIP:return"lines";case h.TRIANGLES:case h.TRIANGLE_STRIP:case h.TRIANGLE_FAN:return"triangles";default:return"index"}},pdGL.Shader.fromURL=function(e,t){var i=function(e){var t=new XMLHttpRequest;if(t.open("GET",e,!1),t.send(null),200!==t.status)throw"could not load "+e;return t.responseText},a=i(e),r=i(t);return new pdGL.Shader(a,r)},pdGL.Shader.from=function(t,i){try{return new pdGL.Shader(t,i)}catch(e){return pdGL.Shader.fromURL(t,i)}}}(),function(){var d=pd3D.VectorArray;function r(e,t){gl.setCullFaceDefault(!1),gl.clearColor(1,1,1,1),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),function e(t,i,a){if(t&&t.visible&&a&&!1!==t.castShadows){for(var r in t.callbackOnDraw&&t.callbackOnDraw(t,i,a),this.transformMatrix&&(gl.pushMatrix(),gl.multMatrix(this.transformMatrix),a._rendering&&a._shader.prepareMatrices()),t.geometry)t.geometry.hasOwnProperty(r)&&a.renderMeshes(t.geometry[r].meshes,i);for(var n,s=0,o=t.children.length;s<o;++s)null!=(n=t.children[s])&&e(n,i,a);t.transformMatrix&&gl.popMatrix()}}(e,gl.TRIANGLES,t),gl.setCullFaceDefault(!0)}pdGL.PHASE={SHADOWS:1,BACKGROUND:2,SILHOUETTE:3,OUTLINES:4,OUTLINES_MESH:5,RENDER_FIRST:6,GROUND_GRID:7,SURFACES:8,RENDER_LAST:9,RENDER_OVERLAY:10,HUD:11},pdGL.Environment=function(e){e=e||{},this.outlineOpacity=pd.toNumber(e.outlineOpacity,.5),this.outlineWidth=pd.toNumber(e.outlineWidth,gl.getCanvasLineWidthThin()),this.outlineColor=e.outlineColor||[0,0,0,1],this.outlineMaterial=e.outlineMaterial||pdGL.Material.FixedColorUniformPointSize({name:"Scene3D.outlineMaterial"}).uniform("color",this.outlineColor),this.meshColorMaterial=e.meshColorMaterial||pdGL.Material.VariableColorUniformPointSize({name:"Scene3D.meshColorMaterial"}),this.specularFactor=pd.toNumber(e.specularFactor,.75),this.ambientFactor=pd.toNumber(e.ambientFactor,.75),this.surfaceOpacity=pd.toNumber(e.surfaceOpacity,1),this.surfaceShininess=pd.toNumber(e.surfaceShininess,75),this.surfaceMaterial=e.surfaceMaterial?e.surfaceMaterial:e.shadowMap||e.shadows?pdGL.Material.BlinnPhongColorShadow({name:"Scene3D.surfaceMaterialShadow"}):pdGL.Material.BlinnPhongColor({name:"Scene3D.surfaceMaterial"}),this.backgroundColor=e.backgroundColor||[.702,.82,1,1],this.backgroundColor.length<4&&(this.backgroundColor[3]=1),this.sunDirection=e.sunDirection||new pd3D.Vector(1,1,1).normalize(),this.sunPosition=e.sunPosition||new pd3D.Vector,this.projectedSunPosition=e.projectedSunPosition||new pd3D.Vector,this.skyModel=e.skyModel||null,this.shadowMap=e.shadowMap||null,this.shadowMatrix=e.shadowMatrix||null,this.shadowMatrixProjected=null,this.depthMapMaterial=e.depthMapMaterial||null,this.updateShadows=null!=this.shadowMap,this.showGroundPlane=pd.toBoolean(e.showGroundPlane,!0),this.groundPlaneOpacity=pd.toNumber(e.groundPlaneOpacity,.25),this.groundPlaneColor=e.groundPlaneColor||null,this.groundPlaneColor||(this.groundPlaneColor=this.backgroundColor.slice(),this.groundPlaneColor[3]=.25),pd.isNumeric(e.groundPlaneOpacity)&&(this.groundPlaneColor[3]=pd.constrainTo(this.groundPlaneOpacity,0,1)),this.showGroundGrid=pd.toBoolean(e.showGroundGrid,!0),this.groundGridMajorColor=e.groundGridMajorColor||[0,.3,.6,1],this.groundGridMinorColor=e.groundGridMinorColor||[.2,.4,.8,.55],this.groundGridCenter=e.groundGridCenter||d.create(),this.groundGridLevel=pd.toNumber(e.groundGridLevel,null),this._groundGridSizeMajor=1e3,this._groundGridSizeMinor=200,this._groundMesh=null,this._skyBrightness=1,this._shareDynamicUniformsList=[],this._cachedUniforms={},this.shareDynamicUniforms(this.surfaceMaterial),e=null},pdGL.Environment.prototype.updateDynamicShading=function(e){var t=!1;if(this.hasOwnShadowMap&&this.shadowMap&&(this.updateShadows||!this.shadowMatrix)){var i=e.nodes[pdGL.PHASE.SHADOWS]||e;if(i&&0<=this.sunDirection.z){var a=this;!i.hasChanged&&i.boundingBox||(i.boundingBox=i.getAABB(i.boundingBox),i.hasChanged=!1),pdGL.Environment.fitViewToBoundingBox(this.sunDirection,i.boundingBox,100*e.modelSize),this.shadowMatrix=pd3D.Matrix.multiply(gl.projectionMatrix,gl.modelviewMatrix,this.shadowMatrix),this.shadowMap.drawTo(function(){r(i,a.depthMapMaterial)}),t=!0}}return this.updateShadows&&(this.sunPosition=pd3D.Vector.multiply(this.sunDirection,100*e.modelSize,this.sunPosition),this.updateShadows=!1),t},pdGL.Environment.prototype.updateDynamicSky=function(){var e,t,i,a=this.surfaceMaterial._shader,r=this._cachedUniforms,n=this.ambientFactor,s=this.sunDirection.z,o=.10452846<s?1:0<s?pd.mapAndConstrainTo(s,0,.10452846,.5,1):pd.mapAndConstrainTo(s,-.30901699,0,0,.5);if(this.skyModel&&this.shadowMap){var l=this.skyModel.directBeamIlluminance+1;n=l<1e3?pd.mapAndConstrainTo(l,0,1e3,1,.85):pd.mapAndConstrainTo(l,1e3,65e3,.85,.25),o*=pd.mapAndConstrainTo(l,0,65e3,.85,1.1)}return gl.clearColor(o*this.backgroundColor[0],o*this.backgroundColor[1],o*this.backgroundColor[2],this.backgroundColor[3]),t=this.specularFactor*o,r[i="specularColor"]?((e=r[i].value)[0]=t,e[1]=t,e[2]=t):(e=r[i]=a.createCachedUniform(i,[t,t,t])).shared=!0,t=n*o,r[i="ambientColor"]?((e=r[i].value)[0]=t,e[1]=t,e[2]=t):(e=r[i]=a.createCachedUniform(i,[t,t,t])).shared=!0,t=this.surfaceShininess,r[i="shininess"]?r[i].value=t:(e=r[i]=a.createCachedUniform(i,t)).shared=!0,t=o*(1-n)*pd.mapAndConstrainTo(s,0,.10471975512,0,2),r[i="sunIntensity"]?r[i].value=t:(e=r[i]=a.createCachedUniform(i,t)).shared=!0,this._skyBrightness=o,this},pdGL.Environment.prototype.updateDynamicUniforms=function(){var e,t,i=this.surfaceMaterial._shader,a=this._cachedUniforms;if(this.projectedSunPosition=gl.modelviewMatrix.transformPoint(this.sunPosition,this.projectedSunPosition),a[t="sunPosition"]?((e=a[t].value)[0]=this.projectedSunPosition.x,e[1]=this.projectedSunPosition.y,e[2]=this.projectedSunPosition.z):(e=a[t]=i.createCachedUniform(t,this.projectedSunPosition)).shared=!0,this.shadowMap&&this.shadowMatrix){var r=gl.getModelviewProjectionMatrix().inverse();this.shadowMatrixProjected=pd3D.Matrix.multiply(this.shadowMatrix,r,this.shadowMatrixProjected),a[t="shadowMatrix"]?this.shadowMatrixProjected.copyToColumnMajorArray(a[t].value):(e=a[t]=i.createCachedUniform(t,this.shadowMatrixProjected)).shared=!0}a[t="opacity"]?a[t].value=this.surfaceOpacity:(e=a[t]=i.createCachedUniform(t,this.surfaceOpacity)).shared=!0,this.meshColorMaterial.uniform("opacity",this.outlineOpacity),this.outlineMaterial.uniform("opacity",this.outlineOpacity)},pdGL.Environment.prototype.shareDynamicUniforms=function(e){if(1==arguments.length){if(!(e instanceof pdGL.Material))throw new Error("Only pdGL.Material objects can share an environment's dynamic uniforms.");this._shareDynamicUniformsList.indexOf(e)<0&&this._shareDynamicUniformsList.push(e)}else if(this._shareDynamicUniformsList.length){for(var t=0,i=this._shareDynamicUniformsList.length;t<i;++t)this._shareDynamicUniformsList[t].setCachedUniforms(this._cachedUniforms);this._shareDynamicUniformsList.length=0}return this},pdGL.Environment.prototype.updateViewChange=function(){},pdGL.Environment.prototype.calculateGridSizeAndCenter=function(e){if(e&&(this.showGroundGrid||this.showGroundPlane)){var t=pd.Dimension.type==pd.DimensionType.IMPERIAL,i=1,a=.2,r=e.preferredGroundGridSize;if(r<.001*e.modelSize||r>.499*e.modelSize){var n=Math.log10(e.modelSize),s=n<0?Math.ceil(n):Math.floor(n),o=Math.pow(10,s),l=n-s;t?(o*=.3048,a=l<.397940008672038?(i=.5*o)/5:l<.698970004336019?(i=1*o)/6:(i=3*o)/6):l<.397940008672038?(i=.25*o,a=.05*o):l<.698970004336019?(i=.5*o,a=.1*o):(i=1*o,a=.2*o)}else a=(i=r)/(t?3:5);gl.orbitalView&&0<gl.orbitalView.snapGrid?(this._groundGridSizeMinor=pd.snapTo(a,gl.orbitalView.snapGrid),this._groundGridSizeMajor=pd.snapTo(i,this._groundGridSizeMinor)):(this._groundGridSizeMajor=i,this._groundGridSizeMinor=a),d.set(this.groundGridCenter,pd.snapTo(e.modelCenter.x,i),pd.snapTo(e.modelCenter.y,i),pd.toNumber(this.groundGridLevel,e.boundingBox.min.z))}},pdGL.Environment.prototype.updateGroundPlane=function(e){if(e&&(this.showGroundGrid||this.showGroundPlane)){this.calculateGridSizeAndCenter(e);var t=this._groundGridSizeMajor,i=this._groundGridSizeMinor,a=Math.max(1,e.modelSize/t),r=(Math.ceil(1.4*a)+.001)/a;this._groundMesh||(this._groundMesh=new pd3D.Mesh({triangles:!0,normals:!0,colors:!0,lines:!0,twoSided:!1}));var n=this._groundMesh;if(n.reuseStart(),n.normal([0,0,1]),n.color(this.groundPlaneColor,this.groundPlaneOpacity),n.addVertex([-r,-r,0]),n.addVertex([r,-r,0]),n.addVertex([r,r,0]),n.addVertex([-r,r,0]),n.addTriangle(0,1,2),n.addTriangle(0,2,3),n.normal([0,0,-1]),n.color([.5*this.groundPlaneColor[0],.5*this.groundPlaneColor[1],.5*this.groundPlaneColor[2],.85]),n.addVertex([-r,-r,0]),n.addVertex([r,-r,0]),n.addVertex([r,r,0]),n.addVertex([-r,r,0]),n.addTriangle(4,6,5),n.addTriangle(4,7,6),this.showGroundGrid){var s=1/a;n.color(this.groundGridMajorColor),n.normal([0,0,1]);for(var o=0;o<=r;o+=s)n.addLine(n.addVertex([o,-r,0]),n.addVertex([o,r,0])),n.addLine(n.addVertex([-r,o,0]),n.addVertex([r,o,0])),0<o&&(n.addLine(n.addVertex([-o,-r,0]),n.addVertex([-o,r,0])),n.addLine(n.addVertex([-r,-o,0]),n.addVertex([r,-o,0])));(s=i/e.modelSize)<.01&&(s=.2/a),n.color(this.groundGridMinorColor);for(o=0;o<=r;o+=s)n.addLine(n.addVertex([o,-r,0]),n.addVertex([o,r,0])),n.addLine(n.addVertex([-o,-r,0]),n.addVertex([-o,r,0])),n.addLine(n.addVertex([-r,o,0]),n.addVertex([r,o,0])),n.addLine(n.addVertex([-r,-o,0]),n.addVertex([r,-o,0]))}n.reuseEnd(),n.compile()}return this},pdGL.Environment.prototype.renderGroundPlane=function(e,t){if(e&&(this.showGroundGrid||this.showGroundPlane)){this._groundMesh||this.updateGroundPlane(e);var i=e.modelSize,a=this.groundGridCenter,r=this._groundMesh;gl.pushMatrix(),gl.depthMask(!1),gl.translate(a[0],a[1],a[2]-(t?.001*i:0)),gl.scale(i,i,1),this.showGroundPlane&&1e-6<this.groundPlaneOpacity&&(r.twoSided=t,e.environment.surfaceMaterial.pushUniform("shadowOpacity",pd.mapAndConstrainTo(this.surfaceOpacity,0,1,.5,.75)).renderSurfaces(r).endRender().popUniform()),this.showGroundGrid&&e.environment.meshColorMaterial.pushUniform("opacity",pd.mapAndConstrainTo(this.groundPlaneOpacity*this.surfaceOpacity,0,1,.2,.6)).renderOutlines(r).endRender().popUniform(),gl.depthMask(!0),gl.popMatrix()}return this},pdGL.Environment.fitViewToBoundingBox=function(e,t,i){for(var a=e.multiply(i),r=t.min.add(t.max).divide(2),n=r.subtract(a).unit(),s=n.cross(new pd3D.Vector(0,1,0)).unit(),o=s.cross(n),l=Number.MAX_VALUE,d=-Number.MAX_VALUE,h=0,c=0,p=0,u=0,g=0;g<8;++g){var m=pd3D.Vector.lerp(t.min,t.max,new pd3D.Vector(!!(1&g),!!(2&g),!!(4&g))).subtract(a),f=m.dot(n),v=m.dot(s)/f,_=m.dot(o)/f;h=Math.min(h,v),p=Math.min(p,_),c=Math.max(c,v),u=Math.max(u,_),l=Math.min(l,f),d=Math.max(d,f)}l*=.999,d*=1.001,gl.matrixMode(gl.PROJECTION),gl.loadIdentity(),gl.frustum(h*l,c*l,p*l,u*l,l,d),gl.matrixMode(gl.MODELVIEW),gl.loadIdentity(),gl.lookAt(a.x,a.y,a.z,r.x,r.y,r.z,0,1,0)};var i=null;pdGL.Scene3D=function(e,t){t=t||{},pd3D.Node.call(this,e,"Scene"),this.active=!1,this.nodes=[],this.nodes[pdGL.PHASE.SHADOWS]=null,this.nodes[pdGL.PHASE.BACKGROUND]=null,this.nodes[pdGL.PHASE.SILHOUETTE]=null,this.nodes[pdGL.PHASE.OUTLINES_MESH]=null,this.nodes[pdGL.PHASE.OUTLINES]=null,this.nodes[pdGL.PHASE.RENDER_FIRST]=null,this.nodes[pdGL.PHASE.GROUND_GRID]=null,(this.nodes[pdGL.PHASE.SURFACES]=this).nodes[pdGL.PHASE.RENDER_LAST]=null,this.nodes[pdGL.PHASE.RENDER_OVERLAY]=null,this.nodes[pdGL.PHASE.HUD]=null,this.environment=t.environment||new pdGL.Environment(t),t.useOwnView&&(this._previousOrbitalView=gl.orbitalView,this.orbitalView=new pdGL.OrbitalView(t),this.useOwnView=!0),this.boundingBox=t.boundingBox||null,this._aabbList=[],this.selectRadius=pd.toNumber(t.selectRadius,20),this.modelSize=1,this.defaultZoom=pd.toNumber(t.defaultZoom,1),this.modelUnit=.01,this.modelCenter=t.modelCenter||new pd3D.Vector(0,0,0),this.preferredModelSnap=pd.toNumber(t.preferredModelSnap,0),this.preferredGroundGridSize=pd.toNumber(t.preferredGroundGridSize,0),this.hotspots=[],this.hoveredHotspotIndex=-1,this.activeHotspotIndex=-1,this.activeHotspot=null,this._preSelectedHotspot=null,this.dimensionManager=t.dimensionManager||null,this.handleRenderGroundPlane=t.handleRenderGroundPlane||null,this.handleUpdateDynamicShading=t.handleUpdateDynamicShading||null,this.handleUpdateDynamicUniforms=t.handleUpdateDynamicUniforms||null,this.handleUpdateDynamicSky=t.handleUpdateDynamicSky||null,this.callbackOnSelectHotspot=t.callbackOnSelectHotspot||null,this.callbackOnDraw=t.callbackOnDraw||null,this.ignoreSelection=t.ignoreSelection||!1,this.useImprovedTransparency=t.useImprovedTransparency||!1,this._activeSelectionType=0,pd.addSimpleEventHandling(this),t=null},pdGL.Scene3D.prototype=Object.create(pd3D.Node.prototype),pdGL.Scene3D.prototype.constructor=pdGL.Scene3D;var n=[.85,.85,.85,1];pdGL.Scene3D.prototype.createShadowMap=function(e,t){var i=this.environment;if(t=t||gl.RGB,e=pd.constrainTo(pd.toInteger(e,1024),8,4096),i.shadowMap=new pdGL.Texture(e,e,{format:t}),!("shadowMatrix"in i.surfaceMaterial._uniforms)){var a=pdGL.Material.BlinnPhongColorShadow({name:"Scene3D.surfaceMaterialShadow"});a.uniform("color",n),this.swapMaterials(i.surfaceMaterial,a),this.emit("shadowMaterialChanged",i.surfaceMaterial,a),i.shareDynamicUniforms(a),i.surfaceMaterial=a}return i.depthMapMaterial||(i.depthMapMaterial=pdGL.Material.DepthMapShader({name:"Scene3D.depthMapMaterial"})),i.hasOwnShadowMap=!0,i.updateShadows=!0,this},pdGL.Scene3D.prototype.clearShadowMap=function(){var e=this.environment;if(e.hasOwnShadowMap&&e.shadowMap&&"shadowMatrix"in e.surfaceMaterial._uniforms){var t=pdGL.Material.BlinnPhongColor({name:"Scene3D.surfaceMaterial"});t.uniform("color",n),this.swapMaterials(e.surfaceMaterial,t),e.shareDynamicUniforms(t),e.surfaceMaterial=t}return e.shadowMap=null,e.hasOwnShadowMap=!1,e.updateShadows=!1,this},pdGL.Scene3D.prototype.getSurfaceMaterial=function(){return this.environment.surfaceMaterial},pdGL.Scene3D.prototype.getOutlineMaterial=function(){return this.environment.outlineMaterial},pdGL.Scene3D.prototype.getMeshColorMaterial=function(){return this.environment.meshColorMaterial},pdGL.Scene3D.prototype.getModelSnap=function(e){return(e=e||0)<.01*this.modelUnit||e>10*this.modelUnit?pd.Dimension.type==pd.DimensionType.IMPERIAL?this.modelSize<1e3?1.5875:this.modelSize<2500?6.35:this.modelSize<1e5?25.4:this.modelSize<25e4?304.8:914.4:this.modelSize<100?.1:this.modelSize<1e3?1:this.modelSize<2500?5:this.modelSize<5e3?10:this.modelSize<5e4?50:this.modelSize<15e4?100:this.modelSize<25e4?500:1e3:e},pdGL.Scene3D.prototype.setModelSnap=function(e){return gl.orbitalView&&(gl.orbitalView.snapGrid=this.getModelSnap(e)),this.preferredModelSnap=e,this},pdGL.Scene3D.prototype.cancelPreSelection=function(){if(null!=this._preSelectedHotspot){var e=this._preSelectedHotspot;this._activeSelectionType=0,this._preSelectedHotspot=null,e&&e._preSelected&&(e.cancelPreSelection(),pd.isNumeric(e._preSelectedBoxIndex)&&(e._preSelectedBoxIndex=-1)),gl.update()}return this.activeHotspot&&this.activeHotspot.isPreSelected()&&(this.activeHotspot._preSelectedBoxIndex=this.activeHotspot.selectedBoxIndex,gl.update()),this};var l=0;pdGL.Scene3D.prototype.handlePointerMove=function(e){var t=e.x,i=e.y,a=0;if(this.dimensionManager&&this.dimensionManager.visible&&this.dimensionManager.active&&this.dimensionManager.isOver(t,i,this.selectRadius)&&(a=1),!a&&0<this.hotspots.length){for(var r=null,n=-1,s=0,o=this.hotspots.length;s<o;++s)if((r=this.hotspots[s]).active&&r.isOver(t,i,this.selectRadius)){n=s,a=1;break}this.setHoveredHotspotByIndex(n)}return l!=a&&(gl.canvas.style.cursor=0<a?"pointer":"inherit",l=a),!1},pdGL.Scene3D.prototype.handlePointerDown=function(e){if(0==e.button){if(e.isTouchEvent?pdGL.Hotspot3D.selectRadiusModifier=1:pdGL.Hotspot3D.selectRadiusModifier=.6,this._activeSelectionType=0,this.activeHotspot&&this.activeHotspot.visible&&this.activeHotspot.active&&this.activeHotspot.handleSelectEvent(e,!0,this.ignoreSelection))return this._activeSelectionType=1,!0;if(this.dimensionManager){var t=e.x,i=e.y;if(this.dimensionManager.visible&&this.dimensionManager.active&&this.dimensionManager.isOver(t,i,this.selectRadius))return this._activeSelectionType=2,!0}if(!this.ignoreSelection){for(var a=0,r=this.hotspots.length;a<r;++a)if(a!=this.activeHotspotIndex&&this.hotspots[a].handleSelectEvent(e,!1)){var n=this.hotspots[a];return this._preSelectedHotspot=n,this._activeSelectionType=3,n._preSelected=!0,n._selected=!1,gl.update(),!0}return!(this._preSelectedHotspot=null)}}return!1},pdGL.Scene3D.prototype.handlePointerDrag=function(e){if(!this.ignoreSelection){if(null!=this._preSelectedHotspot||this.activeHotspot&&this.activeHotspot.isPreSelected())return pdDOM.Interaction.hasMoved()&&(this.cancelPreSelection(),null!=pdGL.Hotspot3D&&pdGL.Hotspot3D.captureEvent(!1)),!0;if(2==this._activeSelectionType){if(!pdDOM.Interaction.hasMoved())return!0;this._activeSelectionType=0}if(0==e.button&&this.activeHotspot)return!pdDOM.Interaction.hasMoved()||this.activeHotspot.handleDragEvent(e)}return!1},pdGL.Scene3D.prototype.handlePointerUp=function(e){if(e.longPress&&0==this._activeSelectionType)0==e.button&&this.cancelPreSelection();else if(!this.ignoreSelection&&(0==e.button||e.isTouchEvent)){var t=e.x,i=e.y;if(1==this._activeSelectionType&&this.dimensionManager&&!pdDOM.Interaction.hasMoved()&&this.dimensionManager.visible&&this.dimensionManager.active&&this.dimensionManager.isOver(t,i,this.selectRadius)&&(this._activeSelectionType=2),2==this._activeSelectionType&&this.dimensionManager&&this.dimensionManager.visible&&this.dimensionManager.active){var a=this.dimensionManager.findClickPoint(t,i,this.selectRadius);return a&&this.dimensionManager.handleClickEvent(e,a),gl.canvas.style.cursor="pointer",l=0,!1}if(null!=this._preSelectedHotspot&&3==this._activeSelectionType){var r=this._preSelectedHotspot;r._preSelected&&this.selectHotspot(r),r._preSelected=!1}else this.activeHotspot&&(this.activeHotspot.handleReleaseEvent(e),this.activeHotspot&&!this.activeHotspot.getSelected()&&this.selectHotspotByIndex(-1))}return this._preSelectedHotspot&&(this._preSelectedHotspot=null,gl.update()),this.emit("pointer:up",e),!1},pdGL.Scene3D.prototype.includeInBoundingBoxList=function(e){return e&&"function"==typeof e.getAABB&&this._aabbList.indexOf(e)<0&&this._aabbList.push(e),this},pdGL.Scene3D.prototype.removeFromBoundingBoxList=function(e){var t=this._aabbList.indexOf(e);return-1<t&&this._aabbList.splice(t,1),this},pdGL.Scene3D.prototype.clearBoundingBoxList=function(){return this._aabbList.length=0,this};var s={min:new pd3D.Vector,max:new pd3D.Vector};pdGL.Scene3D.prototype.updateBoundingBox=function(e,t){if(e||this.hasChanged||!this.boundingBox){if(t=t||this,s.min.init(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s.max.init(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),s=this.getAABB(s),0<t._aabbList.length)for(var i=0,a=t._aabbList.length;i<a;++i)t._aabbList[i].getAABB&&t._aabbList[i].getAABB(s);s.max.x<s.min.x&&(s.max.x=s.max.y=1e4,s.min.x=s.min.y=-1e4,s.max.z=5e3,s.min.z=0),t.boundingBox?s.min.closeTo(t.boundingBox.min)&&s.max.closeTo(t.boundingBox.max)||(t.boundingBox.min.init(s.min),t.boundingBox.max.init(s.max),t.emit("bboxChanged",t.boundingBox)):(t.boundingBox={min:new pd3D.Vector(s.min),max:new pd3D.Vector(s.max)},t.emit("bboxChanged",t.boundingBox))}return this},pdGL.Scene3D.prototype.checkBoundingBox=function(e,t){if(e||this.hasChanged||!this.boundingBox){var i=null,a=null;if((t=t||this).boundingBox&&(i=d.copy(t.boundingBox.min),a=d.copy(t.boundingBox.max),t.boundingBox.min.init(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.boundingBox.max.init(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)),t.boundingBox=this.getAABB(t.boundingBox),0<t._aabbList.length)for(var r=0,n=t._aabbList.length;r<n;++r)t._aabbList[r].getAABB&&t._aabbList[r].getAABB(t.boundingBox);if(t.boundingBox.max.x<t.boundingBox.min.x&&(t.boundingBox.max.x=t.boundingBox.max.y=1e4,t.boundingBox.min.x=t.boundingBox.min.y=-1e4,t.boundingBox.max.z=5e3,t.boundingBox.min.z=0),t.modelSize=t.boundingBox.max.distanceTo(t.boundingBox.min),t.modelUnit=.01*t.modelSize,t.hasChanged=!1,t.modelCenter||(t.modelCenter=new pd3D.Vector),t.modelCenter.init(.5*(t.boundingBox.max.x+t.boundingBox.min.x),.5*(t.boundingBox.max.y+t.boundingBox.min.y),Math.max(0,t.boundingBox.min.z+.25*(t.boundingBox.max.z-t.boundingBox.min.z))),!(i&&d.closeTo(i,t.boundingBox.min,t.modelUnit)&&a&&d.closeTo(a,t.boundingBox.max,t.modelUnit)))return!0}return!1},pdGL.Scene3D.prototype.fitViewAnimated=function(e,a){var r=this,n=this.environment.showGroundGrid,s={},o={modelCenter:this.modelCenter.clone(),modelSize:this.modelSize,modelUnit:this.modelUnit,boundingBox:{min:this.boundingBox.min.clone(),max:this.boundingBox.max.clone()}};return this.checkBoundingBox(e,s),pd.closeTo(o.modelSize,s.modelSize,r.modelUnit)||(this.environment.showGroundGrid=!1),gl.orbitalView.hasChanged=gl.PROJECTION,gl.orbitalView.center({defaultTarget:s.modelCenter,defaultDistance:r.defaultZoom*s.modelSize,farFieldFactor:2.5/r.defaultZoom,noAnimation:!1},function(e,t){var i=1-t;return pd3D.Vector.lerp(o.modelCenter,s.modelCenter,t,r.modelCenter),pd3D.Vector.lerp(o.boundingBox.min,s.boundingBox.min,t,r.boundingBox.min),pd3D.Vector.lerp(o.boundingBox.max,s.boundingBox.max,t,r.boundingBox.max),r.modelSize=i*o.modelSize+t*s.modelSize,r.modelUnit=.01*r.modelSize,.999<t&&(r.environment.showGroundGrid=n,r.environment._groundMesh&&r.environment.updateGroundPlane(r),a&&!pd.closeTo(o.modelSize,s.modelSize,r.modelUnit)&&a(r),!0)}),this},pdGL.Scene3D.prototype.fitView=function(e,t){return this.checkBoundingBox(e),this.environment._groundMesh&&this.environment.updateGroundPlane(this),this.setModelSnap(this.preferredModelSnap),gl.orbitalView.hasChanged=gl.PROJECTION,gl.orbitalView.center({defaultTarget:this.modelCenter,defaultDistance:this.defaultZoom*this.modelSize,farFieldFactor:2.5/this.defaultZoom,noAnimation:!!t}),this},pdGL.Scene3D.prototype.attachToOrbitalView=function(e){var t=this;return!this.useOwnView&&gl.orbitalView||(this._previousOrbitalView=gl.orbitalView,this.orbitalView||(this.checkBoundingBox(),(e=e||{}).defaultTarget=this.modelCenter,e.defaultDistance=this.defaultZoom*this.modelSize,e.farFieldFactor=2.5/this.defaultZoom,this.orbitalView=new pdGL.OrbitalView(e)),gl.orbitalView=this.orbitalView),gl.orbitalView.handlePointerMove=function(e){return!!t.hotspots.length&&t.handlePointerMove(e)},gl.orbitalView.handlePointerDown=function(e){return t.handlePointerDown(e)},gl.orbitalView.handlePointerDrag=function(e){return t.handlePointerDrag(e)},gl.orbitalView.handlePointerUp=function(e){return t.handlePointerUp(e)},this.setModelSnap(this.preferredModelSnap),this.modelUnit<gl.orbitalView.snapGrid&&(gl.orbitalView.snapGrid=this.modelUnit),gl.orbitalView.scene=this},pdGL.Scene3D.prototype.detachFromOrbitalView=function(){return gl.orbitalView&&(this.hasOwnView&&this._previousOrbitalView&&gl.orbitalView.scene&&gl.orbitalView.scene.id==this.id&&(gl.orbitalView=this._previousOrbitalView),gl.orbitalView.callbackOnChange=null,gl.orbitalView.handlePointerMove=null,gl.orbitalView.handlePointerDown=null,gl.orbitalView.handlePointerDrag=null,gl.orbitalView.handlePointerUp=null,gl.orbitalView.scene=null),this},pdGL.Scene3D.prototype.activate=function(e){var t=this.environment;if(i){if(i.id==this.id&&this.active)return this;i.detachFromOrbitalView(),i.active=!1}return t.updateShadows=!0,this.attachToOrbitalView(e),this.fitView(!0,!0),this.nodes[pdGL.PHASE.GROUND_GRID]||this.handleRenderGroundPlane||!t.showGroundGrid&&!t.showGroundPlane||t._groundMesh||t.calculateGridSizeAndCenter(this),this.active=!0,i=this},pdGL.Scene3D.prototype.isValidHotspotIndex=function(e){return 0<=e&&e<this.hotspots.length},pdGL.Scene3D.prototype.setHoveredHotspotByIndex=function(e){return this.isValidHotspotIndex(this.hoveredHotspotIndex)&&(this.hotspots[this.hoveredHotspotIndex].isHovered=!1),this.hoveredHotspotIndex=e,this.isValidHotspotIndex(e)&&(this.hotspots[e].isHovered=!0),this},pdGL.Scene3D.prototype.selectHotspotByIndex=function(e){var t=null;return this.isValidHotspotIndex(e)&&(t=this.hotspots[e]),this.activeHotspot!=t&&(this.activeHotspot&&this.activeHotspot.getSelected()&&this.activeHotspot.setSelected(!1),t?(this.activeHotspotIndex=e,(this.activeHotspot=t).setSelected(!0)):(this.activeHotspotIndex=-1,this.activeHotspot=null),this.callbackOnSelectHotspot&&this.callbackOnSelectHotspot(this,this.activeHotspot),gl.update()),this},pdGL.Scene3D.prototype.selectHotspot=function(e){return this.selectHotspotByIndex(this.hotspots.indexOf(e))},pdGL.Scene3D.prototype.addHotspot=function(e,t){if(!(e&&e instanceof pdGL.Hotspot3D))throw new Error("ERROR: Only valid pdGL.Hotspot3D objects can be added to a scene.");return this.hotspots.push(e),t&&this.selectHotspotByIndex(this.hotspots.length-1),this},pdGL.Scene3D.prototype.removeHotspot=function(e){if(e){var t=this.hotspots.indexOf(e);-1<t&&(this.hotspots.splice(t,1),this.hoveredHotspotIndex==t&&(this.hoveredHotspotIndex=-1),this.activeHotspotIndex==t&&(this.activeHotspotIndex=-1,this.activeHotspot=null))}return this},pdGL.Scene3D.prototype.findHotspotById=function(e,t){for(var i=t||[],a=0,r=this.hotspots.length;a<r;++a)this.hotspots[a].id==e&&i.push(this.hotspots[a]);return i},pdGL.Scene3D.prototype.findHotspotByName=function(e,t){for(var i=t||[],a=0,r=this.hotspots.length;a<r;++a)this.hotspots[a].name==e&&i.push(this.hotspots[a]);return i},pdGL.Scene3D.prototype.clearHotspots=function(){for(var e=0,t=this.hotspots.length;e<t;++e)this.hotspots[e].clear();return this.hotspots.length=0,this.hoveredHotspotIndex=-1,this.activeHotspotIndex=-1,this.activeHotspot=null,this},pdGL.Scene3D.prototype.setDimensionManager=function(e){if(e&&!(e instanceof pdGL.DimensionManager3D))throw new Error("ERROR: Only valid pdGL.DimensionManager3D objects can be added to a scene.");return this.dimensionManager=e,this},pdGL.Scene3D.prototype.clearModel=function(){return this.clearChildren(),this.clearGeometry(),this.hasChanged=!0,this},pdGL.Scene3D.prototype.clear=function(){return this.clearHotspots(),this.clearChildren(),this.clearGeometry(),this.transformMatrix=null,this.inverseMatrix=null,this.hasChanged=!0,this},pdGL.Scene3D.prototype.addNode=function(e,t){if(e)if(2!=arguments.length)for(var i=0,a=arguments.length;i<a;++i)this.addNode(e,arguments[i]);else if(pd.isArray(t))for(i=0,a=t.length;i<a;++i)this.addNode(e,t[i]);else{t=parseInt(t,10),(!pd.isNumeric(t)||t<pdGL.PHASE.SHADOWS||t>pdGL.PHASE.HUD)&&(t=pdGL.PHASE.SURFACES),this.nodes[t]||(this.nodes[t]=new pd3D.Node(null,"RenderPhase"));var r=this.nodes[t];e instanceof pd3D.Mesh?r.addMesh(e,this.environment.surfaceMaterial):r.findChildrenById(e.id).length||r.addChild(e)}return this};var h=!(pdGL.Scene3D.prototype.removeNode=function(e,t){if(e)if(pd.isArray(t))for(var i=0,a=t.length;i<a;++i)this.removeNode(e,t[i]);else if((t=pd.toNumber(t,-1))>=pdGL.PHASE.SHADOWS&&t<=pdGL.PHASE.HUD)this.nodes[t]&&this.nodes[t].removeChild(e);else for(i=pdGL.PHASE.SHADOWS;i<=pdGL.PHASE.HUD;++i)this.nodes[i]&&this.nodes[i].removeChild(e);return this});pdGL.Scene3D.prototype.draw=function(){var e,t=this.environment,i=.001<t.outlineOpacity&&.001<t.outlineWidth,a=t.surfaceOpacity<.991,r=!1;if(!h&&gl.orbitalView){h=!0,this.checkBoundingBox(),this.handleUpdateDynamicShading&&this.handleUpdateDynamicShading(this)||(this.renderPhase=pdGL.PHASE.SHADOWS,r=t.updateDynamicShading(this)),this.handleUpdateDynamicSky&&this.handleUpdateDynamicSky(this)||t.updateDynamicSky(this),gl.orbitalView.apply(r),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.enable(gl.BLEND),this.handleUpdateDynamicUniforms&&this.handleUpdateDynamicUniforms(this)||t.updateDynamicUniforms(this),t.shareDynamicUniforms(),this.callbackOnDraw&&this.callbackOnDraw(this),gl.depthMask(!1),null!=(e=this.nodes[pdGL.PHASE.BACKGROUND])&&(this.renderPhase=pdGL.PHASE.BACKGROUND,e.draw(pd3D.RENDER_ALL)),a&&this.useImprovedTransparency&&.01<t.surfaceOpacity&&(this.renderPhase=pdGL.PHASE.OUTLINES,this.drawSurfaces()),gl.depthMask(!0),i&&(gl.lineWidth(t.outlineWidth),this.renderPhase=pdGL.PHASE.OUTLINES,this.drawOutlines(t.outlineMaterial),null!=(e=this.nodes[pdGL.PHASE.OUTLINES])&&e.drawOutlines(t.outlineMaterial)),null!=(e=this.nodes[pdGL.PHASE.RENDER_FIRST])&&(this.renderPhase=pdGL.PHASE.RENDER_FIRST,e.draw(pd3D.RENDER_FIRST)),t.shadowMap&&t.shadowMap.bind(),null!=(e=this.nodes[pdGL.PHASE.GROUND_GRID])?(this.renderPhase=pdGL.PHASE.GROUND_GRID,e.draw(pd3D.RENDER_ALL)):gl.orbitalView.camera.z>=this.boundingBox.min.z&&(this.renderPhase=pdGL.PHASE.GROUND_GRID,this.handleRenderGroundPlane?this.handleRenderGroundPlane(this,!1):t.renderGroundPlane(this,!1)),this.visible&&.001<t.surfaceOpacity&&(this.renderPhase=pdGL.PHASE.SURFACES,this.drawSurfaces()),!this.nodes[pdGL.PHASE.GROUND_GRID]&&gl.orbitalView.camera.z<this.boundingBox.min.z&&(this.renderPhase=pdGL.PHASE.GROUND_GRID,this.handleRenderGroundPlane?this.handleRenderGroundPlane(this,!0):t.renderGroundPlane(this,!0)),t.shadowMap&&t.shadowMap.unbind(),i&&(gl.lineWidth(t.outlineWidth),this.renderPhase=pdGL.PHASE.OUTLINES,this.drawOutlines(t.outlineMaterial),null!=(e=this.nodes[pdGL.PHASE.OUTLINES])&&e.drawOutlines(t.outlineMaterial),null!=(e=this.nodes[pdGL.PHASE.OUTLINES_MESH])&&e.drawOutlines(t.meshColorMaterial)),null!=(e=this.nodes[pdGL.PHASE.RENDER_LAST])&&(this.renderPhase=pdGL.PHASE.RENDER_LAST,e.draw(pd3D.RENDER_LAST)),null!=(e=this.nodes[pdGL.PHASE.RENDER_OVERLAY])&&(this.renderPhase=pdGL.PHASE.RENDER_OVERLAY,gl.disable(gl.DEPTH_TEST),e.draw(pd3D.RENDER_ALL),gl.enable(gl.DEPTH_TEST)),gl.polygonOffset(-1,1);for(var n=0,s=this.hotspots.length;n<s;++n){var o=this.hotspots[n];o.visible&&o.draw()}if(this.activeHotspot&&this.activeHotspot.visible){gl.disable(gl.DEPTH_TEST);var l=this.activeHotspot._opacity;this.activeHotspot._opacity=pd.mapAndConstrainTo(t.surfaceOpacity,.2,1,.5,.9),this.activeHotspot.draw(),this.activeHotspot._opacity=l,gl.enable(gl.DEPTH_TEST)}return gl.polygonOffset(1,1),null!=(e=this.nodes[pdGL.PHASE.HUD])&&(gl.orbitalView.startOverlay2D(),this.renderPhase=pdGL.PHASE.HUD,e.draw(pd3D.RENDER_ALL),gl.orbitalView.endOverlay2D()),gl.disable(gl.BLEND),gl.cleanup(),h=!1,this}console.warn("REQUEST TO DRAW WHILST DRAWING...")},pdGL.Scene3D.getActiveEnvironment=function(){return i?i.environment:null},pdGL.Scene3D.getActiveScene=function(){return i}}(),function(){var v=pd3D.VectorArray,h=pd3D.PlaneArray,g=pd3D.BBoxArray,n=Math.PI/1.5,s=Math.PI/3,u=[4,1],l=10,e=null;function m(){return e||(e=pdGL.Material.FixedColorUniformPointSize({name:"DefaultMaterialHotspot",uniforms:{color:[1,0,0,1],opacity:1}})),e}var t=null;function o(){return t||(t=pd3D.Shapes.sphere({radius:.075,detail:3})),t}function _(e,t){var i=t?t.metaKey:pdGL.keys.META,a=t?t.ctrlKey:pdGL.keys.CONTROL,r=t?t.shiftKey:pdGL.keys.SHIFT,n=10*e,s=.2*e,o=pdGL.Scene3D.getActiveScene();return null!=o?n=o.environment._groundGridSizeMinor:pd.Dimension.type==pd.DimensionType.IMPERIAL&&(s=1.5875,900<e?(n=4572,e=25.4):300<e?(n=914.4,e=25.4):15<e?(n=304.8,e=25.4):(e=1.5875,n=25.4)),r?n:a||i?s:e}var f={UNKNOWN:0,PUSH_PULL:1,SQUARE:2,CIRCLE:3,SECTION:4,TOUCH:5,ARROW:4};function x(e,t){pd3D.Node.call(this,t,"Manipulator3D"),this.type=f.UNKNOWN,this.parent=e,this.modelPos=[0,0,0],this.canvasPos=[0,0,0],this.flipAngle=0,this.allowSnap=!0,this.axis=0,this.transform=this.transformMatrix=new pd3D.Transform,this.getSelectionPlane=this._getSelectionPlaneByView,this.updateRotation=this._updateRotationByView}((x.prototype=Object.create(pd3D.Node.prototype)).constructor=x).prototype.getSnapWithKeyModifier=function(e,t){var i=t?t.metaKey:pdGL.keys.META,a=t?t.ctrlKey:pdGL.keys.CONTROL,r=t?t.shiftKey:pdGL.keys.SHIFT,n=10*e,s=.2*e,o=pdGL.Scene3D.getActiveScene();return null!=o?n=o.environment._groundGridSizeMinor:pd.Dimension.type==pd.DimensionType.IMPERIAL&&(s=1.5875,900<e?(n=4572,e=25.4):300<e?(n=914.4,e=25.4):15<e?(n=304.8,e=25.4):(e=1.5875,n=25.4)),r?n:a||i?s:e},x.prototype.updatePos=function(){if(this.parent){var e=this.parent.modelPos;if(this.parent.boundingBox){var t=this.parent.boundingBox,i=t.min,a=t.max,r=v.create(.5*(i[0]+a[0]),.5*(i[1]+a[1]),.5*(i[2]+a[2]));if(this.axis){var n=(1+(+this.relativeOffset||0))*this.parent.relativeSize;switch(t.callbackDynamicOffset&&(n+=t.callbackDynamicOffset(this)),this.axis){case 1:r[0]=a[0]+n;break;case-1:r[0]=i[0]-n;break;case 2:r[1]=a[1]+n;break;case-2:r[1]=i[1]-n;break;case 3:r[2]=a[2]+n;break;case-3:r[2]=i[2]-n}}v.closeTo(r,this.modelPos)||(v.set(this.modelPos,r),this.transform.setTranslation(r))}else if(pd.isArray(this.vector)){n=(+this.relativeOffset||0)*this.parent.relativeSize;var s=this.vector;this.modelPos[0]=e[0]+s[0]*n,this.modelPos[1]=e[1]+s[1]*n,this.modelPos[2]=e[2]+s[2]*n}else if(pd.isArray(this.vectorOffset)){var o=this.parent.relativeSize;15<this.flipAngle?(this.modelPos[0]=e[0]+this.vectorOffset[2]*o,this.modelPos[1]=e[1]+this.vectorOffset[0]*o,this.modelPos[2]=e[2]+this.vectorOffset[1]*o):5<this.flipAngle?(this.modelPos[0]=e[0]+this.vectorOffset[0]*o,this.modelPos[1]=e[1]+this.vectorOffset[2]*o,this.modelPos[2]=e[2]+this.vectorOffset[1]*o):(this.modelPos[0]=e[0]+this.vectorOffset[0]*o,this.modelPos[1]=e[1]+this.vectorOffset[1]*o,this.modelPos[2]=e[2]+this.vectorOffset[2]*o)}else this.modelPos[0]=e[0],this.modelPos[1]=e[1],this.modelPos[2]=e[2]}return this},x.prototype._getSelectionPlaneByView=function(){if(this.fixedPlane)switch(Math.abs(this.fixedPlane)){case 1:return h.createFromNormalAndPoint(v.unitX,this.modelPos);case 2:return h.createFromNormalAndPoint(v.unitY,this.modelPos);case 3:return h.createFromNormalAndPoint(v.unitZ,this.modelPos)}return function(e,t){if(t){var i=Math.abs(gl.orbitalView.cameraAzi);return i<45||135<i?h.createFromNormalAndPoint(v.unitX,e):h.createFromNormalAndPoint(v.unitY,e)}return h.createFromNormalAndPoint(v.unitZ,e)}(this.modelPos,this.parent.isViewedHorizontal)},x.prototype._getSelectionPlaneByVector=function(){if(3==this.axis||-3==this.axis){var e=Math.abs(gl.orbitalView.cameraAzi);if(45<=e&&e<=135)return h.createFromNormalAndPoint(v.unitY,this.modelPos)}return h.createFromNormalAndPoint(this.flipAngle?this.uVector:this.vVector,this.modelPos)},x.prototype._getSelectionPlaneByPlane=function(){if(this.parent.planeEqn)switch(this.axis){default:return h.createFromNormalAndPoint(this.parent.planeEqn,this.modelPos);case 1:return h.createFromNormalAndPoint(this.uVector,this.modelPos);case 2:return h.createFromNormalAndPoint(this.vVector,this.modelPos)}return this._getSelectionPlaneByView()},x.prototype.setTransform=function(){throw new Error("Please use 'setTranslation()', 'setAxialRotation()' or 'setScale()' methods instead as only these can be accumulated.")},x.prototype.setTranslation=function(e,t,i){return 1==arguments.length?this.transform.setTranslation(e):this.transform.setTranslation(e,t,i),this},x.prototype.setVectorRotation=function(e,t,i,a){return 2==arguments.length?this.transform.setVectorRotation(e,t):this.transform.setVectorRotation(e,t,i,a),this},x.prototype.setAxialRotation=function(e,t,i){return 1==arguments.length?this.transform.setAxialRotation(e):this.transform.setAxialRotation(e,t,i),this},x.prototype.setScale=function(e){return this.transform.setScale(e,e,e),this},x.prototype._updateRotationByView=function(){var e=0;if(this.updatePos(),this.fixedPlane)switch(Math.abs(this.fixedPlane)){case 1:e=10;break;case 2:e=20;break;case 3:e=0}else if(this.parent.isViewedHorizontal){var t=Math.abs(gl.orbitalView.cameraAzi);e=t<45||135<t?20:10}return this.flipAngle!=e&&(5<e?this.axialXYOnly?15<e?this.transform.setAxialRotation(90,0,0):this.transform.setAxialRotation(0,90,0):15<e?this.transform.setAxialRotation(0,-90,0):this.transform.setAxialRotation(90,0,0):this.transform.setAxialRotation(0,0,0),this.flipAngle=e),this},x.prototype._updateRotationByVector=function(e,t){if(this.updatePos(),!e){var i=this.flipAngle;if(1==this.axis||-1==this.axis||2==this.axis||-2==this.axis)i=this.parent.isViewedHorizontal?90:0;else if(3==this.axis||-3==this.axis){var a=Math.abs(gl.orbitalView.cameraAzi);i=a<44.99?-90:134.99<a?90:gl.orbitalView.cameraAzi<-44.99?180:0}else if(this.vVector){var r=v.angleBetweenVectors(t,this.vVector);i=r<s||n<r?0:90}this.flipAngle!=i&&(this.transform.setVectorRotation(i,this.vector),this.flipAngle=i)}return this},x.prototype._updateRotationByPlane=function(e,t){if(this.updatePos(),!e){if(this.parent.planeEqn){if(this.type==f.ARROW){var i=(a=v.angleBetweenVectors(t,this.vVector)*pd.Const.RAD2DEG)<l||180-l<a?0:90;this.axis=i<45?2:1,this.flipAngle!=i&&(this.transform.setVectorRotation(i,this.vector),this.flipAngle=i)}else{var a,r=0,n=-90,s=this.parent.planeEqn,o=pd3D.VectorArray.length(s);this.axis=0,1e-12<o&&(r=s[0]*s[0]<1e-12?0:90+Math.atan2(s[1],s[0])*pd.Const.RAD2DEG,n=90-Math.asin(s[2]/o)*pd.Const.RAD2DEG),((a=v.angleBetweenVectors(t,this.uVector)*pd.Const.RAD2DEG)<l||180-l<a)&&(this.axis=1,r+=90),((a=v.angleBetweenVectors(t,this.vVector)*pd.Const.RAD2DEG)<l||180-l<a)&&(this.axis=2,n-=90),this.transform.setAxialRotation(n,0,r)}return this}return this._updateRotationByView(e,t)}return this},x.prototype.isOver=function(e,t,i){return gl.orbitalView.modelToCanvas(this.canvasPos,this.modelPos),Math.abs(e-this.canvasPos[0])<i&&Math.abs(t-this.canvasPos[1])<i},x.prototype.distanceFromRay=function(e,t,i){return i=i||v.create(),h.intersect(i,e,t,this.getSelectionPlane())?v.distancePointToPoint(this.modelPos,i):Number.MAX_VALUE},x.prototype.distanceFromPoint=function(e){return v.distancePointToPoint(this.modelPos,e)},x.prototype.drag=function(e,t){var i=this.parent;if(i._dragReferencePos&&i._dragIntersection){var a=v.create();if(h.intersect(a,e,t,this.getSelectionPlane())){var r=i._dragReferencePos,n=i._dragIntersection,s=[r[0]+(a[0]-n[0]),r[1]+(a[1]-n[1]),r[2]+(a[2]-n[2])];if(this.allowSnap&&0<gl.orbitalView.snapGrid){var o=_(gl.orbitalView.snapGrid);s[0]=pd.snapTo(s[0],o),s[1]=pd.snapTo(s[1],o),this.parent.isViewedHorizontal&&(s[2]=pd.snapTo(s[2],o))}return i._checkToMoveModelPos(s,this)}}return!1},x.prototype._dragByVector=function(e,t){var i=this.parent;if(i&&i._dragReferencePos){var a=v.create();if(h.intersect(a,e,t,this.getSelectionPlane())){var r=this.vector,n=i._dragReferencePos,s=v.distanceInVectorDirection(n,r,a)-i._dragDistance,o=_(gl.orbitalView.snapGrid),l=Math.abs(this.axis||0);0==l&&0<o&&(s=pd.snapTo(s,o));var d=[n[0]+s*r[0],n[1]+s*r[1],n[2]+s*r[2]];if(this.allowSnap&&0<l&&0<o)switch(l){case 1:d[0]=pd.snapTo(d[0],o);break;case 2:d[1]=pd.snapTo(d[1],o);break;case 3:d[2]=pd.snapTo(d[2],o)}return i._checkToMoveModelPos(d,this)}}return!1},x.prototype._dragToPointer=function(e,t){var i=this.parent;if(i._dragReferencePos&&i._dragIntersection){var a=v.create();if(h.intersect(a,e,t,this.getSelectionPlane())){if(this.allowSnap&&0<gl.orbitalView.snapGrid){var r=_(gl.orbitalView.snapGrid);a[0]=pd.snapTo(a[0],r),a[1]=pd.snapTo(a[1],r),this.parent.isViewedHorizontal&&(a[2]=pd.snapTo(a[2],r))}return i._checkToMoveModelPos(a,this)}}return!1};var b=[1,1,1,1],y=[1,0,0,1];function i(e,t){x.call(this,e,t),this._angle=0,this._ringRadius=3.5,this._dragRadius=this._ringRadius,this.meshAxis=null,this.meshLines=null,this.drag=this._dragToPointer}function d(e,t,i,a){if(e&&t&&0<a){var r,n,s,o,l,d,h,c=[0,0,0,0],p=[0,0,0,0],u=e.vertexCount(),g=.5*a,m=pd.degreesToRadians(10),f=!1,v=18,_=9;switch(e.twoSided=!0,i){default:h=pd.degreesToRadians(0);break;case 1:f=!0,h=pd.degreesToRadians(30),v=12,_=6;break;case 2:f=!0,h=pd.degreesToRadians(120),v=12,_=6}l=Math.sin(h),d=Math.cos(h),r=g*l+t[0],n=g*d+t[1],s=a*l+t[0],o=a*d+t[1],pd.closeTo(h,0)&&(s=1.35*a*l+t[0],o=1.35*a*d+t[1]),c[0]=e.addVertex([r,n,t[2]]),c[1]=e.addVertex([s,o,t[2]]),p[0]=e.addVertex([-r,-n,t[2]]),p[1]=e.addVertex([-s,-o,t[2]]),f&&(e.addLine(c[0],c[1]),e.addLine(p[0],p[1]));for(var x=1;x<=v;++x)h+=m,l=Math.sin(h),d=Math.cos(h),r=g*l+t[0],n=g*d+t[1],s=a*l+t[0],o=a*d+t[1],x%_==0&&(!f||x<v)&&(s=1.35*a*l+t[0],o=1.35*a*d+t[1]),c[2]=e.addVertex([r,n,t[2]]),c[3]=e.addVertex([s,o,t[2]]),e.addTriangle(c[1],c[0],c[2]),e.addTriangle(c[1],c[2],c[3]),e.addLine(c[0],c[2]),e.addLine(c[1],c[3]),c[0]=c[2],c[1]=c[3],p[2]=e.addVertex([-r,-n,t[2]]),p[3]=e.addVertex([-s,-o,t[2]]),e.addTriangle(p[1],p[0],p[2]),e.addTriangle(p[1],p[2],p[3]),e.addLine(p[0],p[2]),e.addLine(p[1],p[3]),p[0]=p[2],p[1]=p[3];if(0<f&&(e.addLine(c[0],c[1]),e.addLine(p[0],p[1])),g=.2*a,e.addLine(e.addVertex([t[0]-g,t[1],t[2]]),e.addVertex([t[0]+g,t[1],t[2]])),e.addLine(e.addVertex([t[0],t[1]-g,t[2]]),e.addVertex([t[0],t[1]+g,t[2]])),3<=i){var b,y=e.vertexCount();for(x=u;x<y;++x)n=(b=e.vertices[x])[1],b[1]=b[2],b[2]=n}return!0}return!1}function c(e,t,i,a){if(e&&t&&0<a){var r,n,s,o,l=Math.PI/16,d=Math.PI/8,h=Math.PI+.5*l,c=e.vertexCount(),p=c,u=1.8*a,g=.9*a,m=1;e.twoSided=!0,e.addVertex([t[0],t[1]-a,t[2]]),e.addVertex([t[0],t[1]-u,t[2]]),e.addVertex([t[0]+g,t[1]-g,t[2]]),e.addVertex([t[0]+u,t[1],t[2]]),e.addVertex([t[0]+g,t[1]+g,t[2]]),e.addVertex([t[0],t[1]+u,t[2]]),e.addVertex([t[0],t[1]+a,t[2]]),e.addLine(p+0,p+1),e.addLine(p+1,p+2),e.addLine(p+2,p+3),e.addLine(p+3,p+4),e.addLine(p+4,p+5),e.addLine(p+5,p+6),e.addLine(p+6,p+1),p+=7;for(var f=0;f<=h;f+=l)s=Math.sin(f),o=Math.cos(f),r=t[0]+a*s,n=t[1]-a*o,p=e.addVertex([r,n,t[2]]),0<f&&(d<f&&(e.addTriangle(m,p-1,++m),d+=Math.PI/4),e.addTriangle(m,p-1,p),e.addLine(p-1,p));for(f=0;f<=h;f+=l)s=Math.sin(f),o=Math.cos(f),r=t[0]-a*s,n=t[1]+a*o,p=e.addVertex([r,n,t[2]]),0<f&&e.addLine(p-1,p);if(2<=i){p=e.vertexCount();for(var v=c;v<p;++v)n=(_=e.vertices[v])[1],_[1]=_[0],_[0]=n}if(3==i){var _;p=e.vertexCount();for(v=c;v<p;++v)n=(_=e.vertices[v])[1],_[1]=_[2],_[2]=n}return!0}return!1}function p(e,t,i,a,r,n){if(e&&t){var s,o,l=e.vertexCount();i=i||[1,0,0],a=a||[0,1,0],r=pd.toNumber(r,1);for(var d,h=[[-.5,-.25],[-.25,-.25],[-.25,-.5],[.5,0],[-.25,.5],[-.25,.25],[-.5,.25]],c=0,p=h.length;c<p;++c)s=r*(d=h[c])[0],o=r*d[1],e.addVertex([t[0]+s*i[0]+o*a[0],t[1]+s*i[1]+o*a[1],t[2]+s*i[2]+o*a[2]]);if(e.addTriangle(l+0,l+1,l+5),e.addTriangle(l+0,l+5,l+6),e.addTriangle(l+2,l+3,l+4),e.addTriangle(l+0,l+5,l+1),e.addTriangle(l+0,l+6,l+5),e.addTriangle(l+2,l+4,l+3),e.addLine(l+0,l+1),e.addLine(l+1,l+2),e.addLine(l+2,l+3),e.addLine(l+3,l+4),e.addLine(l+4,l+5),e.addLine(l+5,l+6),e.addLine(l+6,l+0),l=e.vertexCount(),-.5<(n=pd.toInteger(n,0))){if(.5<n){for(h=[[-.15,-.125],[.1,-.125],[-.15,.125],[.1,.125]],c=0;c<4;++c)s=r*(d=h[c])[0],o=r*d[1],e.addVertex([t[0]+s*i[0]+o*a[0],t[1]+s*i[1]+o*a[1],t[2]+s*i[2]+o*a[2]]);return e.addLine(l+0,l+1),e.addLine(l+1,l+2),e.addLine(l+2,l+3),!0}if(.999<i[0]){for(h=[[-.25,-.125],[0,.125],[-.25,.125],[0,-.125]],c=0;c<4;++c)s=r*(d=h[c])[0],o=r*d[1],e.addVertex([t[0]+s*i[0]+o*a[0],t[1]+s*i[1]+o*a[1],t[2]+s*i[2]+o*a[2]]);return e.addLine(l+0,l+1),e.addLine(l+2,l+3),!0}if(.999<i[1]){for(h=[[-.125,0],[0,.125],[0,-.125],[-.25,0]],c=0;c<4;++c)s=r*(d=h[c])[0],o=r*d[1],e.addVertex([t[0]+s*i[0]+o*a[0],t[1]+s*i[1]+o*a[1],t[2]+s*i[2]+o*a[2]]);return e.addLine(l,l+1),e.addLine(l,l+2),e.addLine(l,l+3),!0}if(.999<i[2]){for(h=[[0,-.125],[0,.125],[-.25,-.125],[-.25,.125]],c=0;c<4;++c)s=r*(d=h[c])[0],o=r*d[1],e.addVertex([t[0]+s*i[0]+o*a[0],t[1]+s*i[1]+o*a[1],t[2]+s*i[2]+o*a[2]]);return e.addLine(l+0,l+1),e.addLine(l+1,l+2),e.addLine(l+2,l+3),!0}}for(h=[[0,0],[-.125,-.125],[-.125,.125]],c=0;c<3;++c)s=r*(d=h[c])[0],o=r*d[1],e.addVertex([t[0]+s*i[0]+o*a[0],t[1]+s*i[1]+o*a[1],t[2]+s*i[2]+o*a[2]]);return e.addLine(l,l+1),e.addLine(l,l+2),!0}return!1}function S(e,t){if(e&&t){var i,a,r=gl.maxLineWidth<5,n=v.create(t.min),s=v.create(t.max),o=[.5*(n[0]+s[0]),.5*(n[1]+s[1]),.5*(n[2]+s[2])],l=Math.abs(s[0]-n[0]),d=Math.abs(s[1]-n[1]),h=Math.abs(s[2]-n[2]),c=(l+d+h)/3,p=.06*pdGL.Hotspot3D.getRelativeSize(.01*c),u=.05*p,g=6*p,m=r?.75:.45;if(l=c<l?c*m:l*m,d=c<d?c*m:d*m,h=c<h?c*m:h*m,e.vertexCount()<1){e.color([1,0,0,1]),e.addVertex([n[0]-u,n[1]-u,n[2]-u]),e.addVertex([s[0]+u,n[1]-u,n[2]-u]),e.addVertex([s[0]+u,s[1]+u,n[2]-u]),e.addVertex([n[0]-u,s[1]+u,n[2]-u]),e.addVertex([n[0]-u,n[1]-u,s[2]+u]),e.addVertex([s[0]+u,n[1]-u,s[2]+u]),e.addVertex([s[0]+u,s[1]+u,s[2]+u]),e.addVertex([n[0]-u,s[1]+u,s[2]+u]),e.color([1,0,0,0]);for(var f=0;f<8;++f)i=e.vertices[f],a=e.vertexCount(),e.addVertex([i[0]+(i[0]<o[0]?l:-l),i[1],i[2]]),e.addVertex([i[0],i[1]+(i[1]<o[1]?d:-d),i[2]]),e.addVertex([i[0],i[1],i[2]+(i[2]<o[2]?h:-h)]),e.addVertex([i[0]-(i[0]<o[0]?g:-g),i[1],i[2]]),e.addVertex([i[0],i[1]-(i[1]<o[1]?g:-g),i[2]]),e.addVertex([i[0],i[1],i[2]-(i[2]<o[2]?g:-g)]),r?(e.addVertex([i[0]+(i[0]<o[0]?p:-p),i[1]+(i[1]<o[1]?p:-p),i[2]]),e.addTriangle(f,a+6,a+0),e.addTriangle(f,a+0,a+6),e.addTriangle(f,a+6,a+1),e.addTriangle(f,a+1,a+6),e.addTriangle(f,a+6,a+3),e.addTriangle(f,a+3,a+6),e.addTriangle(f,a+6,a+4),e.addTriangle(f,a+4,a+6),e.addVertex([i[0],i[1]+(i[1]<o[1]?p:-p),i[2]+(i[2]<o[2]?p:-p)]),e.addTriangle(f,a+7,a+1),e.addTriangle(f,a+1,a+7),e.addTriangle(f,a+7,a+2),e.addTriangle(f,a+2,a+7),e.addTriangle(f,a+7,a+4),e.addTriangle(f,a+4,a+7),e.addTriangle(f,a+7,a+5),e.addTriangle(f,a+5,a+7),e.addVertex([i[0]+(i[0]<o[0]?p:-p),i[1],i[2]+(i[2]<o[2]?p:-p)]),e.addTriangle(f,a+8,a+0),e.addTriangle(f,a+0,a+8),e.addTriangle(f,a+8,a+2),e.addTriangle(f,a+2,a+8),e.addTriangle(f,a+8,a+3),e.addTriangle(f,a+3,a+8),e.addTriangle(f,a+8,a+5),e.addTriangle(f,a+5,a+8)):(e.addLine(f,a+0),e.addLine(f,a+1),e.addLine(f,a+2),e.addLine(f,a+3),e.addLine(f,a+4),e.addLine(f,a+5))}else if(32<=e.vertexCount()){v.set(e.vertices[0],n[0]-u,n[1]-u,n[2]-u),v.set(e.vertices[1],s[0]+u,n[1]-u,n[2]-u),v.set(e.vertices[2],s[0]+u,s[1]+u,n[2]-u),v.set(e.vertices[3],n[0]-u,s[1]+u,n[2]-u),v.set(e.vertices[4],n[0]-u,n[1]-u,s[2]+u),v.set(e.vertices[5],s[0]+u,n[1]-u,s[2]+u),v.set(e.vertices[6],s[0]+u,s[1]+u,s[2]+u),v.set(e.vertices[7],n[0]-u,s[1]+u,s[2]+u),a=8;for(f=0;f<8;++f)i=e.vertices[f],v.set(e.vertices[a+0],i[0]+(i[0]<o[0]?l:-l),i[1],i[2]),v.set(e.vertices[a+1],i[0],i[1]+(i[1]<o[1]?d:-d),i[2]),v.set(e.vertices[a+2],i[0],i[1],i[2]+(i[2]<o[2]?h:-h)),v.set(e.vertices[a+3],i[0]-(i[0]<o[0]?g:-g),i[1],i[2]),v.set(e.vertices[a+4],i[0],i[1]-(i[1]<o[1]?g:-g),i[2]),v.set(e.vertices[a+5],i[0],i[1],i[2]-(i[2]<o[2]?g:-g)),r&&(v.set(e.vertices[a+6],i[0]+(i[0]<o[0]?p:-p),i[1]+(i[1]<o[1]?p:-p),i[2]),v.set(e.vertices[a+7],i[0],i[1]+(i[1]<o[1]?p:-p),i[2]+(i[2]<o[2]?p:-p)),v.set(e.vertices[a+8],i[0]+(i[0]<o[0]?p:-p),i[1],i[2]+(i[2]<o[2]?p:-p)),a+=3),a+=6}return e.compile(),!0}return!1}function M(e,t,i,a){if(!(e&&e instanceof pdGL.Hotspot3D))throw new Error("Must pass a valid pdGL.Hotspot3D object as the 'hotspot' parameter.");var r=new pd3D.Mesh({normals:!1,lines:!0}),n=new x(e);return r.defaultNormal=[0,0,1],n.vVector=r.defaultNormal,n.type=f.SQUARE,i=.5*pd.toNumber(i,.6),a=pd.toNumber(a,.9),t=pd.toInteger(t,0),r.addVertex([-i,-i,0]),r.addVertex([i,-i,0]),r.addVertex([i,i,0]),r.addVertex([-i,i,0]),r.addTriangle(0,1,2),r.addTriangle(0,2,1),r.addTriangle(0,2,3),r.addTriangle(0,3,2),r.addLine(0,1),r.addLine(1,2),r.addLine(2,3),r.addLine(3,0),i*=.5,r.addLine(r.addVertex([-i,0,0]),r.addVertex([i,0,0])),r.addLine(r.addVertex([0,-i,0]),r.addVertex([0,i,0])),t&&1!=t||r.addLine(r.addVertex([0,i,0]),r.addVertex([0,a,0])),t&&2!=t||r.addLine(r.addVertex([i,0,0]),r.addVertex([a,0,0])),r.compile(),n.addMesh(r,m()),n}function w(e,t,i){if(!(e&&e instanceof pdGL.Hotspot3D))throw new Error("Must pass a valid pdGL.Hotspot3D object as the 'hotspot' parameter.");var a=[0,0,0];i=.5*pd.toNumber(i,.8),pd.isArray(t)&&(v.set(a,t),e.planeEqn=v.normalize(a.slice()),t=0),t=Math.abs(pd.toInteger(t,0));var r=new pd3D.Mesh({normals:!1,lines:!0});d(r,v.origin,Math.min(t,3),i),r.defaultNormal=[0,0,1],r.compile();var n=new x(e);if(n.type=f.CIRCLE,1<=t&&t<=3&&(a[Math.abs(t)-1]=pd.sign(t),n.axis=t),0<t&&(n.vector=v.normalize(a.slice()),n.relativeOffset=0,s=.95<Math.abs(a[2])?[0,1,0]:[0,0,1],n.uVector=v.cross(v.create(),a,s),n.vVector=v.cross(r.defaultNormal,a,n.uVector),n.getSelectionPlane=n._getSelectionPlaneByVector,n.updateRotation=n._updateRotationByVector,n.drag=n._dragByVector),e.planeEqn){var s=.95<Math.abs(e.planeEqn[2])?[0,1,0]:[0,0,1];n.uVector=v.cross([],e.planeEqn,s),n.vVector=v.cross([],e.planeEqn,n.uVector),n.getSelectionPlane=n._getSelectionPlaneByPlane,n.updateRotation=n._updateRotationByPlane}return n.addMesh(r,m()),n}function L(e,t,i){if(!(e&&e instanceof pdGL.Hotspot3D))throw new Error("Must pass a valid pdGL.Hotspot3D object as the 'hotspot' parameter.");i=pd.toNumber(i,.4),t=pd.toInteger(t,0);var a=new pd3D.Mesh({normals:!1,lines:!0});c(a,v.origin,t,i),a.defaultNormal=[0,0,1],a.compile();var r=new x(e);if(r.type=f.SECTION,1<=t&&t<=3){var n=[0,0,0];t=Math.round(pd.constrainTo(t,-3,3)),n[Math.abs(t)-1]=pd.sign(t),r.vector=v.normalize(n.slice()),r.relativeOffset=0;var s=.95<Math.abs(n[2])?[0,1,0]:[0,0,1];r.uVector=v.cross(v.create(),n,s),r.vVector=v.cross(a.defaultNormal,n,r.uVector),r.getSelectionPlane=r._getSelectionPlaneByVector,r.updateRotation=r._updateRotationByVector,r.drag=r._dragByVector,r.axis=t}return r.addMesh(a,m()),r}function D(e,t,i){if(!(e&&e instanceof pdGL.Hotspot3D))throw new Error("Must pass a valid pdGL.Hotspot3D object as the 'hotspot' parameter.");var a=new pd3D.Mesh({normals:!1,lines:!0}),r=new x(e);t=t||[-1,-1,0],i=pd.toNumber(i,.4),a.defaultNormal=[0,0,1],r.vVector=a.defaultNormal,r.type=f.TOUCH,r.modelPos[0]=t[0],r.modelPos[1]=t[1],function(e,t,i){if(e&&t&&0<i){var a,r,n=pd.Const.TWO_PI/24,s=e.vertexCount(),o=s+2;e.addVertex([t[0],t[1],t[2]]),e.addVertex([t[0],t[1]+i,t[2]]);for(var l=n;l<pd.Const.TWO_PI;l+=n)a=i*Math.sin(l)+t[0],r=i*Math.cos(l)+t[1],e.addVertex([a,r,t[2]]),e.addTriangle(s,o-1,o),e.addTriangle(s,o,o-1),e.addLine(o-1,o),o++;return}}(a,r.vectorOffset=t,i);var n=a.vertexCount(),s=pd.sign(t[0]),o=pd.sign(t[1]),l=Math.abs(t[0]),d=Math.abs(t[1]),h=Math.min(l,d),c=Math.max(l,d);if(i+.1<c&&d+i<l)a.addVertex([.1*s,.1*o,0]),a.addVertex([s*h,o*h,0]),a.addVertex([s*(l-i),o*h,0]),a.addLine(n+2,n+1),a.addLine(n+1,n);else if(i+.1<c&&l+i<d)a.addVertex([.1*s,.1*o,0]),a.addVertex([s*h,o*h,0]),a.addVertex([s*h,o*(d-i),0]),a.addLine(n+2,n+1),a.addLine(n+1,n);else if(i<l){var p=[t[0],t[1],0],u=v.length(p)-i;p=v.normalize(p),a.addVertex([.15*p[0],.15*p[1],0]),a.addVertex([p[0]*u,p[1]*u,0]),a.addLine(n+1,n)}return a.compile(),r.addMesh(a,m()),r}function E(e,t,i){if(!(e&&e instanceof pdGL.Hotspot3D))throw new Error("Must pass a valid pdGL.Hotspot3D object as the 'hotspot' parameter.");i=i||{};var a=pd.toBoolean(i.noLines,!1),r=pd.toNumber(i.offset,1.5);t=t||[1,0,0];var n=new pd3D.Mesh({normals:!1,lines:!0}),s=new x(e);n.defaultNormal=[0,0,1],s.vector=v.normalize(t.slice()),s.type=f.ARROW,s.relativeOffset=r,t=s.vector,s.modelPos[0]=r*t[0],s.modelPos[1]=r*t[1],s.modelPos[2]=r*t[2];var o=.95<Math.abs(s.vector[2])?[0,1,0]:[0,0,1];if(s.uVector=v.cross(v.create(),s.vector,o),s.vVector=v.cross(n.defaultNormal,s.vector,s.uVector),pd.closeTo(r,0)?function(e,t,i,a,r){if(e&&t){var n,s,o=e.vertexCount();i=i||[1,0,0],a=a||[0,1,0],r=pd.toNumber(r,1);for(var l,d=[[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]],h=0,c=d.length;h<c;++h)n=r*(l=d[h])[0],s=r*l[1],e.addVertex([t[0]+n*i[0]+s*a[0],t[1]+n*i[1]+s*a[1],t[2]+n*i[2]+s*a[2]]);return e.addTriangle(o+0,o+1,o+2),e.addTriangle(o+0,o+2,o+3),e.addTriangle(o+2,o+1,o+0),e.addTriangle(o+3,o+2,o+0),e.addLine(o+0,o+1),e.addLine(o+1,o+2),e.addLine(o+2,o+3),e.addLine(o+3,o+0)}}(n,s.modelPos,s.vector,s.uVector,.5):p(n,s.modelPos,s.vector,s.uVector,1,i.arrow?-1:0),!a){var l=r-.5,d=n.vertexCount();n.addVertex([.25*t[0],.25*t[1],.25*t[2]]),n.addVertex([l*t[0],l*t[1],l*t[2]]),n.addLine(d,d+1)}return n.compile(),.999<t[0]?s.axis=1:t[0]<-.999?s.axis=-1:.999<t[1]?s.axis=2:t[1]<-.999?s.axis=-2:.999<t[2]?s.axis=3:t[2]<-.999?s.axis=-3:s.axis=0,s.getSelectionPlane=s._getSelectionPlaneByVector,s.updateRotation=s._updateRotationByVector,s.drag=s._dragByVector,s.addMesh(n,m()),s}function T(e,t,i,a,r){if(t=t||[1,0,0],i=pd.toNumber(i,1.5),e.vector=v.normalize(t.slice()),e.relativeOffset=i,t=e.vector,e.modelPos[0]=i*t[0],e.modelPos[1]=i*t[1],e.modelPos[2]=i*t[2],!a){var n=.95<Math.abs(t[2])?[0,1,0]:[0,0,1];a=v.cross(e.uVector||[],t,n)}r||(r=v.cross(e.vVector||[],t,a)),v.set(e.uVector||[],a),v.set(e.vVector||[],r);var s=e.getMeshesByMaterial(m());if(0<s.length){var o=s[0];o.reuseStart(),p(o,e.modelPos,e.vector,e.uVector,1,-1),o.reuseEnd(),o.compile(),gl.update()}return.999<t[0]?e.axis=1:t[0]<-.999?e.axis=-1:.999<t[1]?e.axis=2:t[1]<-.999?e.axis=-2:.999<t[2]?e.axis=3:t[2]<-.999?e.axis=-3:e.axis=0,e.getSelectionPlane=e._getSelectionPlaneByVector,e.updateRotation=e._updateRotationByVector,e.drag=e._dragByVector,e}function A(e,t){var i=gl.orbitalView?1e-6*gl.orbitalView.getPointSize():1e-9;return!v.closeTo(e,t,i)}x.prototype._render=function(e,t){var i,a=pd3D.RENDER_ALL,r=m(),n=0<t,s=1;if(this.type==f.ARROW&&pd.isArray(this.vector)){var o=v.angleBetweenVectors(e,this.vector);if(o<.1745329252?s=pd.mapAndConstrainTo(o,0,.1745329252,0,1):2.9670597284<o&&(s=pd.mapAndConstrainTo(o,Math.PI,2.9670597284,0,1)),(s*=s)<.1)return this}for(var l in this.updateRotation(n,e),s<1&&(y[3]*=s,b[3]*=s),this.callbackOnDraw&&this.callbackOnDraw(this,a),this.transformMatrix&&(gl.pushMatrix(),gl.multMatrix(this.transformMatrix)),this.geometry)if(this.geometry.hasOwnProperty(l)){var d=this.geometry[l];0<=t&&(d.material.id==r.id&&d.material.uniform("color",b),d.material.renderSurfaces(d.meshes)),d.material.id==r.id&&d.material.uniform("color",y),d.material.renderOutlines(d.meshes).endRender()}for(var h=0,c=this.children.length;h<c;++h)(i=this.children[h])&&i.draw&&i.draw(a);return this.transformMatrix&&gl.popMatrix(),s<1&&(y[3]/=s,b[3]/=s),this},((i.prototype=Object.create(x.prototype)).constructor=i).prototype._setAngle=function(e,t){if(e=pd.wrapAt(pd.toNumber(e,this._angle),-180,180),t||!pd.closeTo(this._angle,e)){var i=this.parent.callbackOnAngleChanging;if(!i||i(this.parent,e)){this._angle=e;var a=pd.degreesToRadians(this._angle);return this.vectorOffset[0]=Math.sin(a),this.vectorOffset[1]=Math.cos(a),this.updatePos(),!0}}return!1},i.prototype.angle=function(e,t){return arguments.length?(this._setAngle(e,t),this):this._angle},i.prototype.updatePos=function(){if(this.parent){var e=this.parent,t=e.modelPos,i=e.relativeSize,a=this.vectorOffset,r=this._dragRadius,n=this.modelPos,s=a[0]*r,o=a[1]*r,l=a[2]*r;this.setTranslation(s,o,l),this.transform.setAxialRotation(0,0,-e._angle),v.set(n,t[0]+s*i,t[1]+o*i,t[2]+l*i)}return this},pdGL.Hotspot3D=function(e){e=e||{},pd3D.Node.call(this,e.name,"Hotspot"),this.modelPos=e.modelPos||[0,0,0],this.canvasPos=[0,0,0],this.callbackOnChanging=e.callbackOnChanging||null,this.callbackOnChange=e.callbackOnChange||null,this.callbackOnChanged=e.callbackOnChanged||null,this.callbackOnDragStart=e.callbackOnDragStart||null,this.callbackOnDragEnd=e.callbackOnDragEnd||null,this.alwaysCheckSelector=!1,this.relativeSize=pd.toNumber(e.relativeSize,100),this.selectedChildIndex=-1,this.isViewedHorizontal=!1,this.isHovered=!1,this._hasMoved=!1,this._selected=!1,this._dragReferencePos=null,this._dragIntersection=null,this._dragDistance=0,this._opacity=1,this._ray={},e.planeEqn&&this.setPlaneEquation(e.planeEqn),1e-6<v.length(this.modelPos)&&this.setTransform(pd3D.Matrix.translate(this.modelPos[0],this.modelPos[1],this.modelPos[2])),pd.addSimpleEventHandling(this)},pdGL.Hotspot3D.prototype=Object.create(pd3D.Node.prototype),pdGL.Hotspot3D.prototype.constructor=pdGL.Hotspot3D,pdGL.Hotspot3D.getFlipThresholdAngle=function(){return l},pdGL.Hotspot3D.setFlipThresholdAngle=function(e){return l=pd.constrainTo(pd.toNumber(e,20),0,90)},pdGL.Hotspot3D.altBelowFlipThresholdAngle=function(e){var t=pd.Const.RAD2DEG*v.angleBetweenVectors(e,v.unitZ);return pd.closeTo(t,90,l)},pdGL.Hotspot3D.arrowSizeFactor=4.5,pdGL.Hotspot3D.selectRadiusModifier=.6,pdGL.Hotspot3D.getRelativeSize=function(e){var t=pdGL.Scene3D.getActiveScene();return t?t.modelUnit*pdGL.Hotspot3D.arrowSizeFactor:gl.orbitalView?gl.orbitalView.getPointSize()*pdGL.Hotspot3D.arrowSizeFactor:pd.toNumber(e,100)},pdGL.Hotspot3D.useDetachedCursor=function(e){b[2]=e?.4:1},pdGL.Hotspot3D.prototype.getModelSelectionRadius=function(){return pdGL.Hotspot3D.selectRadiusModifier*this.relativeSize},pdGL.Hotspot3D.prototype._isOverManipulator=function(e,t){for(var i=v.create(),a=this.getModelSelectionRadius(),r=gl.orbitalView.canvasToModel(e,t,0).toArray(),n=gl.orbitalView.canvasToModel(e,t,1).toArray(),s=0,o=this.children.length;s<o;++s){var l=this.children[s];if(l&&l.visible&&l.distanceFromRay&&l.distanceFromRay(r,n,i)<a)return!0}return!1},pdGL.Hotspot3D.prototype._isOverSelector=function(e,t,i){return gl.orbitalView.modelToCanvas(this.canvasPos,this.modelPos),Math.abs(e-this.canvasPos[0])<i&&Math.abs(t-this.canvasPos[1])<i},pdGL.Hotspot3D.prototype.isOver=function(e,t,i){if(this.visible&&this.active){if(this._selected&&this._isOverManipulator(e,t))return!0;if(!this._selected||this.alwaysCheckSelector)return this._isOverSelector(e,t,i)}return!1},pdGL.Hotspot3D.prototype._updatePosition=function(){for(var e=this.modelPos,t=0,i=this.children.length;t<i;++t){var a=this.children[t];a&&a.visible&&a.updatePos&&a.updatePos()}if(1e-6<v.length(e))if(this.transformMatrix){var r=this.transformMatrix.m;r[3]=e[0],r[7]=e[1],r[11]=e[2]}else this.setTransform(pd3D.Matrix.translate(e[0],e[1],e[2]));else this.transformMatrix&&delete this.transformMatrix;this._hasMoved=!0,gl.update()},pdGL.Hotspot3D.prototype.useNewModelPos=function(e){return!!(pd.isArray(e)&&2<e.length)&&(this.modelPos=e,this._updatePosition(),!0)},pdGL.Hotspot3D.prototype.moveModelPos=function(e,t){return!!A(e,this.modelPos)&&(this.planeEqn&&pd3D.PlaneArray.closestPointByAxis(e,e,this.planeEqn),v.set(this.modelPos,e),this.callbackOnChange&&this.callbackOnChange(this,t),this._updatePosition(),!0)},pdGL.Hotspot3D.prototype._checkToMoveModelPos=function(e,t){return!!A(e,this.modelPos)&&(!(this.callbackOnChanging&&!this.callbackOnChanging(this,t,e))&&this.moveModelPos(e,t))},pdGL.Hotspot3D.prototype.hasMoved=function(){return this._hasMoved},pdGL.Hotspot3D.prototype.isPreSelected=function(){return this._preSelected},pdGL.Hotspot3D.prototype.getSelected=function(){return this._selected},pdGL.Hotspot3D.prototype.setSelected=function(e){return this._selected!=e&&(this._selected=e,this._preSelected=!1,this.selectedChildIndex=-1,this.emit("selected",e),gl.update()),this},pdGL.Hotspot3D.prototype.cancelPreSelection=function(){return this._preSelected&&this.emit("preselect",!1),this._preSelected=!1,this},pdGL.Hotspot3D.prototype.getSelectedChildIndex=function(){return this.selectedChildIndex},pdGL.Hotspot3D.prototype.setSelectedChildIndex=function(e){if(this.selectedChildIndex!=e){var t=this.children[e];if(!t||t.visible){var i=this.selectedChildIndex;this.selectedChildIndex=e,this.emit("select:child",0<=e,e,i),gl.update()}}this.selectedChildIndex<0&&(this._dragIntersection=null,this._dragReferencePos=null,this._dragDistance=0)};var P=!(pdGL.Hotspot3D.prototype.getSelectedManipulator=function(){var e=this.selectedChildIndex;if(0<=e&&e<this.children.length){var t=this.children[e];if(t&&t.drag)return t}return null});pdGL.Hotspot3D.captureEvent=function(e){return 0<arguments.length&&(P=pd.toBoolean(e,P)),P},pdGL.Hotspot3D.prototype._checkProximityToSelector=function(e,t){return v.distancePointToLineSegment(this.modelPos,e.start,e.end)<t},pdGL.Hotspot3D.prototype._checkProximity=function(e){var t=this.getModelSelectionRadius(),i=this._ray.start=gl.orbitalView.canvasToModel(e.x,e.y,0).toArray(),a=this._ray.end=gl.orbitalView.canvasToModel(e.x,e.y,1).toArray();if(this._selected)for(var r=v.create(),n=0,s=this.children.length;n<s;++n){var o=this.children[n];if(o&&o.visible&&o.distanceFromRay&&o.distanceFromRay(i,a,r)<t)return!0}return!(this._selected&&!this.alwaysCheckSelector)&&this._checkProximityToSelector(this._ray,t,!1)},pdGL.Hotspot3D.prototype._selectManipulator=function(e,t,i){for(var a,r=-1,n=Number.MAX_VALUE,s=v.create(),o=1.25*i,l=!1,d=0,h=this.children.length;d<h;++d){var c=this.children[d];c&&c.visible&&c.distanceFromRay&&((a=c.distanceFromRay(e,t,s))<o&&(l=!0),a<i&&a<n&&(r=d,this._dragIntersection=s.slice(),c.vector?this._dragDistance=v.distanceInVectorDirection(this.modelPos,c.vector,s):this._dragDistance=v.distancePointToPoint(this.modelPos,s),n=a))}return this.setSelectedChildIndex(r),0<=this.selectedChildIndex&&(this._dragReferencePos=this.modelPos.slice(),this.boundingBox&&g.set(this._dragBoxOriginalPos,this.boundingBox.min,this.boundingBox.max,this.boundingBox.axis)),l},pdGL.Hotspot3D.prototype._checkProximityAndSelect=function(e){var t=this.getModelSelectionRadius();return this._ray.start=gl.orbitalView.canvasToModel(e.x,e.y,0).toArray(),this._ray.end=gl.orbitalView.canvasToModel(e.x,e.y,1).toArray(),this._selected&&(P=this._selectManipulator(this._ray.start,this._ray.end,t))?this.callbackOnDragStart&&this.callbackOnDragStart(this,e):this._selected&&!this.alwaysCheckSelector||(P=this._checkProximityToSelector(this._ray,t,!1),this.touchChild&&P&&this.touchChild.show(e.isTouchEvent)),this._hasMoved=!1,P},pdGL.Hotspot3D.prototype.handleSelectEvent=function(e,t,i){return!(!this.visible||!this.active)&&(i?this._checkProximity(e):this._checkProximityAndSelect(e))},pdGL.Hotspot3D.prototype.handleDragEvent=function(e){if(this._selected){var t=this.selectedChildIndex;if(0<=t&&t<this.children.length){var i=this.children[t];i&&i.drag&&(this._ray.start=gl.orbitalView.canvasToModel(e.x,e.y,0).toArray(),this._ray.end=gl.orbitalView.canvasToModel(e.x,e.y,1).toArray(),i.drag(this._ray.start,this._ray.end))}}return P},pdGL.Hotspot3D.prototype.handleReleaseEvent=function(e){var t=P;return P=!1,t?(this._hasMoved&&this.callbackOnChanged&&this.callbackOnChanged(this,e),this.callbackOnDragEnd&&this.callbackOnDragEnd(this,e),this.setSelectedChildIndex(-1)):pdDOM.Interaction.hasMoved()||this.setSelected(!1),this._hasMoved=!1,t},pdGL.Hotspot3D.prototype._render=function(){var e=y[3],t=b[3],i=this._opacity,a=gl.orbitalView.getVectorToCamera(this.modelPos[0],this.modelPos[1],this.modelPos[2]),r=pdGL.Hotspot3D.getRelativeSize()/Math.max(.25,gl.orbitalView.zoomFactor);for(var n in this.selectedChildIndex<0&&(this.isViewedHorizontal=pdGL.Hotspot3D.altBelowFlipThresholdAngle(a)),this.relativeSize=r,this.callbackOnDraw&&this.callbackOnDraw(this),gl.pushMatrix(),gl.pushLineWidth(gl.getCanvasLineWidth()),this.transformMatrix&&gl.multMatrix(this.transformMatrix),gl.scale(r),this._preSelected&&!this._selected&&(i*=.6),y[3]=i,m().uniform("color",y),this.geometry)if(this.geometry.hasOwnProperty(n)){var s=this.geometry[n];s.material.renderMeshes(s.meshes,u).endRender()}if(this._selected||this._preSelected){var o,l=this._preSelected?-1:0,d=this.selectedChildIndex;this._preSelected&&gl.disable(gl.DEPTH_TEST);for(var h=0,c=this.children.length;h<c;++h){var p=this.children[h];p&&p.visible&&p._render&&(o=l||(d==h?1:0),b[3]=o?Math.max(i,.6):.6*i,p._render(a,o))}this._preSelected&&gl.enable(gl.DEPTH_TEST)}y[3]=e,b[3]=t,gl.popLineWidth(),gl.popMatrix()},pdGL.Hotspot3D.prototype.addCenterSphere=function(){return this.addMesh(o(),m()),this},pdGL.Hotspot3D.prototype.addCenterCircle=function(e,t){return this.addChild(w(this,e,t)),this},pdGL.Hotspot3D.prototype.addCenterPushPull=function(e){return this.addChild(function(e,t,i){if(!(e&&e instanceof pdGL.Hotspot3D))throw new Error("Must pass a valid pdGL.Hotspot3D object as the 'hotspot' parameter.");var a,r=new pd3D.Mesh({normals:!1,lines:!0}),n=new x(e);return r.defaultNormal=[0,0,1],n.vVector=r.defaultNormal,n.type=f.PUSH_PULL,n.fixedPlane=3,i=.5*pd.toNumber(i,1),a=r.addVertex([.5*i,-i,0]),r.addVertex([1.5*i,0,0]),r.addVertex([.5*i,i,0]),r.addVertex([-.5*i,i,0]),r.addVertex([-1.5*i,0,0]),r.addVertex([-.5*i,-i,0]),r.addTriangle(a+0,a+1,a+2),r.addTriangle(a+3,a+4,a+5),r.addLine(a+0,a+1),r.addLine(a+1,a+2),r.addLine(a+2,a+0),r.addLine(a+3,a+4),r.addLine(a+4,a+5),r.addLine(a+5,a+3),a=r.addVertex([.75*i,.25*i,0]),r.addVertex([1*i,0,0]),r.addVertex([.75*i,-.25*i,0]),r.addLine(a+0,a+1),r.addLine(a+1,a+2),a=r.addVertex([-.75*i,.25*i,0]),r.addVertex([-1*i,0,0]),r.addVertex([-.75*i,-.25*i,0]),r.addLine(a+0,a+1),r.addLine(a+1,a+2),r.compile(),n.addMesh(r,m()),n}(this,0,e)),this.addCenterSphere(),this},pdGL.Hotspot3D.prototype.addArrowVector=function(e,t){var i={offset:t,arrow:!0};return this.addChild(E(this,e,i)),this.children[this.children.length-1].updatePos(),this},pdGL.Hotspot3D.prototype.addAxialArrows=function(e,t){var i=this.children.length;i<1&&this.addMesh(o(),m());var a={noLines:!0,offset:1.5};switch(e=pd.toInteger(e,0)){default:case 0:switch(t=Math.abs(pd.toNumber(t,0))){default:this.addChild(E(this,[1,0,0],a)),this.addChild(E(this,[0,1,0],a)),this.addChild(E(this,[0,0,1],a)),t=0;break;case 1:this.addChild(E(this,[0,1,0],a)),this.addChild(E(this,[0,-1,0],a)),this.addChild(E(this,[0,0,1],a)),this.addChild(E(this,[0,0,-1],a));break;case 2:this.addChild(E(this,[1,0,0],a)),this.addChild(E(this,[-1,0,0],a)),this.addChild(E(this,[0,0,1],a)),this.addChild(E(this,[0,0,-1],a));break;case 3:this.addChild(E(this,[1,0,0],a)),this.addChild(E(this,[-1,0,0],a)),this.addChild(E(this,[0,1,0],a)),this.addChild(E(this,[0,-1,0],a));break;case 4:this.addChild(E(this,[1,0,0],a)),this.addChild(E(this,[-1,0,0],a)),this.addChild(E(this,[0,1,0],a)),this.addChild(E(this,[0,-1,0],a)),this.addChild(E(this,[0,0,1],a)),this.addChild(E(this,[0,0,-1],a)),t=0}if(this.addChild(M(this,t,.9)),this.touchChild=D(this).hide(),this.addChild(this.touchChild),0!=t)for(var r=i,n=this.children.length;r<n;++r)this.children[r].fixedPlane=t;break;case 1:a.offset=.85,this.addChild(E(this,[-1,0,0],a)),this.addChild(E(this,[1,0,0],a)),a.offset=0,this.addChild(E(this,[1,0,0],a));break;case-1:this.addChild(L(this,1));break;case 2:a.offset=.85,this.addChild(E(this,[0,-1,0],a)),this.addChild(E(this,[0,1,0],a)),a.offset=0,this.addChild(E(this,[0,1,0],a));break;case-2:this.addChild(L(this,2));break;case 3:a.offset=.85,this.addChild(E(this,[0,0,-1],a)),this.addChild(E(this,[0,0,1],a)),a.offset=0,this.addChild(E(this,[0,0,1],a));break;case-3:this.addChild(L(this,3));break;case 4:a.offset=1.2,this.addChild(E(this,[-1,0,0],a)),this.addChild(E(this,[1,0,0],a)),this.addChild(E(this,[0,-1,0],a)),this.addChild(E(this,[0,1,0],a)),this.addChild(M(this,3,.9))}for(r=0,n=this.children.length;r<n;++r)this.children[r].updatePos();return this},pdGL.Hotspot3D.prototype.setArrowVector=function(e,t,i){if(t=v.normalize(t.slice()),0<=e&&e<this.children.length){var a=this.children[e];a&&a.vector&&T(a,t,i)}return this},pdGL.Hotspot3D.prototype.setPlaneEquation=function(e,t,i){var a=0,r=this.modelPos,n=gl.orbitalView.getVectorToCamera(r[0],r[1],r[2]),s=v.set(this.planeEqn||[],e.slice());if(v.normalize(s),(this.planeEqn=s)[3]=-(s[0]*r[0]+s[1]*r[1]+s[2]*r[2]),!pd.isArray(t)){var o=.95<Math.abs(s[2])?[0,1,0]:[0,0,1];t=v.cross([],s,o)}pd.isArray(i)||(i=v.cross([],s,t));for(var l=0,d=this.children.length;l<d;++l){var h=this.children[l];h&&(h.type==f.ARROW?(0==a?T(h,t,h.relativeOffset,e,i):1==a&&T(h,i,h.relativeOffset,e,t),h.flipAngle=-999,++a):(h.uVector=v.set(h.uVector||[],t),h.vVector=v.set(h.vVector||[],i)),h.updateRotation=h._updateRotationByPlane,h.getSelectionPlane=h._getSelectionPlaneByPlane,h.updateRotation(!1,n))}return this};var C=-101;function O(){var e=this.modelPos,t=this.parent,i=this.vectorOffset,a=t._dragRadius,r=t.relativeSize,n=t.modelPos,s=i[0]*a,o=i[1]*a,l=i[2]*a;this.setTranslation(s,o,l),this.transform.setAxialRotation(0,0,-t._angle),v.set(e,n[0]+s*r,n[1]+o*r,n[2]+l*r)}pdGL.HotspotBoundingBox=function(e){e=e||{},pdGL.Hotspot3D.call(this,e),this.selectedBoxIndex=-1,this.defaultBoundingBox=null,this._preSelectedBoxIndex=-1,this._dragBoxOriginalPos=g.create(),this._dragAxisLock=0,e.boundingBox&&(this.selectedBoxIndex=this._preSelectedBoxIndex=C,this.setBoundingBox(e.boundingBox,e.callbackOnChanging,e.axis),this.defaultBoundingBox=e.boundingBox),e.subBoundingBoxes&&this.setSubBoundingBoxes(e.subBoundingBoxes),this.callbackOnSelectionChanging=e.callbackOnSelectionChanging||null,this.callbackOnSelectionChanged=e.callbackOnSelectionChanged||null},pdGL.HotspotBoundingBox.prototype=Object.create(pdGL.Hotspot3D.prototype),pdGL.HotspotBoundingBox.prototype.constructor=pdGL.HotspotBoundingBox,pdGL.HotspotBoundingBox.MAIN_BBOX=C,pdGL.HotspotBoundingBox.prototype.setBoundingBox=function(e,t,i){var a=this.boundingBox;if(this.callbackOnSelectionChanging&&this.boundingBox!=e&&!this.callbackOnSelectionChanging(this,e))return this;if(e){this.boundingBox=e,this.callbackOnChanging=t||e.handleChanging,this.callbackOnChange=e.handleChange||null;var r=this.boundingBox.min,n=this.boundingBox.max,s=[.5*(r[0]+n[0]),.5*(r[1]+n[1]),.5*(r[2]+n[2])];this.modelPos[0]=s[0],this.modelPos[1]=s[1],this.modelPos[2]=s[2],g.set(this._dragBoxOriginalPos,e.min,e.max,e.axis);var o=this.getMeshesByMaterial(pdGL.getDefaultMaterialMeshColor());if(0<o.length&&S(o[0],this.boundingBox),7!=this.children.length){var l={noLines:!0,offset:.01};this.clearChildren(),this.addChild(E(this,[1,0,0],l)),this.addChild(E(this,[-1,0,0],l)),this.addChild(E(this,[0,1,0],l)),this.addChild(E(this,[0,-1,0],l)),this.addChild(E(this,[0,0,1],l)),this.addChild(E(this,[0,0,-1],l)),this.addChild(w(this))}e.fixedAxis&&0<e.fixedAxis&&e.fixedAxis<=3?(this.children[0].visible=this.children[1].visible=1==e.fixedAxis,this.children[2].visible=this.children[3].visible=2==e.fixedAxis,this.children[4].visible=this.children[5].visible=3==e.fixedAxis,this.children[6].visible=!1):(pd.isNumeric(i)||(i=pd.toNumber(Math.abs(e.axis),0)),this.children[0].visible=this.children[1].visible=1!=i,this.children[2].visible=this.children[3].visible=2!=i,this.children[4].visible=this.children[5].visible=3!=i,e.showCenter?(this.children[6].visible=!0,this.children[6].axialXYOnly=!1,this.children[6].fixedPlane=0):(this.children[6].visible=1<=i&&i<=3,this.children[6].fixedPlane=Math.abs(i),this.children[6].axialXYOnly=!0));for(var d=0;d<7;++d)this.children[d].updatePos();this.setTransform(null),this._selected=!0}else this.boundingBox=null;return this.callbackOnSelectionChanged&&this.boundingBox!=a&&this.callbackOnSelectionChanged(this,this.boundingBox,a),this},pdGL.HotspotBoundingBox.prototype.updateBoundingBox=function(){if(this.boundingBox){var e=this.getMeshesByMaterial(pdGL.getDefaultMaterialMeshColor());0<e.length&&S(e[0],this.boundingBox)}return this},pdGL.HotspotBoundingBox.prototype.setSubBoundingBoxes=function(e){return pd.isArray(e)&&0<e.length?(this.subBoundingBoxes=e.slice(),this._preSelectedBoxMesh||(this._preSelectedBoxMesh=new pd3D.Mesh({colors:!0,lines:!0}))):delete this.subBoundingBoxes,0<=this.selectedBoxIndex&&(this.selectedBoxIndex=this._preSelectedBoxIndex=-1),this},pdGL.HotspotBoundingBox.prototype.addSubBoundingBox=function(e){if(pd.isArray(this.subBoundingBoxes)||(this.subBoundingBoxes=[]),this._preSelectedBoxMesh||(this._preSelectedBoxMesh=new pd3D.Mesh({colors:!0,lines:!0})),pd.isArray(e)&&0<e.length)for(var t=0,i=e.length;t<i;++t)this.subBoundingBoxes.push(e[t]);else pd.isObject(e)&&null!=e.min&&this.subBoundingBoxes.push(e);return this},pdGL.HotspotBoundingBox.prototype.selectBoundingBox=function(e,t){return 0<=e&&this.subBoundingBoxes&&e<this.subBoundingBoxes.length?(this.selectedBoxIndex=this._preSelectedBoxIndex=e,this.setBoundingBox(this.subBoundingBoxes[this.selectedBoxIndex]),this.touchChild&&this.touchChild.show(!!t),gl.update()):e==C?(this.selectedBoxIndex=this._preSelectedBoxIndex=e,this.setBoundingBox(this.defaultBoundingBox||this.boundingBox),this.touchChild&&this.touchChild.show(!!t),gl.update()):this.setSelected(!1),this},pdGL.HotspotBoundingBox.prototype.setSelected=function(e){return this._selected!=e&&(this._selected=e,this.selectedChildIndex=-1,this.setDragAxisLock(0),gl.update()),e?(this._preSelectedBoxIndex<0&&(this.defaultBoundingBox?this._preSelectedBoxIndex=C:this._preSelectedBoxIndex=this.selectedBoxIndex),this.selectBoundingBox(this._preSelectedBoxIndex)):(this.selectedBoxIndex=this._preSelectedBoxIndex=-1,this.setBoundingBox(null)),this},pdGL.HotspotBoundingBox.prototype.isDefaultBoxSelected=function(){return this.selectedBoxIndex==C},pdGL.HotspotBoundingBox.prototype.isSubBoxSelected=function(){return 0<=this.selectedBoxIndex},pdGL.HotspotBoundingBox.prototype.isPreSelected=function(){return this._selected&&0<=this._preSelectedBoxIndex?this._preSelectedBoxIndex!=this.selectedBoxIndex:this._preSelected},pdGL.HotspotBoundingBox.prototype.isOver=function(e,t){return!!(this.visible&&this.active&&this._selected)&&this._isOverManipulator(e,t)},pdGL.HotspotBoundingBox.prototype.setDragAxisLock=function(e,t){if(e=pd.toInteger(e,0),!t&&7<=this.children.length&&(t=this.children[6]),t&&this._dragAxisLock!=e){switch(e){default:this._dragAxisLock=e,e=0;break;case 1:this._dragAxisLock=e,e=1;break;case 2:this._dragAxisLock=e,e=2;break;case 3:this._dragAxisLock=e,e=2==t.fixedPlane?2:1}var i=t.getMeshesByMaterial(m());if(0<i.length){var a=i[0];a.reuseStart(),d(a,v.origin,e,.4),a.reuseEnd(),a.compile(),gl.update()}}},pdGL.HotspotBoundingBox.prototype.moveModelPos=function(e,t){if(A(e,this.modelPos)){var i=this.modelPos,a=this.boundingBox.min,r=this.boundingBox.max,n=e[0]-i[0],s=e[1]-i[1],o=e[2]-i[2];i[0]=e[0],i[1]=e[1],i[2]=e[2],v.set(a,a[0]+n,a[1]+s,a[2]+o),v.set(r,r[0]+n,r[1]+s,r[2]+o);for(var l=0,d=this.children.length;l<d;++l){var h=this.children[l];h&&h.visible&&h.updatePos&&h.updatePos()}if(this.transformMatrix){var c=this.transformMatrix.m;c[3]=i[0],c[7]=i[1],c[11]=i[2]}var p=this.getMeshesByMaterial(pdGL.getDefaultMaterialMeshColor());return 0<p.length&&S(p[0],this.boundingBox),this.callbackOnChange&&this.callbackOnChange(this,t),gl.update(),this._hasMoved=!0}return!1},pdGL.HotspotBoundingBox.prototype._checkToUpdateExtents=function(e,t,i){var a=this.modelPos,r=[.5*(e[0]+t[0]),.5*(e[1]+t[1]),.5*(e[2]+t[2])];if(!A(e,this.boundingBox.min)&&!A(t,this.boundingBox.max))return!1;if(this.callbackOnChanging&&!this.callbackOnChanging(this,i,r,e,t))return!1;if(v.set(this.boundingBox.min,e[0],e[1],e[2]),v.set(this.boundingBox.max,t[0],t[1],t[2]),a[0]=r[0],a[1]=r[1],a[2]=r[2],!i.axis){for(var n=0,s=this.children.length;n<s;++n){var o=this.children[n];o&&o.visible&&o.updatePos&&o.updatePos()}if(this.transformMatrix){var l=this.transformMatrix.m;l[3]=a[0],l[7]=a[1],l[11]=a[2]}}var d=this.getMeshesByMaterial(pdGL.getDefaultMaterialMeshColor());return 0<d.length&&S(d[0],this.boundingBox),this.callbackOnChange&&this.callbackOnChange(this,i),gl.update(),this._hasMoved=!0},pdGL.HotspotBoundingBox.prototype._checkToMoveModelPos=function(e,t){var i=this._dragReferencePos,a=_(gl.orbitalView.snapGrid),r=this.boundingBox.min.slice(),n=this.boundingBox.max.slice();if(t.axis)switch(t.axis){case 1:n[0]=pd.snapTo(this._dragBoxOriginalPos.max[0]+(e[0]-i[0]),a);break;case-1:r[0]=pd.snapTo(this._dragBoxOriginalPos.min[0]+(e[0]-i[0]),a);break;case 2:n[1]=pd.snapTo(this._dragBoxOriginalPos.max[1]+(e[1]-i[1]),a);break;case-2:r[1]=pd.snapTo(this._dragBoxOriginalPos.min[1]+(e[1]-i[1]),a);break;case 3:n[2]=pd.snapTo(this._dragBoxOriginalPos.max[2]+(e[2]-i[2]),a);break;case-3:r[2]=pd.snapTo(this._dragBoxOriginalPos.min[2]+(e[2]-i[2]),a)}else{var s=this.modelPos,o=gl.orbitalView?1e-6*gl.orbitalView.getPointSize():1e-9,l=+this._dragAxisLock,d=this.boundingBox.axis;if(0==d&&this.boundingBox.showCenter){if(this.isViewedHorizontal){var h=Math.abs(gl.orbitalView.cameraAzi);h<45||135<h?(l=1==l?3:1<l?2:0,d=1):(l=1==l?1:1<l?3:0,d=2)}}else switch(l){case 1:e[1]=i[1],e[2]=i[2];break;case 2:e[0]=i[0],e[2]=i[2];break;case 3:e[0]=i[0],e[1]=i[1]}if(!v.closeTo(e,s,o)){var c=e[0]-this._dragReferencePos[0],p=e[1]-this._dragReferencePos[1],u=e[2]-this._dragReferencePos[2],g=n[0]-r[0],m=n[1]-r[1],f=n[2]-r[2];switch(d){case 1:case-1:l&&2!=l||(r[1]=pd.snapTo(this._dragBoxOriginalPos.min[1]+p,a)),l&&3!=l||(r[2]=pd.snapTo(this._dragBoxOriginalPos.min[2]+u,a));break;case 2:case-2:l&&1!=l||(r[0]=pd.snapTo(this._dragBoxOriginalPos.min[0]+c,a)),l&&3!=l||(r[2]=pd.snapTo(this._dragBoxOriginalPos.min[2]+u,a));break;default:l&&1!=l||(r[0]=pd.snapTo(this._dragBoxOriginalPos.min[0]+c,a)),l&&2!=l||(r[1]=pd.snapTo(this._dragBoxOriginalPos.min[1]+p,a))}n[0]=r[0]+g,n[1]=r[1]+m,n[2]=r[2]+f}}return this._checkToUpdateExtents(r,n,t)},pdGL.HotspotBoundingBox.prototype.handleSelectEvent=function(e,t,i){if(this.visible&&this.active){var a=this.getModelSelectionRadius(),r=this._ray.start=gl.orbitalView.canvasToModel(e.x,e.y,0).toArray(),n=this._ray.end=gl.orbitalView.canvasToModel(e.x,e.y,1).toArray();if(this._hasMoved=!1,this._selected&&(P=this._selectManipulator(r,n,a))&&this.callbackOnDragStart&&this.callbackOnDragStart(this,e),!(i||this._selected&&P)){var s,o,l=Number.MAX_VALUE;if(this._preSelectedBoxIndex=-1,this.subBoundingBoxes&&0<this.subBoundingBoxes.length)for(var d=this.subBoundingBoxes,h=0,c=d.length;h<c;++h)null!=(s=g.intersect(d[h],r,n))&&(o=v.distancePointToPoint(r,s))<l&&(this._preSelectedBoxIndex=h,l=o);if(this.defaultBoundingBox&&null!=(s=this.defaultBoundingBox.intersect?this.defaultBoundingBox.intersect(this,r,n):g.intersect(this.defaultBoundingBox,r,n))&&(o=v.distancePointToPoint(r,s))<l&&(this._preSelectedBoxIndex<0||!this.defaultBoundingBox.inactiveFace||s.axis!=this.defaultBoundingBox.inactiveFace)&&(this._preSelectedBoxIndex=C,l=o),this._preSelectedBoxIndex!=this.selectedBoxIndex){var p=!t;if(0<=this._preSelectedBoxIndex){var u=this.subBoundingBoxes[this._preSelectedBoxIndex];g.set(this._dragBoxOriginalPos,u.min,u.max,u.axis),S(this._preSelectedBoxMesh,u),p=!0,gl.update()}else if(this._preSelectedBoxIndex==C){u=this.defaultBoundingBox||this.boundingBox;g.set(this._dragBoxOriginalPos,u.min,u.max,u.axis),S(this._preSelectedBoxMesh,u),p=!0,gl.update()}return p}return!1}if(P)if(0<=this._preSelectedBoxIndex){u=this.subBoundingBoxes[this._preSelectedBoxIndex];g.set(this._dragBoxOriginalPos,u.min,u.max,u.axis)}else if(this._preSelectedBoxIndex==C){u=this.defaultBoundingBox||this.boundingBox;g.set(this._dragBoxOriginalPos,u.min,u.max,u.axis)}return P}return!1},pdGL.HotspotBoundingBox.prototype.handleDragEvent=function(e){if(this._selected){var t=this.selectedChildIndex;if(0<=t&&t<this.children.length){var i=this.children[t];i&&i.drag&&(this._ray.start=gl.orbitalView.canvasToModel(e.x,e.y,0).toArray(),this._ray.end=gl.orbitalView.canvasToModel(e.x,e.y,1).toArray(),i.drag(this._ray.start,this._ray.end))}}return this._preSelectedBoxIndex!=this.selectedBoxIndex&&(this._preSelectedBoxIndex=this.selectedBoxIndex),P},pdGL.HotspotBoundingBox.prototype.handleReleaseEvent=function(e){var t=P;return P=!1,t?(this._hasMoved&&this.callbackOnChanged&&this.callbackOnChanged(this,e),this.callbackOnDragEnd&&this.callbackOnDragEnd(this,e),this.setSelectedChildIndex(-1)):pdDOM.Interaction.hasMoved()||this._preSelectedBoxIndex!=this.selectedBoxIndex&&(this._preSelectedBoxIndex==C?(this.selectedBoxIndex=this._preSelectedBoxIndex,this.setBoundingBox(this.defaultBoundingBox),this.touchChild&&this.touchChild.show(e.isTouchEvent),this.setDragAxisLock(0),gl.update()):0<=this._preSelectedBoxIndex?(this.selectedBoxIndex=this._preSelectedBoxIndex,this.setBoundingBox(this.subBoundingBoxes[this.selectedBoxIndex]),this.touchChild&&this.touchChild.show(e.isTouchEvent),this.setDragAxisLock(0),gl.update()):this.setSelected(!1)),this._hasMoved=!1,t},pdGL.HotspotBoundingBox.prototype.handleDoubleTap=function(e){if(this.active&&this.visible&&this.boundingBox&&this._selected&&7<=this.children.length){var t=this.children[6];if(t&&t.visible&&(this._ray.start||(this._ray.start=gl.orbitalView.canvasToModel(e.x,e.y,0).toArray(),this._ray.end=gl.orbitalView.canvasToModel(e.x,e.y,1).toArray()),null!=g.intersect(this.boundingBox,this._ray.start,this._ray.end))){switch(t.fixedPlane){case 1:0==this._dragAxisLock?this.setDragAxisLock(2,t):2==this._dragAxisLock?this.setDragAxisLock(3,t):this.setDragAxisLock(0,t);break;case 2:0==this._dragAxisLock?this.setDragAxisLock(1,t):1==this._dragAxisLock?this.setDragAxisLock(3,t):this.setDragAxisLock(0,t);break;case 3:0==this._dragAxisLock?this.setDragAxisLock(1,t):1==this._dragAxisLock?this.setDragAxisLock(2,t):this.setDragAxisLock(0,t)}return!0}}return!1},pdGL.HotspotBoundingBox.prototype.handleDoubleTapCenterManipulator=function(){if(this.active&&this.visible&&this.boundingBox&&this._selected&&7<=this.children.length){var e=this.children[6];if(e&&e.visible){var t=v.create(),i=this.getModelSelectionRadius();if(e.distanceFromRay(this._ray.start,this._ray.end,t)<i){switch(e.fixedPlane){case 1:0==this._dragAxisLock?this.setDragAxisLock(2,e):2==this._dragAxisLock?this.setDragAxisLock(3,e):this.setDragAxisLock(0,e);break;case 2:0==this._dragAxisLock?this.setDragAxisLock(1,e):1==this._dragAxisLock?this.setDragAxisLock(3,e):this.setDragAxisLock(0,e);break;case 3:0==this._dragAxisLock?this.setDragAxisLock(1,e):1==this._dragAxisLock?this.setDragAxisLock(2,e):this.setDragAxisLock(0,e);break;default:this.boundingBox.showCenter&&(0==this._dragAxisLock?this.setDragAxisLock(1,e):1==this._dragAxisLock?this.setDragAxisLock(2,e):this.setDragAxisLock(0,e))}return!0}}}return!1},pdGL.HotspotBoundingBox.prototype._render=function(){if(this._selected){var e,t=y[3],i=b[3],a=this._opacity,r=gl.orbitalView.getVectorToCamera(this.modelPos[0],this.modelPos[1],this.modelPos[2]);this.selectedChildIndex<0&&(this.isViewedHorizontal=pdGL.Hotspot3D.altBelowFlipThresholdAngle(r));var n=pdGL.Hotspot3D.getRelativeSize()/Math.max(.25,gl.orbitalView.zoomFactor);this.relativeSize=n,this.callbackOnDraw&&this.callbackOnDraw(this);var s=pdGL.getDefaultMaterialMeshColor();if(gl.pushLineWidth(gl.getCanvasLineWidthThicker()),this.boundingBox){var o=this.getMeshesByMaterial(s);if(0<o.length)s.uniform("opacity",this._opacity).renderMeshes(o,u);else{var l=new pd3D.Mesh({colors:!0,lines:!0});S(l,this.boundingBox)&&(this.addMesh(l,s),s.uniform("opacity",this._opacity).renderMeshes(l,u))}}this._preSelectedBoxIndex!=this.selectedBoxIndex&&-1!=this._preSelectedBoxIndex&&this._preSelectedBoxMesh&&(gl.disable(gl.DEPTH_TEST),s.uniform("opacity",.5*this._opacity).renderMeshes(this._preSelectedBoxMesh,u),gl.enable(gl.DEPTH_TEST)),s.isRendering()&&s.endRender(),y[3]=a,m().uniform("color",y),gl.lineWidth(gl.getCanvasLineWidth());for(var d=0,h=this.children.length;d<h;++d){var c=this.children[d];c&&c.visible&&(c.setScale(n),e=this.selectedChildIndex==d?1:0,b[3]=e?Math.max(a,.6):.6*a,c._render(r,e))}y[3]=t,b[3]=i,gl.popLineWidth()}else this._preSelected&&this._preSelectedBoxIndex!=this.selectedBoxIndex&&-1!=this._preSelectedBoxIndex&&this._preSelectedBoxMesh&&(gl.pushLineWidth(gl.getCanvasLineWidthThicker()),gl.disable(gl.DEPTH_TEST),pdGL.getDefaultMaterialMeshColor().uniform("opacity",.5*this._opacity).renderMeshes(this._preSelectedBoxMesh,u).endRender(),gl.enable(gl.DEPTH_TEST),gl.popLineWidth())},pdGL.HotspotNorthArrow=function(e){var a=this;e=e||{},pdGL.Hotspot3D.call(this,e),this._angle=0,this._ringRadius=3.5,this._dragRadius=this._ringRadius,this.manipulatorPosition=null,this.manipulatorAngle=null,this.meshAxis=null,this.meshLines=null,this.callbackOnAngleChanging=e.callbackOnAngleChanging||null,this.transform=this.transformMatrix=new pd3D.Transform,this._createGeometry();var r=new pdDOM.Animation(function(e){a._dragRadius=e,gl.update()},{duration:.75,delay:3});this.cancelShrinkAnimation=function(){r.active&&r.cancel()},this.on("select:child",function(e,t,i){e||1!=i||t==i||a._dragRadius>a._ringRadius+.001&&r.start({fromValue:a._dragRadius,toValue:a._ringRadius})}),this.on("selected",function(){a._dragRadius=a._ringRadius,a.meshAxis.visible=!1,a.cancelShrinkAnimation()})},pdGL.HotspotNorthArrow.prototype=Object.create(pdGL.Hotspot3D.prototype),pdGL.HotspotNorthArrow.prototype.constructor=pdGL.HotspotNorthArrow,pdGL.HotspotNorthArrow.prototype._setAngle=function(e,t){if(e=pd.wrapAt(pd.toNumber(e,this._angle),-180,180),(t||!pd.closeTo(this._angle,e))&&(!this.callbackOnAngleChanging||this.callbackOnAngleChanging(this,e))){this._angle=e;var i=this.manipulatorAngle,a=pd.degreesToRadians(this._angle);return i.vectorOffset[0]=Math.sin(a),i.vectorOffset[1]=Math.cos(a),i.updatePos(),!0}return!1},pdGL.HotspotNorthArrow.prototype.angle=function(e,t){return arguments.length?(this._setAngle(e),gl.update(),this):this._angle},pdGL.HotspotNorthArrow.prototype._createGeometry=function(){this.addCenterSphere();var e=new pd3D.Mesh({lines:!0,defaultColor:[.4,.4,.4,1]});c(e,v.origin,2,.4),e.addLine(e.addVertex([0,.9,0]),e.addVertex([0,-.9,0])),e.addLine(e.addVertex([-.9,0,0]),e.addVertex([.9,0,0])),pd3D.Shapes.circle({radius:.725,background:!1,border:!0},e),e.compile(),this.addMesh(e,pdGL.getDefaultMaterialMeshColor()),this.manipulatorPosition=w(this),this.manipulatorPosition.axialXYOnly=!1,this.manipulatorPosition.fixedPlane=3,this.addChild(this.manipulatorPosition),this.manipulatorPosition.updatePos(),d(e=new pd3D.Mesh({normals:!1,lines:!0}),v.origin,1,.4),e.compile();var t=new x(this);t.addMesh(e,m()),t.vVector=e.defaultNormal,t.vectorOffset=[0,1,0],t.updatePos=O,t.drag=t._dragToPointer,t.axialXYOnly=!1,t.allowSnap=!1,t.fixedPlane=3,t.axis=3,this.manipulatorAngle=t,this.addChild(t),e=new pd3D.Mesh({lines:!0,defaultColor:y});var i=.765;pd3D.Shapes.circle({radius:i,radiusInner:i-.0025,segments:72},e),pd3D.Shapes.polygon({type:pd3D.Shapes.Type.SPOKES,size:i,thickness:.0025*i,tickSize:.025*i,segments:72},e),pd3D.Shapes.polygon({type:pd3D.Shapes.Type.SPOKES,size:.745875,thickness:.0025*i,tickSize:.015*i,segments:24},e);var a=.65;pd3D.Shapes.circle({radius:a,radiusInner:a-.0025,segments:72},e),pd3D.Shapes.polygon({type:pd3D.Shapes.Type.SPOKES,size:.66625,thickness:.0025*a,tickSize:.01625,segments:72},e),pd3D.Shapes.polygon({type:pd3D.Shapes.Type.SPOKES,size:.676,thickness:.0025*a,tickSize:.00975,segments:24},e),e.addQuad(e.addVertex([-.0015,0,0]),e.addVertex([.0015,0,0]),e.addVertex([.0015,.676,0]),e.addVertex([-.0015,.676,0])),e.addQuad(e.addVertex([-.0015,.96*i,0]),e.addVertex([.0015,.96*i,0]),e.addVertex([.0015,1.1,0]),e.addVertex([-.0015,1.1,0]));var r=[0,0,0],n=.035*a;pd3D.Font.setSize(n),pd3D.Font.aspectRatio(1),pd3D.Font.weight(300);for(var s=-180;s<180;s+=15)s%45&&(r[0]=.68575*pd.sinDegrees(s),r[1]=.68575*pd.cosDegrees(s),pd3D.Font.setRotation(-s,0,0,1),pd3D.Font.drawText(s.toFixed(0),r,e,pd.Align.CENTER,pd.Align.BOTTOM));pd3D.Font.setSize(1.25*n),pd3D.Font.weight(500);for(s=-135;s<=180;s+=45)r[0]=1.05*a*pd.sinDegrees(s),r[1]=1.05*a*pd.cosDegrees(s),pd3D.Font.setRotation(-s,0,0,1),pd3D.Font.drawText(s.toFixed(0),r,e,pd.Align.CENTER,pd.Align.BOTTOM);return pd3D.Font.clearRotations(),pd3D.Font.aspectRatio(1.25),pd3D.Font.weight(400),(this.meshAxis=e).compile(),(e=new pd3D.Mesh).addQuad(e.addVertex([-.0015,0,0]),e.addVertex([.0015,0,0]),e.addVertex([.0015,1.1,0]),e.addVertex([-.0015,1.1,0])),(this.meshLines=e).compile(),this._setAngle(this._angle,!0),this},pdGL.HotspotNorthArrow.prototype._checkToMoveModelPos=function(e,t){if(t==this.manipulatorAngle){var i=this.modelPos,a=v.normalize([e[0]-i[0],e[1]-i[1],0]),r=-v.azimuthBetweenVectors(v.unitY,a),n=pd.radiansToDegrees(r);n=pdGL.keys.SHIFT?pd.snapTo(n,15):pdGL.keys.CONTROL||pdGL.keys.META?pd.snapTo(n,.01):pd.snapTo(n,1);var s=v.distancePointToPoint(e,i)/this.relativeSize;if(this._dragRadius=Math.max(this._ringRadius,s),gl.update(),this._setAngle(n))return this.emit("angle",this._angle),this._hasMoved=!0}else if(A(e,this.modelPos)){if(this.callbackOnChanging&&!this.callbackOnChanging(this,t,e))return!1;v.set(this.modelPos,e);for(var o=0,l=this.children.length;o<l;++o){var d=this.children[o];d&&d.visible&&d.updatePos&&d.updatePos()}return this.callbackOnChange&&this.callbackOnChange(this,t),gl.update(),this._hasMoved=!0}return!1},pdGL.HotspotNorthArrow.prototype._render=function(){var e=y[3],t=b[3],i=pdGL.Hotspot3D.getRelativeSize(),a=this._opacity;for(var r in gl.pushMatrix(),gl.pushLineWidth(gl.getCanvasLineWidth()),this.relativeSize=i,this.callbackOnDraw&&this.callbackOnDraw(this),this.transform.setTranslation(this.modelPos),this.transform.setScale(i,i,i),gl.multMatrix(this.transform),gl.pushMatrix(),gl.rotate(-this._angle,0,0,1),this._preSelected&&!this._selected&&(a*=.6),y[3]=a,m().uniform("color",y),pdGL.getDefaultMaterialMeshColor().uniform("opacity",.75),this.geometry)if(this.geometry.hasOwnProperty(r)){var n=this.geometry[r];n.material.renderMeshes(n.meshes,u).endRender()}if(gl.popMatrix(),this.manipulatorAngle.updatePos(),this._selected||this._preSelected){var s,o=this._preSelected?-1:0,l=this.selectedChildIndex;this._preSelected&&gl.disable(gl.DEPTH_TEST);for(var d=0,h=this.children.length;d<h;++d){var c=this.children[d];c&&c.visible&&c._render&&(s=o||(l==d?1:0),b[3]=s?Math.max(a,.6):.6*a,c._render(null,s,a))}this._preSelected&&gl.enable(gl.DEPTH_TEST)}if(y[3]=e,b[3]=t,gl.popLineWidth(),gl.popMatrix(),this._selected){var p=this.modelPos;i=this._dragRadius*this.relativeSize,gl.pushMatrix(),gl.translate(p[0],p[1],p[2]),gl.scale(i,i,i),this.meshAxis.visible=!0,pdGL.getDefaultMaterialMeshColor().renderMeshes(this.meshAxis,gl.TRIANGLES).endRender(),gl.rotate(-this._angle,0,0,1),m().renderMeshes(this.meshLines,gl.TRIANGLES).endRender(),gl.popMatrix(),1==this.selectedChildIndex&&this.cancelShrinkAnimation()}}}(),(pdSVG=pdSVG||{}).Analemma=function(e){var t=this;if(null==(e=e||{}).elementId)throw new Error("A valid 'elementId' is required and must be an existing SVG element in the DOM.");var i=e.elementId,a=e.throttledRescale||0,d=e.solarPosition||new pd.SolarPosition,h=0,r=$(i),n=d3.select(i),s=r[0],o=360,l=365,c=183,p=180,u=3,g=180/Math.PI,m=-25,f=25,v=-30,_=30,x=1,b=1;r.empty();var y,S,M,w,L,D=n.append("g").attr("class","background"),E=n.append("g").attr("class","grid"),T=n.append("g").attr("class","analemma"),A=n.append("g").attr("class","datetime"),P=n.append("g").attr("class","markers"),C=!0,O=d3.format(".0f"),N=function(e){return O(e)+"°"};function G(e){return c+e*b}function I(e){return p-e*x}var R=d3.svg.line().x(function(e){return G(e[0])}).y(function(e){return I(e[1])}).interpolate("linear");function k(){l=+r.width(),o=+r.height(),c=.5*l,p=.5*o,s.setAttributeNS(null,"viewBox","0 0 "+l+" "+o),u=pd.mapAndConstrainTo(o,200,1024,2.5,4),b=l/(f-m),x=o/(_-v),C=!1}function V(){var e,t;C&&k(),D.text(""),D.append("rect").attr("class","background-daylight stroke-none").attr("x",0).attr("y",0).attr("width",l).attr("height",o),E.text("");for(var i=v+5;i<30;i+=5)t=I(i),E.append("line").attr("class","line-grid").attr("x1",G(m)).attr("y1",t).attr("x2",G(f)).attr("y2",t),E.append("line").attr("class","line-axis").attr("x1",c-3).attr("y1",t).attr("x2",c+3).attr("y2",t),E.append("text").text(N(i)).attr("text-anchor","start").attr("class","text-grid").attr("dy","0.4em").attr("x",c+5).attr("y",t);for(var a=l<300?5:1,r=a;r<f;r+=a)e=G(r),E.append("line").attr("class","line-grid").attr("x1",e).attr("y1",I(v)).attr("x2",e).attr("y2",I(_)),r%5||(E.append("line").attr("class","line-axis").attr("x1",e).attr("y1",p-3).attr("x2",e).attr("y2",p+3),E.append("text").text(O(r)).attr("text-anchor","middle").attr("class","text-grid").attr("dy","1.5em").attr("x",e).attr("y",p)),e=G(-r),E.append("line").attr("class","line-grid").attr("x1",e).attr("y1",I(v)).attr("x2",e).attr("y2",I(_)),r%5||(E.append("line").attr("class","line-axis").attr("x1",e).attr("y1",p-3).attr("x2",e).attr("y2",p+3),E.append("text").text(O(-r)).attr("text-anchor","middle").attr("class","text-grid").attr("dy","1.5em").attr("x",e).attr("y",p));E.append("text").text("Equation of Time (mins)").attr("text-anchor","start").attr("class","text-axis").attr("dy","-0.6em").attr("x",5).attr("y",p),t=I(v)-10,E.append("text").text("Declination Angle (degrees)").attr("transform","rotate(-90 "+c+","+t+")").attr("text-anchor","start").attr("class","text-axis").attr("dy","-0.6em").attr("x",c).attr("y",t),E.append("line").attr("class","line-axis").attr("x1",G(m)).attr("y1",p).attr("x2",G(f)).attr("y2",p),E.append("line").attr("class","line-axis").attr("x1",c).attr("y1",I(v)).attr("x2",c).attr("y2",I(_)),A.text(""),y=A.append("line").attr("class","hilite-axis"),S=A.append("circle").attr("class","hilite-circle").attr("r",.5*u),M=A.append("line").attr("class","hilite-axis"),w=A.append("circle").attr("class","hilite-circle").attr("r",.5*u),L=A.append("circle").attr("class","hilite-circle").attr("r",1.5*u),B()}function B(){T.text(""),P.text("");var e,t,i,a,r,n=[];h=d.year();for(var s=0;s<=364;s+=2)e=d.calcJulianCenturies(s,h),n.push([60*d.calcEquationOfTime(e),d.calcSolarDeclination(e)*g]);e=d.calcJulianCenturies(0,h),n.push([60*d.calcEquationOfTime(e),d.calcSolarDeclination(e)*g]),T.append("path").attr("d",R(n)).attr("class","line-marker").attr("fill","none");for(var o=["1 Jan","1 Feb","1 Mar","1 Apr","1 May","1 Jun","1 Jul","1 Aug","1 Sep","1 Oct","1 Nov","1 Dec"],l=0;l<12;++l){switch(e=d.calcJulianCenturiesByMonth(1,l,h),t=G(60*d.calcEquationOfTime(e)),i=I(d.calcSolarDeclination(e)*g),P.append("circle").attr("class","marker-shape").attr("r",u).attr("cx",t).attr("cy",i),l){case 5:r="start",a="-0.75em";break;case 11:r="start",a="1.25em";break;case 10:case 9:case 8:case 4:r="start",a="0.35em",t+=8;break;case 6:r="end",a="-0.75em";break;case 7:case 3:case 2:case 1:r="end",a="0.35em",t-=8;break;case 0:r="end",a="1.25em"}T.append("text").text(o[l]).attr("class","text-marker").attr("text-anchor",r).attr("dy",a).attr("x",t).attr("y",i)}U()}function U(){var e=d.dayOfMonth(),t=d.monthOfYear(),i=d.calcJulianCenturiesByMonth(e,t,h),a=G(60*d.calcEquationOfTime(i)),r=I(d.calcSolarDeclination(i)*g);y.attr("x1",a).attr("y1",r).attr("x2",a).attr("y2",p),S.attr("cx",a).attr("cy",p),M.attr("x1",a).attr("y1",r).attr("x2",c).attr("y2",r),w.attr("cx",c).attr("cy",r),L.attr("cx",a).attr("cy",r)}this.undoManager=function(e){return arguments.length?(undoManager=e,t):undoManager},this.observableDayOfYear=function(e){return arguments.length?(observableDayOfYear=e,t):observableDayOfYear},this.observableMinuteOfDay=function(e){return arguments.length?(observableMinuteOfDay=e,t):observableMinuteOfDay},this.solarPosition=function(e){return arguments.length?(d=e,t.refresh(),t):d},this.width=function(e){return arguments.length?(l=parseInt(e,10),r.width(l),t.refresh(),t):l},this.height=function(e){return arguments.length?(o=parseInt(e,10),r.height(o),t.refresh(),t):o},this.throttledRescale=function(e){return arguments.length?(a=pd.constrainTo(parseInt(e,10),0,5e3),t):a};var F=null;function H(){F=null,k(),V()}return this.rescale=function(){4<a?null==F&&(F=setTimeout(H,a)):H()},this.refresh=function(){V()},this.handleLocationChange=function(){},this.handleDateTimeChange=function(){h!=d.year()?B():U()},this.handleDateChange=function(){h!=d.year()?B():U()},this.handleTimeChange=function(){},this.activateTooltip=function(){},r.attr("class","svg-chart no-select no-touch"),s.style.cursor="default",this},(pdSVG=pdSVG||{}).DayLength=function(e){var i=this;if(null==(e=e||{}).elementId)throw new Error("A valid 'elementId' is required and must be an existing SVG element in the DOM.");var t=e.elementId,a=e.throttledRescale||0,o=e.solarPosition||new pd.SolarPosition,r=!1!==e.userInteraction,n=e.observableMinuteOfDay||null,s=e.observableDayOfYear||null,l=e.undoManager||null,d=e.isTouch||!1,h=$(t),c=d3.select(t),p=h[0],u=360,g=365,m=80,f=20,v=3,_=15,x=1;h.empty();var b,y,S,M,w,L,D,E=c.append("g").attr("class","bkgnd"),T=c.append("g").attr("class","daytime"),A=c.append("g").attr("class","grid"),P=c.append("g").attr("class","datetime"),C=c.append("g").attr("class","tooltip"),O=!0,N=d3.svg.area().x(function(e){return e.dayOfYear*x}).y0(function(e){return e.sunrise*_}).y1(function(e){return e.sunset*_}).interpolate("linear"),G=d3.svg.area().x(function(e){return e.dayOfYear*x}).y0(function(e){return e.civilDawn*_}).y1(function(e){return e.civilDusk*_}).interpolate("linear"),I=d3.svg.area().x(function(e){return e.dayOfYear*x}).y0(function(e){return e.nauticalDawn*_}).y1(function(e){return e.nauticalDusk*_}).interpolate("linear"),R=d3.svg.area().x(function(e){return e.dayOfYear*x}).y0(function(e){return e.astronomicalDawn*_}).y1(function(e){return e.astronomicalDusk*_}).interpolate("linear");function k(){g=+h.width(),u=+h.height(),p.setAttributeNS(null,"viewBox","0 0 "+g+" "+u),v=pd.mapAndConstrainTo(u,200,1024,2,4),_=u/24,x=g/364,O=!1}function V(){O&&k(),E.text(""),E.append("svg:rect").attr("class","fill-night stroke-none").attr("x",0).attr("y",0).attr("width",g).attr("height",u),A.text(""),A.append("svg:line").attr("class","line-axis stroke-dotted").attr("x1",0).attr("y1",12*_).attr("x2",g).attr("y2",12*_);for(var e=0;e<24;++e)A.append("svg:line").attr("class","line-grid").attr("x1",0).attr("y1",e*_).attr("x2",g).attr("y2",e*_),A.append("svg:text").text(e<10?"0"+e:e).attr("class","text-grid").attr("dy","0.3em").attr("x",5).attr("y",(e+.5)*_);for(var t=1,i=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],a=[0,31,59,90,120,151,181,212,243,273,304,334,364],r=1;r<12;++r)A.append("svg:line").attr("class","line-grid").attr("x1",a[r]*x).attr("y1",0).attr("x2",a[r]*x).attr("y2",u),A.append("svg:text").text(i[t++]).attr("text-anchor","middle").attr("class","text-grid").attr("x",Math.round(.5*(a[r]+a[r+1]))*x).attr("y",u-7);C.text("").style("display","none"),C.append("svg:rect").attr("class","tooltip").attr("x",0).attr("y",0).attr("width",m).attr("height",f),C.append("text").attr("class","tooltip tooltip-datetime").attr("text-anchor","middle").attr("x",.5*m).attr("y",.7*f),P.text(""),b=P.append("svg:line").attr("class","hilite-axis"),y=P.append("svg:line").attr("class","hilite-axis"),S=P.append("svg:circle").attr("class","hilite-circle").attr("r",1.5*v),M=P.append("svg:circle").attr("class","hilite-shape").attr("r",v),w=P.append("svg:text").attr("class","text-hilite"),L=P.append("svg:circle").attr("class","hilite-shape").attr("r",v),D=P.append("svg:text").attr("class","text-hilite"),B()}function B(){var e=o.clockTime(),t=o.dayOfYear();T.text("");var i=o.getSunriseSunsetAsObjectArray(1);T.selectAll("fill-astronomical").data([i]).enter().append("path").attr("class","fill-astronomical").attr("d",function(e){return R(e)}),T.selectAll("fill-nautical").data([i]).enter().append("path").attr("class","fill-nautical").attr("d",function(e){return I(e)}),T.selectAll("fill-civil").data([i]).enter().append("path").attr("class","fill-civil").attr("d",function(e){return G(e)}),T.selectAll("background-daylight").data([i]).enter().append("path").attr("class","background-daylight").attr("d",function(e){return N(e)}),o.dayOfYear(t),o.clockTime(e),U()}function U(){var e=o.dayOfYear(),t=o.clockTime()*_,i=e*x;b.attr("x1",0).attr("y1",t).attr("x2",g).attr("y2",t),y.attr("x1",i).attr("y1",0).attr("x2",i).attr("y2",u),S.attr("cx",i).attr("cy",t);var a=e<183?"start":"end",r=e<183?4:-4;o.latitude()<-10&&31<e&&e<334&&(a=e<183?"end":"start",r=-r);var n=o.sunriseTime();M.attr("cx",i).attr("cy",n*_),w.text(o.formatAsTime(n)).attr("text-anchor",a).attr("x",i+r).attr("y",n*_+10);var s=o.sunsetTime();L.attr("cx",i).attr("cy",s*_),D.text(o.formatAsTime(s)).attr("text-anchor",a).attr("x",i+r).attr("y",s*_-4),"none"!=C.style("display")&&Z()}this.undoManager=function(e){return arguments.length?(l=e,i):l},this.observableDayOfYear=function(e){return arguments.length?(s=e,i):s},this.observableMinuteOfDay=function(e){return arguments.length?(n=e,i):n},this.solarPosition=function(e){return arguments.length?(o=e,i.refresh(),i):o},this.width=function(e){return arguments.length?(g=parseInt(e,10),h.width(g),i.refresh(),i):g},this.height=function(e){return arguments.length?(u=parseInt(e,10),h.height(u),i.refresh(),i):u},this.throttledRescale=function(e){return arguments.length?(a=pd.constrainTo(parseInt(e,10),0,5e3),i):a},this.userInteraction=function(e){if(!arguments.length)return r;var t=!1!==e;return t&&!r?h.on("mousedown touchstart",i.handlePointerDown).on("mousemove touchmove",i.handlePointerMove):!t&&r&&(p.style.cursor="default",h.off("mousedown touchstart",i.handlePointerDown).off("mousemove touchmove",i.handlePointerMove)),r=t,i};var F=null;function H(){F=null,k(),V()}this.rescale=function(){4<a?null==F&&(F=setTimeout(H,a)):H()},this.refresh=function(){V()},this.handleLocationChange=function(){B()},this.handleDateTimeChange=function(){U()},this.handleDateChange=function(){U()},this.handleTimeChange=function(){U()},this.activateTooltip=function(){"none"==C.style("display")&&(C.style("display","inline"),Z()),null!=X&&clearTimeout(X),X=setTimeout(function(){C.style("display","none"),X=null},1500)};var z=0,W=1,j=2,X=null,Y={minute:-1,day:-1},q={minute:-1,day:-1},J=z,Q=!1;function Z(){var e=o.dayOfYear(),t=o.clockTime(),i=e*x-10-m,a=t*_-10-f;i<5&&(i=e*x+10),a<5&&(a=t*_+10),C.select(".tooltip-datetime").text(o.formatAsTime(t)+", "+o.formatAsDate(e)),C.attr("transform",function(){return"translate("+i+", "+a+")"})}function K(e,t){t=t||{minute:-1,day:-1};var i=p.getBoundingClientRect();return t.minute=Math.round((e.pageY-i.top)/(i.bottom-i.top)*24*60),t.day=Math.round((e.pageX-i.left)/(i.right-i.left)*365),t}function ee(e){var t=K(e);J!=W&&(s?s(t.day):o.setDayOfYear(t.day)),J!=j&&(n?n(t.minute):o.setTimeOfDay(t.minute/60)),e.preventDefault()}function te(e){var t=K(e);J=z;var i=n?n():60*o.clockTime();pd.closeTo(t.minute,i,30)&&(J+=W);var a=s?s():o.dayOfYear();return pd.closeTo(t.day,a,5)&&(J+=j),J}function ie(e){if(Q){if(e.preventDefault(),e=pd.preprocessMouseOrTouchEvent(e,p),d&&J==z){var t=K(e);t.minute=Y.minute+(t.minute-q.minute),t.day=Y.day+(t.day-q.day),J!=W&&(s?s(t.day):o.setDayOfYear(t.day)),J!=j&&(n?n(t.minute):o.setTimeOfDay(t.minute/60))}else ee(e);e.preventDefault()}}this.handlePointerDown=function(e){e.preventDefault(),1==(e=pd.preprocessMouseOrTouchEvent(e,p)).which?(K(e,q),Y.minute=n?n():60*o.clockTime(),Y.day=s?s():o.dayOfYear(),window.addEventListener("mousemove",ie,!0),window.addEventListener("touchmove",ie,!0),window.addEventListener("touchcancel",re,!0),window.addEventListener("touchend",re,!0),window.addEventListener("mouseup",re,!0),l&&l.storeValues(s,n),te(e)==z&&(d||ee(e)),null!=X&&clearTimeout(X),C.style("display","inline"),Q=!0):Q=!1};var ae=-1;function re(e){window.removeEventListener("mousemove",ie,!0),window.removeEventListener("touchmove",ie,!0),window.removeEventListener("touchcancel",re,!0),window.removeEventListener("touchend",re,!0),window.removeEventListener("mouseup",re,!0),Q=!1,l&&l.checkForChanges(),null!=X&&clearTimeout(X),X=setTimeout(function(){C.style("display","none"),X=null},1500),J=-1,i.handlePointerMove(e)}return this.handlePointerMove=function(e){Q?d||J!=z?J==z&&(p.style.cursor="cell"):(p.style.cursor="pointer",J=3):(ae=J,te(e=pd.preprocessMouseOrTouchEvent(e,p))!=ae&&(p.style.cursor=J==W?"ns-resize":J==j?"ew-resize":3==J?"pointer":"default"))},h.attr("class","svg-chart no-select no-touch"),r&&$(document).ready(function(){h.on("mousedown touchstart",i.handlePointerDown).on("mousemove touchmove",i.handlePointerMove)}),this},function(){var u=!1,g=0,m=0,f=0,v=0,_=0;pd.preprocessMouseOrTouchEvent=function(t,e,i){var a={};for(var r in t)"function"==typeof t[r]?a[r]=function(e){return function(){e.apply(t,arguments)}}(t[r]):a[r]=t[r];var n=0<(a.original=t).type.length&&"p"==t.type.charAt(0)&&t.pointerType&&"touch"==t.pointerType;if(0<a.type.length&&"t"==a.type.charAt(0)){var s=a.targetTouches||a.originalEvent.targetTouches;if(s&&0<s.length){u="touchmove"==a.type,g=s.length,a.button=g,a.which=g,n=!0;var o=0;if(!isNaN(i)&&0<=i)for(var l=0,d=s.length;l<d;++l)if(i==s[l].identifier){o=l;break}var h=s[o];a.pageX=h.pageX,a.pageY=h.pageY}}else switch(a.type){case"pointerdown":if(n){a.which=g+1;break}case"mousedown":0<a.which&&(g=a.which);break;case"pointermove":a.which=g;case"mousemove":u=0<g;break;case"pointerup":if(n){t.isPrimary&&(u=!1),a.which=g;break}case"mouseup":0<a.which&&(g=0,u=!1);break;case"mousewheel":case"DOMMouseScroll":a.delta=pd.sign(pdDOM.getScrollIncrement(t));break;case"keydown":a.delta=pd.sign(pdDOM.getKbdIncrement(t))}if(a.x=a.pageX,a.y=a.pageY,e&&e.getBoundingClientRect){var c=1/pdDOM.pageScale,p=e.getBoundingClientRect();p.left&&(a.x-=Math.round(p.left*c)),p.top&&(a.y-=Math.round(p.top*c))}return n?(u?(a.dragX=a.x-m,a.dragY=a.y-f):(a.dragX=0,a.dragY=0),m=a.x,f=a.y):(u?(a.dragX=a.x-v,a.dragY=a.y-_):(a.dragX=0,a.dragY=0),v=a.x,_=a.y),a.dragging=u,a.preventDefault=function(){a.original.preventDefault()},a.stopPropagation=function(){a.original.stopPropagation()},a}}(),pdGL.SunPath3D=function(r,t){var n=this,i=(t=t||{}).radius||1e3,_=t.arrowSize||1,s=t.arrowStyle||0,x=t.labelAngle||15,b=t.tickOffset||.0075,y=t.textSize||.02,S=t.tickSize||.01,u=t.solarPosition||new pd.SolarPosition,a=!1!==t.horizonClipping,o=t.center||[0,0,0],l=t.lineWidthThin||r.getCanvasLineWidthThin(),d=t.lineWidthThick||r.getCanvasLineWidthThick(),h=t.colorDiagramLines||[.4,.4,.4,1],c=t.colorDiagramText||[.1,.1,.1,1],p=t.colorCurrentDateTime||[1,0,0,1],g=t.colorSunPathLines||[.8,.5,.1,1],m=t.colorSunPathMesh||[1,1,0,1],f=t.colorSolarArrow||[0,0,.75,1],v=t.colorAngleLines||[1,0,0,1],M=t.colorAngleMesh||[1,1,1,.75],w=t.showNorth||!1,L=pd.constrainTo(t.dayIncrement||2,1,30),D=pd.constrainTo(t.timeIncrement||.03125,.01,3),E=t.dayForMonthLine||21,T=!1,A=t.shadingMask||null,P=!1,C=1,O=.15,N=1,G=(new pd.SolarPosition).setLocation(0,0,0),I=new pd3D.MatrixAccumulator,R=new pd3D.MatrixAccumulator,k=new pd3D.Vector,V=[0,0,0],B=new pd3D.Matrix,U=new pd3D.Matrix,F=new pd3D.Matrix,H=new pd3D.Matrix,z={baseAxis:new pd3D.Mesh({triangles:!1,lines:!0,twoSided:!0}),baseAxisText:new pd3D.Mesh({triangles:!0,twoSided:!0}),annualShell:new pd3D.Mesh({normals:!0,lines:!0,twoSided:!0}),annualSunPath:new pd3D.Mesh({triangles:!1,lines:!0}),solarArrow:new pd3D.Mesh({triangles:!1,colors:!0,lines:!0}),angleLines:new pd3D.Mesh({triangles:!0,lines:!0,colors:!0,twoSided:!0,visible:!1}),dailySunPath:new pd3D.Mesh({triangles:!0,lines:!0,twoSided:!0}),solarSphere:new pd3D.Shapes.sphere({normals:!0,radius:.0125}),shading:new pd3D.Mesh({triangles:!0,colors:!0,lines:!0,twoSided:!0})};this.PROJ_SPHERICAL=0,this.PROJ_EQUIDISTANT=1,this.PROJ_STEREOGRAPHIC=2,this.PROJ_CARTESIAN=3;var W=pd.constrainTo(pd.toInteger(t.projectionType,this.PROJ_SPHERICAL),this.PROJ_SPHERICAL,this.PROJ_CARTESIAN),j=[W==this.PROJ_SPHERICAL?1:0,W==this.PROJ_EQUIDISTANT?1:0,W==this.PROJ_STEREOGRAPHIC?1:0],X=new pdGL.Shader("\nuniform mat4 objMatrix;\nvarying vec4 worldPosition;\n\nvoid main() {\n    gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;\n    worldPosition = objMatrix * gl_Vertex;\n}\n","\nuniform vec4 color;\nuniform float opacity;\nvarying vec4 worldPosition;\n\nvoid main() {\n    float alpha = clamp(opacity * color.a, 0.0, 1.0);\n    gl_FragColor = vec4(color.rgb, alpha);\n    if (worldPosition.z < 0.0)\n        discard;\n}\n"),Y=new pdGL.Shader("\nvarying vec3 vNormal;\nvarying vec3 vVertexDir;\n\nvoid main() {\n    vNormal = gl_NormalMatrix * gl_Normal;\n    gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;\n    vec4 vtx = gl_ModelViewMatrix * gl_Vertex;\n    vVertexDir = vtx.xyz / vtx.w;\n}\n","\nuniform float sunIntensity;\nvarying vec3 vVertexDir;\nvarying vec3 vNormal;\n\nvoid main() {\n    if (sunIntensity > 0.0) {\n        float viewIncidence = abs(dot(normalize(vVertexDir), normalize(vNormal)));\n        float incidence = (viewIncidence > 0.95) ? 1.0 - (20.0 * (viewIncidence - 0.9499)) : viewIncidence;\n        float opacity = sunIntensity * 0.75 * clamp(pow(incidence, 2.5), 0.0, 1.0);\n        gl_FragColor = vec4(1.0, 1.0, 0.0, opacity);\n    } else {\n        discard;\n    }\n}\n"),q=new pdGL.Shader("\nuniform vec4 color;\nuniform vec3 projection;\nuniform bool useVertexColors;\nvarying vec4 vColor;\n\nconst float PI = 3.141592653589793238463;\nconst float PIon2 = PI / 2.0;\nconst float PIon4 = PI / 4.0;\n\nfloat atan2(in float y, in float x) {\n    return x == 0.0 ? sign(y) * (PI / 2.0) : atan(y, x);\n}\n\nvoid main() {\n    float azi = PIon2 - atan2(gl_Vertex.y, gl_Vertex.x);\n    float alt = atan2(gl_Vertex.z, length(gl_Vertex.xy));\n    float radius = projection.x * cos(alt);\n    radius += projection.y * abs(1.0 - (alt / PIon2));\n    radius += projection.z * (1.0 - (atan(clamp(alt / PIon2, 0.0, 1.0)) / PIon4));\n    vColor = (useVertexColors == true) ? gl_Color : color;\n    vec4 pos = vec4(radius * sin(azi), radius * cos(azi), 0.0, 1.0);\n    gl_Position = gl_ModelViewProjectionMatrix * pos;\n}\n","\nuniform float opacity;\nvarying vec4 vColor;\nvarying float zPos;\n\nvoid main() {\n    float alpha = clamp(opacity * vColor.a, 0.0, 1.0);\n    gl_FragColor = vec4(vColor.rgb, alpha);\n    if (alpha < 0.001) {\n        discard;\n    }\n}\n"),J=pdGL.Material.VariableColorUniformPointSize(),Q=pdGL.Material.FixedColorUniformPointSize(),Z=a?X:Q.shader();function K(e){return 1e-9<e[0]||e[0]<-1e-9||1e-9<e[1]||e[1]<-1e-9||1e-9<e[2]||e[2]<-1e-9}function $(){if(z.annualShell.visible){var e=z.annualShell;e.triangles.length=0;for(var t,i,a=e.vertices.length=0,r=0,n=u.year(),s=0,o=0,l=0,d=[171,211,231,252,272,292,313,354],h=d.length-1;0<=h;h--){if(i=d[h],G.setDayOfYear(Math.round(i),n).calculate(),G.getHourlySunPathAsPositions3D(.25,V,1,!1,e),0==s&&(s=e.vertices.length),0<a){l=a,o=r;for(var c=1;c<s-1;++c)e.triangles.push([o,l,l+1]),e.triangles.push([l+1,o+1,o]),o++,l++;e.triangles.push([o,l,a]),e.triangles.push([a,r,o]),r=a}c=a;for(var p=e.vertices.length;c<p;++c)t=e.vertices[c],e.normals.push([t[0],t[1],t[2]]);a=e.vertices.length}e.compile()}}function ee(){if(z.annualSunPath.visible){var e=z.annualSunPath,t=u.year();e.vertices.length=0,e.lines.length=0,G.setDayMonthYear(21,5,t).calculate(),G.getHourlySunPathAsPositions3D(.25,V,1,!0,e);G.dayOfYear();for(var i in[6,7,8,9,10])G.setDayMonthYear(E,i,t).calculate(),G.getHourlySunPathAsPositions3D(D,V,1,!1,e);G.setDayMonthYear(21,11,t).calculate(),G.getHourlySunPathAsPositions3D(.25,V,1,!0,e),G.dayOfYear();for(var a=0;a<24;++a)G.setTimeOfDay(a),G.getAnalemmaSunPathAsPositions3D(12==a?4:L,V,1,12==a,e);e.compile()}}function te(){if(z.solarArrow.visible){var e=z.solarArrow;if(e.vertices.length=0,e.colors.length=0,e.lines.length=0,.1<s){var t=1.5*_,i=.02*_;e.color(f),e.addVertex([0,0,0]),e.addVertex([t,0,0]),t-=s*i,e.addVertex([t,0,-i]),e.addVertex([t,0,i]),e.lines.push([0,1]),e.lines.push([1,2]),e.lines.push([1,3])}else e.color(f),e.addVertex([0,0,0]),e.addVertex([1,0,0]),e.color([f[0],f[1],f[2],0]),e.addVertex([10,0,0]),e.lines.push([0,1]),e.lines.push([1,2]);e.compile()}}function ie(){var e=z.dailySunPath;e.reuseStart(),e.visible?G.setDayOfYear(u.dayOfYear(),u.year()):u.latitude()<0?G.setDayOfYear(354,u.year()):G.setDayOfYear(171,u.year()),G.reuseHourlySunPathAsPositions3D(.25,V,1,!0,e);var t,i=u.latitude()<0?-1.5*y:1.5*y,a=.2*i,r=0,n=e._vtx_index;u.latitude()<0?pd3D.Matrix.scale(-y,-y,-y,U):pd3D.Matrix.scale(y,y,y,U);for(var s=0;s<n;s+=4)r++<24&&(t=e.vertices[s],e.addLine(e.addVertex([t[0],t[1]+a,t[2]]),e.addVertex([t[0],t[1]-a,t[2]])));pd3D.Font.weight(400);for(s=r=0;s<n;s+=4)r<24&&(t=e.vertices[s],pd3D.Matrix.translate(t[0],t[1]+i,t[2],F),F.multiplyBy(pd3D.Matrix.rotate(180+r/24*360,0,-1,0)),F.multiplyBy(U),pd3D.Font.addText(r<10?"0"+r:r.toString(),pd.Align.CENTER,pd.Align.CENTER,F,e)),r++;e.reuseEnd(),e.compile()}function ae(e,t,i){for(var a,r=0,n=i.vertexCount(),s=0;s<=1;s+=.01)a=1-s,i.addVertex([a*e[0]+s*t[0],a*e[1]+s*t[1],a*e[2]+s*t[2]]),n++,++r%2&&i.addLine(n-1,n)}function re(){if(k.normalize(),pd3D.Matrix.translate(k.x,k.y,k.z,B),R.reset().rotate(90-u.azimuthAngle(),0,0,1).rotate(u.altitudeAngle(),0,-1,0),z.angleLines.visible){var e=z.angleLines,t=1.25*y,i=u.azimuthAngle(),a=u.altitudeAngle(),r=1.05+4*S+y;e.reuseStart(),e.color(M),pd3D.Matrix.rotate(-i,0,0,1,H),H.multiplyBy(pd3D.Matrix.rotate(-90,0,1,0));var n={width:.025,radius:r,center:V,defaultNormal:[0,0,1],defaultColor:[1,0,0,.5],fromAngle:0,toAngle:i,triangles:!0,colors:!0,lines:!0};pd3D.Shapes.circularArrow(n,e),n.center=[0,0,0],n.toAngle=a,n.transform=H,pd3D.Shapes.circularArrow(n,e),e.color(p);var s=r+.025+.1,o=i*pd.Const.DEG2RAD,l=Math.sin(o),d=Math.cos(o),h=[s*l,s*d,0];z.solarArrow.visible||ae(V,pd3D.Vector.multiply(k,s).toArray(),e),ae(V,[0,s,0],e),ae(V,h,e),r+=.025+.6*t,h[0]=r*Math.sin(.5*o),h[1]=r*Math.cos(.5*o),pd3D.Font.weight(400),pd3D.Matrix.scale(t,t,t,U),pd3D.Matrix.translate(h[0],h[1],h[2],F),F.multiplyBy(pd3D.Matrix.rotate(-.5*i,0,0,1)),F.multiplyBy(U),pd3D.Font.addText(i.toFixed(2)+"`",pd.Align.CENTER,pd.Align.CENTER,F,e);var c=.5*(a*pd.Const.DEG2RAD);s=r*Math.cos(c),h[0]=s*l,h[1]=s*d,h[2]=r*Math.sin(c),pd3D.Matrix.translate(h[0],h[1],h[2],F),F.multiplyBy(pd3D.Matrix.rotate(-i,0,0,1)),F.multiplyBy(pd3D.Matrix.rotate(.5*a,1,0,0)),F.multiplyBy(pd3D.Matrix.rotate(-90,0,1,0)),F.multiplyBy(U),pd3D.Font.addText(a.toFixed(2)+"`",pd.Align.CENTER,pd.Align.CENTER,F,e),e.reuseEnd(),e.compile()}}function ne(){z.shading.visible&&pd.Shading&&(A||(A=new pd.Shading(t.shadingOptions)),A.generateMesh(z.shading,t.shadingData,N),t.shadingData=null)}function se(){I.reset().rotate(u.latitude(),1,0,0).rotate(u.timezoneCorrection()/24*360,0,-1,0),ie(),T=!0}function oe(e,t){var i=!1;switch(t=!!t,e){case n.Component.AXIS:z.baseAxisText.visible=t,z.baseAxis.visible=t;break;case n.Component.ANNUAL_AREA:(z.annualShell.visible=t)&&z.annualShell.vertices.length<1&&($(),T||se());break;case n.Component.ANNUAL_LINES:(z.annualSunPath.visible=t)&&z.annualSunPath.vertices.length<1&&(ee(),T||se());break;case n.Component.SUN_DIRECTION:(z.solarArrow.visible=t)&&z.solarArrow.vertices.length<1&&te(),z.angleLines.visible&&re();break;case n.Component.SUN_ANGLES:i=t&&!z.angleLines.visible,z.angleLines.visible=t,(i||t&&z.angleLines.vertices.length<1)&&re();break;case n.Component.DIURNAL_SUN_PATH:i=t&&!z.dailySunPath.visible,z.dailySunPath.visible=t,i&&(ie(),T||se());break;case n.Component.SUN_POSITION:z.solarSphere.visible=t;break;case n.Component.SHADING:z.shading.visible!=t&&z.shading.visible==t&&(z.shading.vertices.length<1?ne():P&&n.updateShading());break;case n.Component.ALL:for(var a=n.Component.ALL-1;0<=a;a--)oe(a,t)}}return this.Component={AXIS:0,ANNUAL_AREA:1,ANNUAL_LINES:2,SUN_DIRECTION:3,SUN_ANGLES:4,DIURNAL_SUN_PATH:5,SUN_POSITION:6,SHADING:7,ALL:8},z.baseAxis.visible=void 0===t.showAxis||!!t.showAxis,z.baseAxisText.visible=void 0===t.showAxis||!!t.showAxis,z.annualShell.visible=void 0===t.showAnnualArea||!!t.showAnnualArea,z.annualSunPath.visible=void 0===t.showAnnualLines||!!t.showAnnualLines,z.solarArrow.visible=void 0===t.showSunDirection||!!t.showSunDirection,z.angleLines.visible=void 0!==t.showSunAngles&&!!t.showSunAngles,z.dailySunPath.visible=void 0===t.showSunPath||!!t.showSunPath,z.solarSphere.visible=void 0===t.showSunPos||!!t.showSunPos,z.shading.visible=void 0!==t.showShading&&!!t.showShading,this.visible=!0,this.show=function(e){for(var t,i=0,a=(t=void 0!==e&&e.length?e:arguments).length;i<a;++i)oe(+t[i],!0);return n},this.hide=function(e){for(var t,i=0,a=(t=void 0!==e&&e.length?e:arguments).length;i<a;++i)oe(+t[i],!1);return n},this.isVisible=function(e){switch(e){case n.Component.AXIS:return z.baseAxis.visible;case n.Component.ANNUAL_AREA:return z.annualShell.visible;case n.Component.ANNUAL_LINES:return z.annualSunPath.visible;case n.Component.SUN_DIRECTION:return z.solarArrow.visible;case n.Component.SUN_ANGLES:return z.angleLines.visible;case n.Component.DIURNAL_SUN_PATH:return z.dailySunPath.visible;case n.Component.SUN_POSITION:return z.solarSphere.visible;case n.Component.ALL:return z.baseAxis.visible&&z.baseAxisText.visible&&z.annualShell.visible&&z.annualSunPath.visible&&z.solarArrow.visible&&z.angleLines.visible&&z.dailySunPath.visible&&z.solarSphere.visible}return!1},this.showAll=function(){return z.baseAxis.show(!0),z.baseAxisText.show(!0),z.annualShell.show(!0),z.annualSunPath.show(!0),z.solarArrow.show(!0),z.angleLines.show(!0),z.dailySunPath.show(!0),z.solarSphere.show(!0),n},this.components=function(){return z},this.setCenterAndRadius=function(e,t){return this.center(e),this.radius(t),n},this.moveTo=function(e,t,i){return o[0]=pd.toNumber(e,o[0]),o[1]=pd.toNumber(t,o[1]),o[2]=pd.toNumber(i,o[2]),n},this.radius=function(e){return arguments.length?(i=pd.toNumber(e,i),n):i},this.center=function(e){return arguments.length?(pd.isArray(e)&&3<=e.length&&(o=e),n):o},this.solarPosition=function(e){return arguments.length?(u=e,se(),n):u},this.lineWidthThin=function(e){return arguments.length?(l=pd.toNumber(e,l),n):l},this.lineWidthThick=function(e){return arguments.length?(d=pd.toNumber(e,d),n):d},this.dayForMonthLine=function(e){return arguments.length?((e=pd.constrainTo(parseInt(e,10),1,31))!=E&&(E=e,ee()),n):E},this.horizonClipping=function(e){return arguments.length?(a=pd.toBoolean(e,a),Z=a?X:Q.shader(),n):a},this.projectionType=function(e){return arguments.length?(e=pd.constrainTo(pd.toInteger(e,n.PROJ_EQUIDISTANT),n.PROJ_SPHERICAL,n.PROJ_CARTESIAN),j[0]=e==this.PROJ_SPHERICAL?1:0,j[1]=e==this.PROJ_EQUIDISTANT?1:0,j[2]=e==this.PROJ_STEREOGRAPHIC?1:0,W=e,n):W},this.projectionTransitions=function(){return j},this.colorCurrentDateTime=function(e){if(!arguments.length)return p;if(!pd.isArray(e)||4!=e.length)throw new Error("Color values must be given as [r,g,b,a] arrays.");return p=e,n},this.colorDiagramLines=function(e){if(!arguments.length)return h;if(!pd.isArray(e)||4!=e.length)throw new Error("Color values must be given as [r,g,b,a] arrays.");return h=e,n},this.colorDiagramText=function(e){if(!arguments.length)return c;if(!pd.isArray(e)||4!=e.length)throw new Error("Color values must be given as [r,g,b,a] arrays.");return c=e,n},this.colorSolarArrow=function(e){if(!arguments.length)return f;if(!pd.isArray(e)||4!=e.length)throw new Error("Color values must be given as [r,g,b,a] arrays.");return f=e,n},this.colorAngleLines=function(e){if(!arguments.length)return v;if(!pd.isArray(e)||4!=e.length)throw new Error("Color values must be given as [r,g,b,a] arrays.");return v=e,n},this.colorAngleMesh=function(e){if(!arguments.length)return M;if(!pd.isArray(e)||4!=e.length)throw new Error("Color values must be given as [r,g,b,a] arrays.");return M=e,n},this.colorSunPathLines=function(e){if(!arguments.length)return g;if(!pd.isArray(e)||4!=e.length)throw new Error("Color values must be given as [r,g,b,a] arrays.");return g=e,n},this.colorSunPathMesh=function(e){if(!arguments.length)return m;if(!pd.isArray(e)||4!=e.length)throw new Error("Color values must be given as [r,g,b,a] arrays.");return m=e,n},this.skyFactorLuminance=0,this.skyFactorUniform=0,this.shadingMask=function(e){return arguments.length?((A=e)||z.shading.clear(),n):(A||(A=new pd.Shading(t.shadingOptions)),A)},this.getShadingIterator=function(){return A?A.getShadingIterator():null},this.showSkySegments=function(e){return arguments.length?(O=e?.6:.15,n):.2<O},this.getShading=function(){return A?A.getShadingData():null},this.setShadingSegmentValue=function(e,t){return A&&A.setSkyPatchShading(e,t),n},this.setShadingSegmentColor=function(e,t){return A&&A.setSkyPatchColor(e,t),n},this.updateShading=function(e){if(A)if(z.shading.visible){e&&A.generateMesh(z.shading,null,N);var t=A.updateMesh(z.shading);n.skyFactorLuminance=t.skyFactorLuminance,n.skyFactorUniform=t.skyFactorUniform,P=!1}else P=!0;return n},this.setShading=function(e,t){return A&&A.setShadingData(e),t||n.updateShading(),n},this.clearShading=function(e){return A&&A.clearShadingData(),e||n.updateShading(),n},this.projectOnDome=function(t){if(A){var i=!1;if(t&&N<1||!t&&0<N)return r.animationQueue.add(function(e){return!t&&0<N?(N-=2*e)<0&&(i=!(N=0)):t&&N<1&&1<(N+=2*e)&&(N=1,i=!0),A.transitionShape(N,z.shading),r.update(),i}),!0}return!1},this.animateShading=function(e){if(A&&e){return A.setShadingData(e),r.animationQueue.add(function(e){return 1<C&&(C=1,!0),A.transitionData(C,z.shading),r.update(),!1}),!(C=0)}return!1},this.handleLocationChange=function(){return se(),n},this.handleDateChange=function(){return ie(),n},this.handleTimeChange=function(e){return e?k.init(e):k.fromArray(u.getSunDirection()),re(),n},this.handleDateTimeChange=function(){n.handleDateChange(),n.handleTimeChange()},this.handleNorthChange=function(){return n},this.getAABB=function(e){return this.visible&&(e&&e.min||((e={min:new pd3D.Vector(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}).max=e.min.negative()),e.min.x>o[0]-i&&(e.min.x=o[0]-i),e.min.y>o[1]-i&&(e.min.y=o[1]-i),e.min.z>o[2]&&(e.min.z=o[2]),e.max.x<o[0]+i&&(e.max.x=o[0]+i),e.max.y<o[1]+i&&(e.max.y=o[1]+i),e.max.z<o[2]+i&&(e.max.z=o[2]+i)),e},this.drawOutlines=function(){if(this.visible){r.pushMatrix(),r.pushLineWidth(),K(o)&&r.translate(o[0],o[1],o[2]),r.scale(i,i,i);var e=u.northOffset();if(pd.closeTo(e,0,.001)||r.rotate(-e,0,0,1),z.baseAxis.visible&&(r.lineWidth(l),Q.uniform("color",h).drawOutline(z.baseAxis)),z.baseAxisText.visible&&(pd3D.Font.isTriangulated?Q.uniform("color",c).drawSurface(z.baseAxisText):(r.lineWidth(d),Q.uniform("color",c).drawOutline(z.baseAxisText))),z.solarArrow.visible&&(r.pushMatrix(),r.multMatrix(R.toMatrix()),r.lineWidth(.5*(d+l)),.1<s?Q.uniform("color",f).drawOutline(z.solarArrow):J.drawOutline(z.solarArrow),r.popMatrix()),z.angleLines.visible&&(r.lineWidth(l),Q.uniform("color",v).drawOutline(z.angleLines)),z.annualSunPath.visible||z.dailySunPath.visible){r.pushMatrix();var t=I.toMatrix();Z.uniforms({opacity:1,objMatrix:t}),r.multMatrix(t),z.annualSunPath.visible&&(r.lineWidth(l),Z.uniforms({color:g}).draw(z.annualSunPath,r.LINES)),z.dailySunPath.visible&&(r.lineWidth(z.annualSunPath.visible?d:l),Z.uniforms({color:p}).draw(z.dailySunPath,r.LINES)),r.popMatrix()}z.shading.visible&&(pd.closeTo(e,0,.001)||r.rotate(e,0,0,1),r.depthMask(!1),r.lineWidth(l),Q.uniform("color",h).pushUniform("opacity",O).drawOutline(z.shading).popUniform(),J.pushUniform("opacity",.5).drawSurface(z.shading).popUniform(),r.depthMask(!0)),r.popLineWidth(),r.popMatrix()}return n},this.drawSurfaces=function(){if(this.visible){r.pushMatrix(),K(o)&&r.translate(o[0],o[1],o[2]),r.scale(i,i,i);var e=u.northOffset();if(pd.closeTo(e,0,.001)||r.rotate(-e,0,0,1),z.solarSphere.visible&&(r.pushMatrix(),r.multMatrix(B),Q.uniform("color",p).drawSurface(z.solarSphere),r.scale(4,4,4),r.depthMask(!1),Y.uniforms({sunIntensity:pd.mapAndConstrainTo(k.z,.0523359,.1564345,0,1)}).draw(z.solarSphere,r.TRIANGLES),r.depthMask(!0),r.popMatrix()),z.angleLines.visible&&J.uniform("opacity",1).drawSurface(z.angleLines),z.annualShell.visible||z.dailySunPath.visible){r.pushMatrix();var t=I.toMatrix();Z.uniforms({objMatrix:t}),r.multMatrix(t),r.depthMask(!1),r.setCullFace(!1),z.dailySunPath.visible&&Z.uniforms({opacity:1,color:p}).draw(z.dailySunPath,r.TRIANGLES),z.annualShell.visible&&Z.uniforms({opacity:.15,color:m}).draw(z.annualShell,r.TRIANGLES),r.depthMask(!0),r.setCullFace(),r.popMatrix()}z.shading.visible&&(pd.closeTo(e,0,.001)||r.rotate(e,0,0,1),r.depthMask(!1),J.pushUniform("opacity",.5).drawSurface(z.shading).popUniform(),r.depthMask(!0)),r.popMatrix()}return n},this.draw2D=function(e,t){if(z.shading.visible){r.clearColor(1,1,1,1),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.orbitalView.startOverlay2D(1e3,1e3),r.pushMatrix(),r.pushLineWidth(),t=pd.toNumberInRange(t,256,1,Number.POSITIVE_INFINITY),r.translate(+e,+e,0),r.scale(t,-t,1);var i=u.northOffset();pd.closeTo(i,0,.001)||r.rotate(i,0,0,1),q.uniforms({projection:j}),q.uniforms({opacity:1,useVertexColors:!0}).draw(z.shading,r.TRIANGLES),r.lineWidth(l),.2<O?q.uniforms({opacity:O,color:c,useVertexColors:!1}).draw(z.shading,r.LINES):q.uniforms({opacity:1,useVertexColors:!0}).draw(z.shading,r.LINES),r.setCullFace(),r.popLineWidth(),r.popMatrix(),r.orbitalView.endOverlay2D()}return n},this.draw2DFull=function(e,t){if(this.visible){if(r.pushMatrix(),r.pushLineWidth(),r.disable(r.DEPTH_TEST),r.setCullFace(!1),r.depthMask(!1),t=pd.toNumberInRange(t,256,1,Number.POSITIVE_INFINITY),r.translate(+e,1.05*+e,0),r.scale(+t,-t,50),Q.uniform("opacity",1),J.uniform("opacity",1),z.shading.visible){r.pushMatrix();var i=u.northOffset();pd.closeTo(i,0,.001)||r.rotate(i,0,0,1),q.uniforms({opacity:1,useVertexColors:!0}).draw(z.shading,r.TRIANGLES),r.lineWidth(l),.2<O?q.uniforms({opacity:O,color:c,useVertexColors:!1}).draw(z.shading,r.LINES):q.uniforms({opacity:1,useVertexColors:!0}).draw(z.shading,r.LINES),r.popMatrix()}if(z.annualSunPath.visible||z.dailySunPath.visible){r.pushMatrix();var a=I.toMatrix();Z.uniforms({opacity:1,objMatrix:a}),r.multMatrix(a),z.dailySunPath.visible&&(r.lineWidth(z.annualSunPath.visible?d:l),Z.uniforms({color:p}).drawModes(z.dailySunPath,[r.LINES,r.TRIANGLES])),z.annualSunPath.visible&&(r.lineWidth(d),Z.uniforms({color:g}).draw(z.annualSunPath,r.LINES)),r.popMatrix()}z.solarArrow.visible&&(r.pushMatrix(),r.multMatrix(R.toMatrix()),r.lineWidth(.5*(d+l)),.1<s?Q.uniform("color",f).drawOutline(z.solarArrow):J.drawOutline(z.solarArrow),r.popMatrix()),z.angleLines.visible&&(r.lineWidth(l),Q.uniform("color",v).drawOutline(z.angleLines),J.drawSurface(z.angleLines)),z.solarSphere.visible&&(r.pushMatrix(),r.multMatrix(B),r.scale(1.75,1.75,1.75),Q.uniform("color",p).drawSurface(z.solarSphere),r.popMatrix()),z.baseAxis.visible&&(r.lineWidth(l),Q.uniform("color",h).drawOutline(z.baseAxis)),z.baseAxisText.visible&&Q.uniform("color",c).drawSurface(z.baseAxisText),r.setCullFace(),r.depthMask(!0),r.enable(r.DEPTH_TEST),r.popLineWidth(),r.popMatrix()}return n},this.drawWithMaterial=function(e,t){return this.visible&&(t==r.TRIANGLES?n.drawSurfaces():t==r.LINES&&n.drawOutlines()),n},this.draw=function(e){return this.visible&&(e==r.LINES||e==pd3D.RENDER_FIRST?n.drawOutlines():n.drawSurfaces()),n},function(){var e,t,i=z.baseAxis;i.reuseStart();for(var a,r,n,s,o,l=1+b,d=l+S,h=l+2.5*S,c=l+1.5*S,p=l+3*S+.6*y,u=0;u<=360;++u)e=pd.sinDegrees(u),t=pd.cosDegrees(u),a=u%5?d:u%15==0?h:c,r=i.addVertex([e,t,0]),n=i.addVertex([l*e,l*t,0]),s=i.addVertex([a*e,a*t,0]),i.addLine(n,s),0<u&&i.addLine(o,r),o=r;i.addLine(i.addVertex([0,-h,0]),i.addVertex([0,h,0])),i.addLine(i.addVertex([-h,0,0]),i.addVertex([h,0,0])),i.reuseEnd(),i.compile();var g=z.baseAxisText;g.reuseStart();var m="",f=y;for(pd3D.Font.weight(400),pd3D.Matrix.scale(f,f,f,U),u=0;u<360;u+=x)u%45&&(pd3D.Matrix.translate(p*pd.sinDegrees(u),p*pd.cosDegrees(u),0,F),F.multiplyBy(pd3D.Matrix.rotate(-u,0,0,1)),F.multiplyBy(U),pd3D.Font.addText(u.toString(),pd.Align.CENTER,pd.Align.CENTER,F,g));if(pd3D.Font.weight(600),f*=1.25,w){var v=y*_;pd3D.Matrix.scale(1.5*f,1.5*f,1.5*f,U),pd3D.Matrix.translate(0,h+1.41421*v+f,0,F),F.multiplyBy(U),pd3D.Font.addText("N",pd.Align.CENTER,pd.Align.CENTER,F,g),g.addTriangle(g.addVertex([0,h+1.41421*v,0]),g.addVertex([-v,h,0]),g.addVertex([v,h,0]))}for(pd3D.Matrix.scale(f,f,f,U),u=w?45:0;u<360;u+=45){switch(u){case 0:m="N";break;case 45:m="NE";break;case 90:m="E";break;case 135:m="SE";break;case 180:m="S";break;case 225:m="SW";break;case 270:m="W";break;case 315:m="NW"}pd3D.Matrix.translate(p*pd.sinDegrees(u),p*pd.cosDegrees(u),0,F),F.multiplyBy(pd3D.Matrix.rotate(-u,0,0,1)),F.multiplyBy(U),pd3D.Font.addText(m,pd.Align.CENTER,pd.Align.CENTER,F,g)}g.reuseEnd(),g.compile()}(),$(),ee(),function(){if(z.solarSphere.visible){var e=z.solarSphere,t=.01*_;e.vertices=e.vertices.map(function(e){return pd3D.Vector.fromArray(e).normalize().scale(t).toArray()}),e.compile()}}(),te(),re(),ne(),(z.annualShell.visible||z.annualSunPath.visible)&&se(),this.visible=pd.toBoolean(t.visible,!0),this},(pdSVG=pdSVG||{}).SunPath2D=function(e){var b=this;if(null==(e=e||{}).elementId)throw new Error("A valid 'elementId' is required and must be an existing SVG element in the DOM.");var t=e.elementId||"svg",s=e.solarPosition||new pd.SolarPosition,y=pd.toBoolean(e.showBackground,!0),S=pd.toBoolean(e.fullScreenRect,!1),i=pd.toBoolean(e.userInteraction,!0),o=pd.toInteger(e.dayForMonthlyLines,21),a=pd.toInteger(e.throttledRescale,0),r=pd.toInteger(e.minChartWidth,0),n=pd.toInteger(e.minChartHeight,0),l=pd.toBoolean(e.showSkySegments,!1),d=e.undoManager||null,h=e.observableLatitude||null,c=e.observableLongitude||null,M=pd.toNumber(e.tooltipHeight,20),w=pd.toNumber(e.tooltipWidth,80),L=e.shadingMask||null,p=0,u=0,g=null,m=$(t),f=d3.select(t),v=m[0],D=720,E=720,_=.44,T=D*_,A=3;m.empty(),f.append("style");var P=f.append("g").attr({id:"background",class:"background no-pointer"}),x=f.append("g").attr({id:"world-map",class:"world-map"}),C=f.append("g").attr({id:"shading",class:"shading"}),O=f.append("g").attr({id:"shading-offset",class:"shading offset"}).style("visibility","hidden"),N=f.append("g").attr({id:"diagram",class:"diagram no-pointer"}),G=f.append("g").attr({id:"diagram-text",class:"diagram-text no-pointer"}),I=f.append("g").attr({id:"sun-angles",class:"sun-angles no-pointer"}),R=f.append("g").attr({id:"sun-arc",class:"sun-arc no-pointer"}),k=f.append("g").attr({id:"sun-path",class:"sun-path no-pointer"}),V=f.append("g").attr({id:"sun-pos",class:"sun-pos no-pointer"}),B=f.append("g").attr({id:"sun-line",class:"sun-line no-pointer"}),U=f.append("g").attr({id:"overlay",class:"overlay no-pointer"}),F=f.append("g").attr({id:"tooltip",class:"chart-tooltip no-pointer"}),H=null,z=null,W=pd.toBoolean(e.showDataOverlay,!1),j=pd.toBoolean(e.showLegend,!1),X=e.callbackDblClickLegend||null,Y=0,q=null,J=null,Q=null,Z=null,K=null,ee=null,te=null,ie=null,ae=null,re=null,ne=null,se=null,oe=null,le=null,de=null,he=null,ce=null,pe=null,ue=null,ge=!0,me=!1,fe=new pd.SolarPosition,ve=null;this.Component={AXIS:0,ANNUAL_AREA:1,ANNUAL_LINES:2,WORLD_MAP:3,SUN_ANGLES:4,DIURNAL_SUN_PATH:5,SUN_POSITION:6,SHADING:7,ALL:8};var _e=[void 0===e.showAxis||!!e.showAxis,void 0===e.showAnnualArea||!!e.showAnnualArea,void 0===e.showAnnualLines||!!e.showAnnualLines,void 0!==e.showWorldMap&&!!e.showWorldMap,void 0===e.showSunAngles||!!e.showSunAngles,void 0===e.showSunPath||!!e.showSunPath,void 0===e.showSunPos||!!e.showSunPos,void 0!==e.showShading&&!!e.showShading,!1];N.style("visibility",_e[b.Component.AXIS]?"visible":"hidden"),G.style("visibility",_e[b.Component.AXIS]?"visible":"hidden"),x.style("visibility",_e[b.Component.WORLD_MAP]?"visible":"hidden"),R.style("visibility",_e[b.Component.ANNUAL_AREA]?"visible":"hidden"),k.style("visibility",_e[b.Component.ANNUAL_LINES]?"visible":"hidden"),I.style("visibility",_e[b.Component.SUN_ANGLES]?"visible":"hidden"),B.style("visibility",_e[b.Component.DIURNAL_SUN_PATH]?"visible":"hidden"),V.style("visibility",_e[b.Component.SUN_POSITION]?"visible":"hidden"),C.style("visibility",_e[b.Component.SHADING]?"visible":"hidden"),F.style("visibility","display","none"),this.PROJ_SPHERICAL=0,this.PROJ_EQUIDISTANT=1,this.PROJ_STEREOGRAPHIC=2,this.PROJ_CARTESIAN=3;var xe=pd.constrainTo(pd.toInteger(e.projectionType,this.PROJ_SPHERICAL),this.PROJ_SPHERICAL,this.PROJ_CARTESIAN),be=xe,ye=1,Se=1;function Me(e,t,i){switch(e){default:case b.PROJ_SPHERICAL:return[Math.cos(i)*Math.sin(t),-Math.sin(i)];case b.PROJ_STEREOGRAPHIC:return[(a=1/(1+(r=Math.cos(t))*(n=Math.cos(i))))*n*Math.sin(t),-a*Math.sin(i)];case b.PROJ_EQUIDISTANT:var a,r=Math.cos(t),n=Math.cos(i),s=Math.acos(r*n);return[(a=.638*(s&&s/Math.sin(s)))*n*Math.sin(t),-a*Math.sin(i)];case b.PROJ_CARTESIAN:return[t/Math.PI*1.134*Se,i/Math.PI*4.54]}}function we(e,t,i){switch(e){default:case b.PROJ_SPHERICAL:return[Math.cos(i)*Math.sin(t),Math.sin(i)];case b.PROJ_STEREOGRAPHIC:return[(a=1/(1+(r=Math.cos(t))*(n=Math.cos(i))))*n*Math.sin(t),a*Math.sin(i)];case b.PROJ_EQUIDISTANT:var a,r=Math.cos(t),n=Math.cos(i),s=Math.acos(r*n);return[(a=.638*(s&&s/Math.sin(s)))*n*Math.sin(t),a*Math.sin(i)];case b.PROJ_CARTESIAN:return[t*Se,i]}}var Le=d3.geo.equirectangular().precision(.1).translate([D/2,E]).scale(T),De=d3.geo.projection(function(e,t){if(ye<.999){var i=1-ye,a=Me(be,e,t),r=Me(xe,e,t);return[i*a[0]+ye*r[0],i*a[1]+ye*r[1]]}return Me(xe,e,t)}).translate([D/2,E/2]).scale(T).rotate([0,-90]).clipAngle(90.1).precision(.1),Ee=d3.geo.path().projection(De),Te=d3.geo.projection(function(e,t){switch(xe){default:var i=Math.cos(e),a=Math.cos(t),r=1/(1+i*a);return[r*a*Math.sin(e),-r*Math.sin(t)];case b.PROJ_CARTESIAN:return[e/Math.PI*1.134*Se,t/Math.PI*4.54]}}).translate([D/2,E/2]).scale(T).rotate([0,-90]).clipAngle(91.5).precision(.1),Ae=d3.geo.path().projection(Te),Pe=d3.geo.projection(function(e,t){if(ye<.999){var i=1-ye,a=we(be,e,t),r=we(xe,e,t);return[i*a[0]+ye*r[0],i*a[1]+ye*r[1]]}return we(xe,e,t)}).translate([D/2,E/2]).rotate([0,-51.5]).scale(T).clipAngle(90.1).precision(.1),Ce=d3.geo.path().projection(Pe),Oe=null,Ne=null;function Ge(){S||xe!=b.PROJ_CARTESIAN?(Ne=Te,Oe=De):Oe=Ne=Le,Ee.projection(Oe),Ae.projection(Ne)}function Ie(){D=Math.max(r,+m.width()),E=Math.max(n,+m.height()),v.setAttributeNS(null,"viewBox","0 0 "+(D+1)+" "+(E+1)),xe==b.PROJ_CARTESIAN?S?T=.775*E*_:.305*E<(T=.35*D*_)&&(T=.305*E):T=Math.min(D,E)*_,A=pd.mapAndConstrainTo(T,135,250,2,3);var e=D/2,t=E/2;Se=D/E/.775,xe==b.PROJ_CARTESIAN&&S&&(t=.775*E),Le.translate([e,t]).scale(T),De.translate([e,t]).rotate([0,xe==b.PROJ_CARTESIAN?0:-90]).clipAngle(xe==b.PROJ_CARTESIAN?null:90.1).scale(T),Te.translate([e,t]).rotate([0,xe==b.PROJ_CARTESIAN?0:-90]).clipAngle(xe==b.PROJ_CARTESIAN?null:91.5).scale(T),Pe.translate([e,E/2]).scale(T),f.selectAll(".land").attr("d",Ce),f.selectAll(".countries path").attr("d",Ce),ge=!1}function Re(e,t){ge&&Ie(),x.text(""),x.append("path").datum(topojson.object(t,t.objects.land)).attr("class","land").attr("d",Ce),x.append("g").attr("class","countries").selectAll("path").data(topojson.object(t,t.objects.countries).geometries).enter().append("path").attr("d",Ce)}function ke(){ge&&Ie(),N.text(""),G.text(""),P.text(""),q=N.append("path").datum(d3.geo.graticule()).attr("class","tweenable line-grid").attr("d",Ee);var e=[],t=[],i=T<400?-1.2:-.75,a=5,r=1;xe==b.PROJ_CARTESIAN&&(i=-.3,D<1100&&(a=15,r=5));for(var n=0;n<360;n+=r)n%a?e.push([[n,0],[n,i]]):t.push([[n,0],[n,2*i]]);if(N.append("path").datum({type:"MultiLineString",coordinates:e}).attr("class","tickable line-axis").attr("d",Ae),N.append("path").datum({type:"MultiLineString",coordinates:t}).attr("class","tickable line-black").attr("d",Ae),N.append("path").datum({type:"MultiLineString",coordinates:[[[0,0],[179.99,0]],[[0,0],[-179.99,0]],[[0,90],[0,0]]]}).attr("class","tweenable line-axis").attr("opacity",.4).attr("d",Ee),xe==b.PROJ_CARTESIAN){var s=Ne([-180,90]),o=Ne([180,0]),l=o[0]-s[0]+1,d=o[1]-s[1],h=" M "+s[0]+" "+s[1]+" l "+l+" 0 l 0 "+d+" l -"+l+" 0 l 0 -"+d+" Z";y?P.append("path").attr("class","stroke-none background-"+(_e[b.Component.WORLD_MAP]?"map":"daylight")).attr("d",h):P.append("path").attr("class","tweenable fade-out line-grid").attr("d",h),S||(o=Ne([180,-90]),N.append("rect").attr("class","line-axis").attr("x",s[0]).attr("y",s[1]).attr("width",o[0]-s[0]).attr("height",o[1]-s[1])),s=Ne([-180,0]),o=Ne([180,-.83333]),P.append("rect").attr("class","background-map").attr("x",s[0]-1).attr("y",s[1]).attr("width",o[0]-s[0]+2).attr("height",o[1]-s[1]);var c=y?1:.75;s=Ne([-180,-.83333]),o=Ne([180,-6]),P.append("line").attr("class","line-axis stroke-dashed").attr("opacity","0.8").attr("x1",s[0]).attr("y1",s[1]).attr("x2",o[0]).attr("y2",s[1]),P.append("rect").attr("class","fill-civil").attr("fill-opacity",c).attr("x",s[0]-1).attr("y",s[1]).attr("width",o[0]-s[0]+2).attr("height",o[1]-s[1]),P.append("text").text("Civil Twilight").attr("text-anchor","start").attr("class","text-twilight-dark").attr("x",(s[0]+o[0])/2+5).attr("y",(s[1]+o[1])/2).attr("dy",4),s=Ne([-180,-6]),o=Ne([180,-12]),P.append("rect").attr("class","fill-nautical").attr("fill-opacity",c).attr("x",s[0]-1).attr("y",s[1]).attr("width",o[0]-s[0]+2).attr("height",o[1]-s[1]),P.append("text").text("Nautical Twilight").attr("text-anchor","end").attr("class","text-twilight").attr("x",(s[0]+o[0])/2-5).attr("y",(s[1]+o[1])/2).attr("dy",4),s=Ne([-180,-12]),o=Ne([180,-18]),P.append("rect").attr("class","fill-astronomical").attr("fill-opacity",c).attr("x",s[0]-1).attr("y",s[1]).attr("width",o[0]-s[0]+2).attr("height",o[1]-s[1]),P.append("text").text("Astronomical Twilight").attr("text-anchor","start").attr("class","text-twilight").attr("x",(s[0]+o[0])/2+5).attr("y",(s[1]+o[1])/2).attr("dy",4),s=Ne([-180,-18]),o=Ne([180,-90]),S&&(o[1]=E),P.append("rect").attr("class","fill-night").attr("fill-opacity",c).attr("x",s[0]-1).attr("y",s[1]).attr("width",o[0]-s[0]+2).attr("height",o[1]-s[1]),P.append("text").text("Night-time").attr("text-anchor","middle").attr("class","text-twilight").attr("x",(s[0]+o[0])/2).attr("y",(s[1]+o[1])/2).attr("dy",4),G.append("g").selectAll("text").data(d3.range(-180,181,30)).enter().append("text").each(function(e){var t=Ne([e,0]);d3.select(this).attr("class","text-axis bold3").attr("text-anchor","middle").attr("x",t[0]).attr("y",t[1]-10)}).attr("dy",".35em").text(function(e){return 0===e?"N":90===e?"E":-180===e||180===e?"S":-90===e||270===e?"W":e+"°"}),G.append("g").selectAll(".altitude-markers").data(d3.range(10,81,10)).enter().append("text").each(function(e){var t=Oe([0,e]);d3.select(this).attr("class","text-grid").attr("text-anchor","start").attr("x",t[0]+4).attr("y",t[1])}).attr("dy","0.4em").text(function(e){return e+"°"}),G.append("g").selectAll(".twilight-markers").data(d3.range(-18,0,6)).enter().append("text").each(function(e){var t=Oe([0,e]);d3.select(this).attr("class","text-grid").attr("text-anchor","start").attr("x",t[0]+4).attr("y",t[1])}).attr("dy","0.4em").text(function(e){return e+"°"})}else{var p=d3.geo.circle().origin([0,90]).angle(90);y&&P.append("path").datum(p).attr("class","tweenable stroke-none background-"+(_e[b.Component.WORLD_MAP]?"map":"daylight")).attr("d",Ee),N.append("path").datum(p).attr("class","tweenable fade-out line-black").attr("d",Ee);var u=pd.mapAndConstrainTo(T,100,1024,1,.1);N.append("path").datum({type:"MultiLineString",coordinates:[[[0,90],[90,0]],[[0,90],[-90,0]],[[0,90],[180,0]]]}).attr("class","tweenable line-axis").attr("opacity",.4).attr("d",Ee),G.append("g").selectAll("text").data(d3.range(-180,180,15)).enter().append("text").each(function(e){var t=Ne([e,-5*u]);d3.select(this).attr("class","text-axis bold6").attr("transform","rotate("+e+" "+t[0]+" "+t[1]+")").attr("text-anchor","middle").attr("x",t[0]).attr("y",t[1])}).attr("dy",".5em").text(function(e){return 0===e?"N":90===e?"E":-180===e||180===e?"S":-90===e||270===e?"W":e+"°"}),G.append("g").selectAll("text").data(d3.range(10,81,10)).enter().append("text").each(function(e){var t=Oe([0,e]);d3.select(this).attr("class","text-grid").attr("text-anchor","start").attr("x",t[0]+2).attr("y",t[1])}).attr("dy",".35em").text(function(e){return e+"°"})}(z=N.append("g")).style("visibility",_e[b.Component.WORLD_MAP]?"visible":"hidden");var g=0,m=0;if(xe==b.PROJ_CARTESIAN){var f=Oe([-10,_=S?32:0]),v=Oe([10,_]);z.append("line").attr("class","line-blue").attr("x1",f[0]).attr("y1",f[1]).attr("x2",v[0]).attr("y2",v[1]),g=Math.round(.5*(f[0]+v[0])),m=Math.round(.5*(f[1]+v[1])),f=Oe([0,S?28:41]),v=Oe([0,S?36:49]),z.append("line").attr("class","line-blue").attr("x1",f[0]).attr("y1",f[1]).attr("x2",v[0]).attr("y2",v[1])}else{var _=85;switch(xe){case b.PROJ_EQUIDISTANT:_=82.5;break;case b.PROJ_STEREOGRAPHIC:_=80}f=Oe([-90,_]),v=Oe([90,_]);z.append("line").attr("class","line-blue").attr("x1",f[0]).attr("y1",f[1]).attr("x2",v[0]).attr("y2",v[1]),g=Math.round(.5*(f[0]+v[0])),m=Math.round(.5*(f[1]+v[1])),f=Oe([0,_]),v=Oe([-180,_]),z.append("line").attr("class","line-blue").attr("x1",f[0]).attr("y1",f[1]).attr("x2",v[0]).attr("y2",v[1])}(H=N.append("g")).style("visibility","hidden");h=" M "+(g+12)+" "+(m-18)+" l -4 10 l 10 -4 M "+(g+8)+" "+(m-8)+" l 20 -20 l 25 0";H.append("path").attr("class","line-blue").attr("d",h),H.append("text").text("Map Location").attr("text-anchor","start").attr("class","text-blue").attr("x",g+58).attr("y",m-28).attr("dy","0.4em"),V.text("");var x=.5*A+"px";V.append("circle").attr("fill","none").attr("stroke","yellow").attr("stroke-width",x).attr("r",2.25*A),V.append("circle").attr("fill","none").attr("opacity","0.5").attr("stroke","yellow").attr("stroke-width",x).attr("r",2.75*A),V.append("circle").attr("fill","none").attr("opacity","0.15").attr("stroke","yellow").attr("stroke-width",x).attr("r",3.25*A),V.append("circle").attr("class","hilite-circle").attr("r",1.5*A),I.text(""),K=I.append("line").attr("class","hilite-axis"),Z=I.append("circle").attr("class","hilite-circle").attr("r",.5*A),Q=I.append("line").attr("class","hilite-axis"),J=I.append("circle").attr("class","hilite-circle").attr("r",.5*A),ee=I.append("circle").attr("class","hilite-axis").attr("r",0),W&&(re||(re=U.append("text").attr({class:"text-overlay","text-anchor":"start",x:5,y:5,dy:"0.9em"}),ne=U.append("text").attr({class:"text-overlay","text-anchor":"start",x:5,y:20,dy:"0.9em"}),se=U.append("text").attr({class:"text-overlay","text-anchor":"start",x:5,y:35,dy:"0.9em"}))),j&&function(){if(!oe&&L){var e;Y=115.5,oe=U.append("g").attr({id:"sp2d-legend",class:"legend"}),ce=oe.append("text").attr({class:"text-overlay","text-anchor":"end",x:0,y:5,dy:"0.9em"}),le=oe.append("text").attr({class:"text-axis","text-anchor":"end",x:-18,y:22,dy:"0.9em"}),de=oe.append("text").attr({class:"text-axis","text-anchor":"end",x:-18,y:68.75,dy:"0.5em"}),he=oe.append("text").attr({class:"text-axis","text-anchor":"end",x:-18,y:115.5,dy:"0.0em"});for(var t=0;t<=30;++t)e=L.luminanceColorScaleAsHex(1-t/30),oe.append("rect").attr({fill:e,stroke:"none",x:-15,y:22+3*t,width:15,height:3.5});oe.append("rect").attr({class:"line-axis",x:-15,y:22,width:15,height:93.5}),pe=oe.append("path").attr("d","m3,9v11h14V9M4,9V6c0-3.3 2.7-6 6-6c3.3,0 6,2.7 6,6v3H14V6c0-2.2-1.8-4-4-4-2.2,0-4,1.8-4,4v3").attr("transform","translate(-13.5, 26), scale(0.6)").attr("class","hidden").attr("fill","white")}oe.attr("transform","translate("+(D-5)+", 0)")}(),function(){var e=Math.round(w-8),t=Math.round(M-8),i=Math.round(.5*e),a="";ae||(F.attr("opacity","0"),ae=F.append("path").attr("class","tooltip"),te=F.append("text").text("0.00").attr({class:"tooltip",x:0,y:-Math.round(.5*M)-20,"text-anchor":"middle",dy:"0.4em"}),ie=F.append("path").attr("d","m3,9v11h14V9M4,9V6c0-3.3 2.7-6 6-6c3.3,0 6,2.7 6,6v3H14V6c0-2.2-1.8-4-4-4-2.2,0-4,1.8-4,4v3").attr("transform","translate("+(i+6)+", "+(-Math.round(.5*M)-6-20)+"), scale(0.6)").attr("class","tooltip hidden"),F.append("line").attr({class:"line-black",x1:-5,y1:0,x2:5,y2:0}),F.append("line").attr({class:"line-black",x1:0,y1:-5,x2:0,y2:5}));a+="M"+-i+","+(-M-20),a+=" h"+e,a+=" a4,4 0 0 1 4,4",a+=" v"+t,a+=" a4,4 0 0 1 -4,4",a+=" h"+(5-i),a+=" l-5,12",a+=" l-5,-12",a+=" h"+(5-i),a+=" a4,4 0 0 1 -4,-4",a+=" v"+-t,a+=" a4,4 0 0 1 4,-4",a+=" z",ae.attr("d",a)}(),Be(),Ve()}function Ve(){if(C.text(""),O.text(""),L&&_e[b.Component.SHADING]){var e=L.getSkyPatchPolygons(),t=e.length;if(p=L.getShadingData().length,0<L.skyType())for(var i=0;i<t;++i)C.append("path").datum({type:"Polygon",coordinates:e[i].polygon}).attr({id:"@"+i,class:"tweenable",stroke:l?"inherit":e[i].color,fill:e[i].color,"fill-opacity":1,d:Ee});else{i=0;var a=1,r="inherit",n="#000000";for(u=L.skyType(),e[0].color?(n=function(){return e[i].color},0<u?l||(r=function(){return e[i].color}):a=function(){return e[i].shading}):a=function(){return e[i].shading},i=0;i<t;++i)C.append("path").datum({type:"Polygon",coordinates:e[i].polygon}).attr({class:"tweenable",stroke:r,"fill-opacity":a,fill:n,d:Ee})}xe==b.PROJ_CARTESIAN&&O.append("use").style("visibility",pd.closeTo(s.northOffset(),0,.001)?"hidden":"visible").attr("xlink:href","#shading")}b.updateSkySegmentOutlines(!0),b.handleNorthChange(),!1,ue=null}function Be(){if(s){var e=s.year();fe.setLocation(s.latitude(),s.longitude(),s.timezone()),Pe.rotate([-s.longitude(),-s.latitude()]),f.selectAll(".countries path").attr("d",Ce),f.selectAll(".land").attr("d",Ce),R.text(""),k.text(""),Ue(k,new Date(e,11,21),"sun-path-thick solid",!1);for(var t=21==o?12:11,i=21==o?6:5;i<t;++i)Ue(k,new Date(e,i,o),"sun-path stroke-dashed",!1);Ue(k,new Date(e,5,21),"sun-path-thick solid",!1);for(var a=fe.getAnalemmaSunPathsAsArray(7,0,24,1),r=0,n=a.length;r<n;++r)k.append("path").datum({type:"LineString",coordinates:a[r]}).attr("class","tweenable sun-path stroke-dashed").attr("d",Ee);Fe()}}function Ue(e,t,i,a){fe.setDate(t);for(var r=fe.sunriseTime(),n=fe.sunsetTime(),s=fe.getDailySunPathSegmentsAsArray(.25),o=0,l=s.length;o<l;++o)e.append("path").datum({type:"LineString",coordinates:s[o]}).attr("class","tweenable "+i).attr("d",Ee);if(a){var d=e.selectAll("g").data(d3.range(Math.ceil(r),Math.ceil(n)),function(e){return+e}).enter().append("g").attr("transform",function(e){return"translate("+Oe(fe.setTimeOfDayAndGetArray(e))+")"});d.append("circle").attr("class","hilite-shape").attr("r",A),d.append("text").text(function(e){return e<10?"0"+e:e}).attr("class","text-hilite").attr("text-anchor","middle").attr("dy","-0.65em")}}function Fe(){B.text("");var e=s.clockTime(),t=Math.floor(e),i=Math.floor(60*(e-t)),a=new Date(s.year(),s.monthOfYear(),s.dayOfMonth(),t,i);Ue(B,a,"line-hilite",!0),V.datum(fe.setDateTimeAndGetArray(a)).attr("transform",function(e){return"translate("+Oe(e)+")"}),W&&re&&re.text("Lat: "+s.latitude().toFixed(2)+"°, Lng: "+s.longitude().toFixed(2)+"°, TZ: "+s.timezoneAsString()),He()}function He(){var e=s.azimuthAngle(),t=s.altitudeAngle();xe!=b.PROJ_CARTESIAN&&_e[b.Component.SUN_POSITION]&&(V.attr("opacity",pd.mapAndConstrainTo(t,-6,0,0,1)),V.style("visibility",-1<t?"visible":"hidden"));var i=Oe([e,0]),a=Oe([e,xe==b.PROJ_CARTESIAN?t:90]);K&&(K.attr("x1",i[0]).attr("y1",i[1]).attr("x2",a[0]).attr("y2",a[1]),Z.attr("cx",i[0]).attr("cy",i[1]),i=Oe([0,t]),a=Oe([e,t]),J.attr("cx",i[0]).attr("cy",i[1]),xe==b.PROJ_CARTESIAN?(ee.attr("r",0),Q.attr("x1",i[0]).attr("y1",i[1]).attr("x2",a[0]).attr("y2",a[1])):(a=Oe([0,90]),ee.attr("r",t<0?0:Math.abs(i[1]-a[1])).attr("cx",a[0]).attr("cy",a[1]),Q.attr("x1",a[0]).attr("y1",a[1]).attr("x2",a[0]).attr("y2",a[1]))),W&&(ne&&ne.text("Date: "+s.dateAsString()),se&&se.text("Time: "+s.timeAsString()))}function ze(e,t){switch(t=!!t,e){case b.Component.AXIS:N.style("visibility",t?"visible":"hidden"),G.style("visibility",t?"visible":"hidden"),_e[e]=t,b.updateSkySegmentOutlines(!0);break;case b.Component.WORLD_MAP:x.style("visibility",t?"visible":"hidden"),z.style("visibility",t?"visible":"hidden"),P.selectAll("path").attr("class",t?"background-map":"background-daylight"),t&&!me&&d3.json("data/world-110m.json",Re),v.style.cursor=t?"move":"default",dt(_e[e]=t);break;case b.Component.ANNUAL_AREA:R.style("visibility",t?"visible":"hidden"),_e[e]=t,b.refresh();break;case b.Component.ANNUAL_LINES:k.style("visibility",t?"visible":"hidden"),_e[e]=t;break;case b.Component.SUN_ANGLES:I.style("visibility",t?"visible":"hidden"),_e[e]=t;break;case b.Component.DIURNAL_SUN_PATH:B.style("visibility",t?"visible":"hidden"),_e[e]=t;break;case b.Component.SUN_POSITION:V.style("visibility",t?"visible":"hidden"),_e[e]=t,He();break;case b.Component.SHADING:g.isValid?(g.show=xe!=b.PROJ_CARTESIAN,g.canvas.style.display=g.show?"block":"none",_e[e]=!g.show,t?C.style("visibility",g.show?"hidden":"visible"):C.style("visibility","hidden")):(C.style("visibility",t?"visible":"hidden"),_e[e]=t),t&&b.updateShading(!0);break;case b.Component.ALL:for(var i=b.Component.ALL-1;0<=i;i--)ze(i,t)}}function We(){g.sunpath3D.draw2D(500,500*g.size)}Ge(),this.show=function(e){var t;t=void 0!==e&&e.length?e:arguments,g.isValid&&g.isMaster&&g.sunpath3D.show(t);for(var i=0,a=t.length;i<a;++i)ze(+t[i],!0);return b},this.hide=function(e){var t;t=void 0!==e&&e.length?e:arguments,g.isValid&&g.isMaster&&g.sunpath3D.hide(t);for(var i=0,a=t.length;i<a;++i)ze(+t[i],!1);return b},this.focus=function(){return m&&m.focus(),b},this.isVisible=function(e){return 0<=e&&e<b.Component.ALL&&_e[e]},this.width=function(e){return arguments.length?(D=parseInt(e,10),m.width(D),b.refresh(),b):D},this.height=function(e){return arguments.length?(E=parseInt(e,10),m.height(E),b.refresh(),b):E},this.solarPosition=function(e){return arguments.length?(s=e,b.refresh(),b):s},this.updateLockScale=function(){return L&&pe&&pe.classed("hidden",!L.lockScale()),b},this.throttledRescale=function(e){return arguments.length?(a=pd.constrainTo(parseInt(e,10),0,5e3),b):a},this.dayForMonthlyLines=function(e){return arguments.length?(o=pd.constrainTo(parseInt(e,10),1,31),b):o},this.projectionType=function(e){return arguments.length?((e=pd.constrainTo(parseInt(e,10),b.PROJ_SPHERICAL,b.PROJ_CARTESIAN))!=xe&&(xe=e,ye=1,Ge(),Xe()),b):xe},this.updateSkySegmentOutlines=function(e){if(q&&q.style("visibility",!l&&b.isVisible(b.Component.AXIS)?"visible":"hidden"),C){if(l){var t=L&&0<L.skyType();C.classed("line-grid",!t),C.classed("line-dark",t)}else C.classed("line-grid",!1),C.classed("line-dark",!1);e||(ue||(ue=C.selectAll("path")),ue.attr("stroke","inherit"))}return g.isValid&&g.show&&g.update(),b},g={show:!(this.showSkySegments=function(e){if(!arguments.length)return l;var t=!!e,i=l!=t;return l=t,g.isValid&&g.isMaster&&g.sunpath3D.showSkySegments(e),b.updateSkySegmentOutlines(),i&&!l&&0<L.skyType()&&b.updateShading(),b}),isValid:!1,isMaster:!1,sunpath3D:null,texture:null,canvas:null,size:.85,update:function(){this.texture.drawToCanvas(this.canvas,We)},showSVGShading:function(e){C.style("visibility",e?"visible":"hidden"),_e[b.Component.SHADING]=e}},this.linkToSunPath3D=function(e){if((e=e||{}).sunpath3D&&e.canvas&&e.texture){g.isValid=!0,g.isMaster=pd.toBoolean(e.isMaster,!1),g.sunpath3D=e.sunpath3D,g.texture=e.texture,g.canvas=e.canvas,g.size=pd.toNumber(e.size,.85);var t=pd.toBoolean(e.show,!0)&&xe!=b.PROJ_CARTESIAN;C.style("visibility",t?"hidden":"visible"),g.canvas.style.display=t?"block":"none",_e[b.Component.SHADING]=!t,g.show=t}else g.show=!1,g.isValid=!1,g.isMaster=!1,g.sunpath3D=null,g.texture=null,g.canvas=null,g.size=.85,ze(b.Component.SHADING,C&&L)},this.animateProjection=function(e){if(be=xe,xe=pd.constrainTo(parseInt(e,10),b.PROJ_SPHERICAL,b.PROJ_CARTESIAN),be!=xe){be!=b.PROJ_CARTESIAN&&xe!=b.PROJ_CARTESIAN||R.style("visibility","hidden"),B.style("visibility","hidden"),V.style("visibility","hidden"),I.style("visibility","hidden");var t=d3.geo.circle().origin([0,90]).angle(90);return be==b.PROJ_CARTESIAN&&N.append("path").datum(t).attr("class","tweenable fade-in line-black").attr("d",Ee),be==b.PROJ_CARTESIAN||xe==b.PROJ_CARTESIAN?(g.isValid&&(g.canvas.style.display="none",g.showSVGShading(!1),g.show=!1),G.style("visibility","hidden"),_e[b.Component.WORLD_MAP]?(P.text(""),P.append("path").datum(t).attr("class","tweenable stroke-none background-map").attr("d",Ee)):P.style("visibility","hidden")):g.isValid&&(g.showSVGShading(!1),g.show=!0),!(ye=0)}return!1},this.updateAnimation=function(e){if((ye=e)<.999){if(xe==b.PROJ_CARTESIAN?(f.selectAll("path.fade-out").attr("stroke-opacity",1-e),T=(e*E*.775+(1-e)*Math.min(D,E))*_,Oe.translate([D/2,E/2*(1-e)+e*E*.775]).clipAngle(.9<=ye?null:pd.mapAndConstrainTo(ye,.5,.9,90.1,180)).rotate([0,-90*(1-e)]).scale(T),Pe.scale(T)):be==b.PROJ_CARTESIAN&&(f.selectAll("path.fade-in").attr("stroke-opacity",e),T=((1-e)*E*.775+e*Math.min(D,E))*_,Oe.translate([D/2,e*(E/2)+(1-e)*E*.775]).clipAngle(.1<=ye?pd.mapAndConstrainTo(ye,.1,.5,180,90.1):null).rotate([0,-90*e]).scale(T),Pe.scale(T)),xe!=b.PROJ_CARTESIAN&&be!=b.PROJ_CARTESIAN||f.selectAll("path.tickable[d]").attr("d",Ee),g.isValid&&g.show){var t=g.sunpath3D.projectionTransitions();t[be]=1-e,t[xe]=e,g.update()}f.selectAll("path.tweenable[d]").attr("d",Ee),f.selectAll(".countries path").attr("d",Ce),f.selectAll(".land").attr("d",Ce)}else Xe(),ye=1,I.style("visibility",b.isVisible(b.Component.SUN_ANGLES)?"visible":"hidden"),R.style("visibility",b.isVisible(b.Component.ANNUAL_AREA)?"visible":"hidden"),G.style("visibility",b.isVisible(b.Component.AXIS)?"visible":"hidden"),B.style("visibility",b.isVisible(b.Component.DIURNAL_SUN_PATH)?"visible":"hidden"),V.style("visibility",b.isVisible(b.Component.SUN_POSITION)?"visible":"hidden"),C.style("visibility",b.isVisible(b.Component.SHADING)?"visible":"hidden"),P.style("visibility","visible"),b.handleNorthChange(),g.isValid&&(g.sunpath3D.projectionType(xe),g.show=xe!=b.PROJ_CARTESIAN,g.show?(g.canvas.style.display="block",g.showSVGShading(!1),g.update()):(g.canvas.style.display="none",g.showSVGShading(!0)));return b},this.shadingMask=function(e){return arguments.length?((L=e)?b.updateShading(!0):C.text(""),b):(L||(L=new pd.Shading),L)},this.getShadingIterator=function(){return L?L.getShadingIterator():null},this.getShading=function(){return L?L.getShadingData():null},this.setShadingSegmentValue=function(e,t){return L&&L.setSkyPatchShading(e,t),b},this.updateShading=function(e){if(C&&L)if(g.isValid&&g.show)!0,g.isMaster&&g.sunpath3D.updateShading(e),g.update();else if(_e[b.Component.SHADING]){var i=L.getShadingData();if(e||p!=i.length)p=i.length,Ve();else{var t={},a=L.getSkyLuminanceCSSColors();j&&function(){if(oe&&L){var e=L.skyDistributionScale();L.isCumulative()?ce.text(L.useIlluminance()?"cd.h/m2":"Wh/m2"):ce.text(L.useIlluminance()?"cd/m2":"W/m2"),de.text((.5*e).toFixed(2)),le.text(e.toFixed(2)),he.text("0.00"),b.updateLockScale()}}(),u<=0&&0<L.skyType()&&(t.stroke="inherit"),u=L.skyType(),a&&a.length?(t.fill=function(e,t){return a[t]},0<u?(l||(t.stroke=function(e,t){return a[t]}),t["fill-opacity"]=1):t["fill-opacity"]=function(e,t){return i[t]}):(t["fill-opacity"]=function(e,t){return i[t]},t.fill="#000000"),ue||(ue=C.selectAll("path")),ue.attr(t)}!1}else!0;return function(){if(0<=Qe){var e=L.getSkyPatchContribution(Qe);999<e?te.text(e.toFixed(1)):9.99<e?te.text(e.toFixed(2)):te.text(e.toFixed(3))}}(),b},this.setShading=function(e,t){return L&&L.setShadingData(e),t?!0:b.updateShading(),b},this.clearShading=function(e){return L&&L.clearShadingData(),e?!0:b.updateShading(),b};var je=null;function Xe(){je=null,Ie(),ke()}this.rescale=function(){4<a?null==je&&(je=setTimeout(Xe,a)):Xe()},this.refresh=function(){return ke(),b},this.getExportableText=function(e){var t='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n';g.isValid&&g.show&&(g.showSVGShading(!0),Ve());var i=v.cloneNode(!0);i.setAttributeNS(null,"preserveAspectRatio","xMidYMid"),i.setAttributeNS(null,"style",""),e&&i.setAttribute("xmlns:inkscape","http://www.inkscape.org/namespaces/inkscape"),t+='<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n';var a=" .svg-chart { font-family: sans-serif; font-size: 14px; } .svg-chart .line-grid { stroke-width: 0.5px; stroke-opacity: 0.5; stroke: #888; fill: none; } .svg-chart .line-dark { stroke-width: 0.5px; stroke-opacity: 1.0; stroke: #444; fill: none; } .svg-chart .line-axis { stroke-width: 1px; stroke: #666; fill: none; } .svg-chart .line-hilite { stroke-width: 1.5px; stroke: #F00; fill: none; } .svg-chart .line-blue { stroke-width: 1px; stroke: #00F; fill: none; } .svg-chart .line-black { stroke-width: 1px; stroke: #000; fill: none; } .svg-chart .text-grid { font-size: 0.6em; stroke: none; fill: #888; } .svg-chart .text-axis { font-size: 0.7em; stroke: none; fill: #000; } .svg-chart .text-hilite { font-size: 0.75em; font-weight: 500; stroke: none; fill: #F00; } .svg-chart .text-blue { font-size: 1.0em; stroke: none; fill: #00F; } .svg-chart text.bold6:nth-of-type(6n + 1) { font-weight: bold; font-size: 1.1em; } .svg-chart .hilite-circle { stroke: #F00; stroke-width: 1px; fill: #F00; } .svg-chart .hilite-shape { stroke: #F00; stroke-width: 1.25px; fill: #FFF; } .svg-chart .hilite-axis { stroke-width: 0.75px; stroke-dasharray: 4, 3; stroke: #F00; fill: none; } .svg-chart .sun-path { stroke-width: 1.25px; stroke: #f90; fill: none; } .svg-chart .sun-path-thick { stroke-width: 1.5px; stroke: #f90; fill: none; } .svg-chart .stroke-dashed { stroke-dasharray: 2, 3; } .svg-chart .background-daylight { fill: none; } .svg-chart .background-map { fill: #b3d1ff; }";return xe==b.PROJ_CARTESIAN&&(a+=" .svg-chart .text-twilight-dark { font-size: 0.76em; fill: #036; } .svg-chart .text-twilight { font-size: 0.76em; fill: #7AE; } .svg-chart .fill-astronomical { fill: #036; } .svg-chart .fill-nautical { fill: #369; } .svg-chart .fill-civil { fill: #69C; } .svg-chart .fill-night { fill: #012; }"),_e[b.Component.WORLD_MAP]&&(a+=" .svg-chart .countries path { stroke: #ccddff; stroke-linejoin: round; stroke-width: 0.75px; fill: none; } .svg-chart .land { stroke-opacity: 1; fill: #fff; }"),t+=i.outerHTML.replace("<style></style>",'<style type="text/css">/* <![CDATA[ */'+a+" /* ]]> */</style>"),e&&(t=t.replace(/<g id=/g,'<g inkscape:groupmode="layer" inkscape:label=')),g.isValid&&g.show&&(g.showSVGShading(!1),Ve()),t},this.handleLocationChange=function(){return Be(),b},this.handleDateChange=function(){return Fe(),b},this.handleTimeChange=function(){return fe.setDayMonthYear(s.dayOfMonth(),s.monthOfYear(),s.year()),V.datum(fe.setTimeOfDayAndGetArray(s.clockTime())).attr("transform",function(e){return"translate("+Oe(e)+")"}),He(),b},this.handleDateTimeChange=function(){return Fe(),b};var Ye=!(this.handleNorthChange=function(){if(L){var e=Oe([0,90]);if(xe==b.PROJ_CARTESIAN){var t=Oe([-s.northOffset(),90]);if(C.attr("transform",function(){return"translate("+(t[0]-e[0])+", 0.0)"}),xe==b.PROJ_CARTESIAN){var i=pd.sign(s.northOffset())*D;O.style("visibility",pd.closeTo(s.northOffset(),0,.001)?"hidden":"visible").attr("transform",function(){return"translate("+i+", 0.0)"})}}else C.attr("transform",function(){return"rotate("+-s.northOffset()+", "+e[0]+", "+e[1]+")"}),g.isValid&&g.show&&g.update()}return b}),qe=!1,Je={x:NaN,y:NaN},Qe=-1,Ze=null;function Ke(){F.attr("opacity","0.0"),Ye=!1,null!=Ze&&(clearTimeout(Ze),Ze=null)}function $e(e){qe||(F.attr("display","inline"),qe=!0),Ye||(F.attr("opacity","1.0"),Ye=!0),null!=Ze&&(clearTimeout(Ze),Ze=null),e&&(Ze=setTimeout(Ke,2500))}function et(e,t){var i=-1;if(L&&e.event&&e.event.pageX){var a=Je.x,r=Je.y,n=e.event.pageX,s=e.event.pageY,o=e.x-n,l=e.y-s;if(e.isTouchEvent){var d=0<e.button?.2:1;isNaN(a)?a=n:a+=e.dragX*d,isNaN(r)?r=s:r+=e.dragY*d}else a=n,r=s;var h=document.elementFromPoint(Math.round(a),Math.round(r));if(h&&h.id){var c=h.id;if("@"==c.charAt(0)&&0<=(i=pd.toNumber(c.substr(1),-1))){F.attr("transform","translate("+(a+o)*pdDOM.pageScale+", "+(r+l)*pdDOM.pageScale+")");var p=L.getSkyPatchContribution(i);return 999<p?te.text(p.toFixed(1)):9.99<p?te.text(p.toFixed(2)):te.text(p.toFixed(3)),Ye&&!t||$e(!1),Qe=i,Je.x=a,Je.y=r,!0}}}return Ye&&Ke(),!(Qe=-1)}this.activateTooltip=function(){return b};var tt=[0,0],it=null,at=!1;function rt(e){m&&m.focus(),0<=e.button&&e.button<2&&(_e[b.Component.WORLD_MAP]?(d&&d.storeValues(h,c),it=Pe.rotate(),tt=[e.x,e.y],H.style("visibility","visible"),at=!0):(ie.classed("hidden",!0),et(e,!0)))}function nt(e){if(0<=e.button&&e.button<2)if(at){var t=it[0]+.15*(e.x-tt[0]),i=it[1]+.15*(tt[1]-e.y);i=pd.constrainTo(i,-90,90),h&&!pd.closeTo(h(),-i,.001)&&h(-i),t=pd.wrapAt(t,-180,180),c&&!pd.closeTo(c(),-t,.001)&&c(-t)}else et(e,!1)}function st(e){0<=e.button&&e.button<2&&(at?(H.style("visibility","hidden"),d&&d.checkForChanges(),at=!1):0<=Qe&&$e(!0))}function ot(e){j&&X&&e.x>D-45&&e.y<=Y?X(e):0<=Qe&&(ie.classed("hidden",!1),$e(!1))}function lt(){}function dt(e){ve&&(ve.dispose(),ve=null),e&&i&&(ve=pdDOM.Interaction.makeInteractive(v,{onpress:rt,ondrag:nt,onrelease:st,ondoubletap:ot,onlongpress:ot,onscroll:lt}))}return m.attr("xmlns","http://www.w3.org/2000/svg"),pdDOM.addClass(v,"svg-chart",!0),pdDOM.toggleClass(v,"interactive",i),v.style.cursor="default",$(document).ready(function(){_e[b.Component.WORLD_MAP]&&d3.json("data/world-110m.json",Re),i&&dt(!0)}),this},L.EdgeScaleBar=L.Layer.extend({options:{opacity:1,weight:.8,color:"#000",font:"11px Arial",zoomInterval:[{start:1,end:2,interval:5e6},{start:3,end:3,interval:2e6},{start:4,end:4,interval:1e6},{start:5,end:5,interval:5e5},{start:6,end:7,interval:2e5},{start:8,end:8,interval:1e5},{start:9,end:9,interval:5e4},{start:10,end:10,interval:2e4},{start:11,end:11,interval:1e4},{start:12,end:12,interval:5e3},{start:13,end:13,interval:2e3},{start:14,end:14,interval:1e3},{start:15,end:15,interval:500},{start:16,end:16,interval:200},{start:17,end:17,interval:100},{start:18,end:18,interval:50},{start:19,end:19,interval:20},{start:20,end:20,interval:10}]},initialize:function(e){L.setOptions(this,e),this._a=6378137,this._b=6356752.3142,this._e2=(this._a*this._a-this._b*this._b)/(this._a*this._a),this._n=(this._a-this._b)/(this._a+this._b),this._n2=this._n*this._n,this._A=this._a*(1-this._n)*(1-this._n2)*(1+9/4*this._n2+225/64*this._n2*this._n2),this._ic1=1.5*this._n-29/12*this._n2*this._n+6.9125*this._n2*this._n2*this._n,this._ic2=21/8*this._n2-1537/128*this._n2*this._n2,this._ic3=151/24*this._n2*this._n-32373/640*this._n2*this._n2*this._n,this._ic4=1097/64*this._n2*this._n2,this._ic5=8011/150*this._n2*this._n2*this._n,this._c1=-1.5*this._n+31/24*this._n2*this._n-669/640*this._n2*this._n2*this._n,this._c2=15/18*this._n2-435/128*this._n2*this._n2,this._c3=-35/12*this._n2*this._n+8.1375*this._n2*this._n2*this._n,this._c4=315/64*this._n2*this._n2,this._c5=-8.6625*this._n2*this._n2*this._n,this._LIMIT_PHI=1.484419982},onAdd:function(e){this._map=e,this._container||this._initCanvas(),e._panes.overlayPane.appendChild(this._container),e.on("viewreset",this._reset,this),e.on("move",this._reset,this),e.on("moveend",this._reset,this),this._reset()},onRemove:function(e){e.getPanes().overlayPane.removeChild(this._container),e.off("viewreset",this._reset,this),e.off("move",this._reset,this),e.off("moveend",this._reset,this)},addTo:function(e){return e.addLayer(this),this},setOpacity:function(e){return this.options.opacity=e,this._updateOpacity(),this},bringToFront:function(){return this._canvas&&this._map._panes.overlayPane.appendChild(this._canvas),this},bringToBack:function(){var e=this._map._panes.overlayPane;return this._canvas&&e.insertBefore(this._canvas,e.firstChild),this},getAttribution:function(){return this.options.attribution},_initCanvas:function(){this._container=L.DomUtil.create("div","leaflet-image-layer"),this._canvas=L.DomUtil.create("canvas",""),this._ctx=this._canvas.getContext("2d"),this._vert_gradientFill=this._ctx.createLinearGradient(0,0,0,10),this._vert_gradientFill.addColorStop(0,"rgba(255, 255, 255, 1)"),this._vert_gradientFill.addColorStop(1,"rgba(255, 255, 255, 0)"),this._hor_gradientFill=this._ctx.createLinearGradient(this._map.getSize().x-10,0,this._map.getSize().x,0),this._hor_gradientFill.addColorStop(0,"rgba(255, 255, 255, 0)"),this._hor_gradientFill.addColorStop(1,"rgba(255, 255, 255, 1)"),this._updateOpacity(),this._container.appendChild(this._canvas),L.extend(this._canvas,{onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.bind(this._onCanvasLoad,this)})},_reset:function(){var e=this._container,t=this._canvas,i=this._map.getSize(),a=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(e,a),e.style.width=i.x+"px",e.style.height=i.y+"px",t.width=i.x,t.height=i.y,t.style.width=i.x+"px",t.style.height=i.y+"px",this._ctx.beginPath(),this._ctx.moveTo(0,0),this._ctx.lineTo(i.x,0),this._ctx.lineTo(i.x,i.y),this._ctx.stroke(),this._calcInterval(),this._draw()},_onCanvasLoad:function(){this.fire("load")},_updateOpacity:function(){L.DomUtil.setOpacity(this._canvas,this.options.opacity)},_calcInterval:function(){var e=this._map.getZoom();for(var t in this.options.zoomInterval){var i=this.options.zoomInterval[t];if(i.start<=e&&i.end&&i.end>=e){this._dd=i.interval;break}}this._currZoom=e},_draw:function(){this._ctx.strokeStyle=this.options.color,this._create_lat_ticks(),this._create_lon_ticks(),this._ctx.fillStyle=this.options.color,this._ctx.font=this.options.font;var e=" m",t=this._dd;1e3<=this._dd&&(e=" km",t=this._dd/1e3),this._ctx.textAlign="right",this._ctx.textBaseline="middle",this._ctx.fillText(t+e,this._map.getSize().x-12,this._map.getSize().y/2),this._ctx.textAlign="center",this._ctx.textBaseline="top",this._ctx.fillText(t+e,this._map.getSize().x/2,12)},_create_lat_ticks:function(){var e=this._map.containerPointToLatLng(L.point(0,this._map.getSize().y/2)).lat,t=this._map.containerPointToLatLng(L.point(0,this._map.getSize().y)).lat,a=this._map.containerPointToLatLng(L.point(0,0)).lat,r=this._merLength(e*Math.PI/180),n=this._merLength(a*Math.PI/180),s=this._merLength(t*Math.PI/180);for(i=r+this._dd/2;i<n;i+=this._dd){(o=this._invmerLength(i))<this._LIMIT_PHI&&o>-this._LIMIT_PHI&&this._draw_lat_tick(o,10,1.5*this.options.weight)}for(i=r-this._dd/2;i>s;i-=this._dd){(o=this._invmerLength(i))>-this._LIMIT_PHI&&o<this._LIMIT_PHI&&this._draw_lat_tick(o,10,1.5*this.options.weight)}for(i=r;i<n;i+=this._dd/10){(o=this._invmerLength(i))<this._LIMIT_PHI&&o>-this._LIMIT_PHI&&this._draw_lat_tick(o,4,this.options.weight)}for(i=r-this._dd/10;i>s;i-=this._dd/10){var o;(o=this._invmerLength(i))>-this._LIMIT_PHI&&o<this._LIMIT_PHI&&this._draw_lat_tick(o,4,this.options.weight)}},_create_lon_ticks:function(){var e=this._map.containerPointToLatLng(L.point(this._map.getSize().x/2,0)),t=this._map.containerPointToLatLng(L.point(0,0)),a=this._map.containerPointToLatLng(L.point(this._map.getSize().x,0)),r=Math.sin(e.lat*Math.PI/180),n=this._a/Math.sqrt(1-this._e2*r*r),s=this._dd/(n*Math.cos(e.lat*Math.PI/180))*180/Math.PI;for(i=e.lng+s/2;i<a.lng;i+=s)this._draw_lon_tick(i,10,1.5*this.options.weight);for(i=e.lng-s/2;i>t.lng;i-=s)this._draw_lon_tick(i,10,1.5*this.options.weight);for(i=e.lng;i<a.lng;i+=s/10)this._draw_lon_tick(i,4,this.options.weight);for(i=e.lng-s/10;i>t.lng;i-=s/10)this._draw_lon_tick(i,4,this.options.weight)},_latLngToCanvasPoint:function(e){var t=this._map.project(L.latLng(e));return t._subtract(this._map.getPixelOrigin()),L.point(t).add(this._map._getMapPanePos())},_draw_lat_tick:function(e,t,i){var a=this._latLngToCanvasPoint(L.latLng(180*e/Math.PI,0)).y;this._ctx.lineWidth=i,this._ctx.beginPath(),this._ctx.moveTo(this._map.getSize().x,a),this._ctx.lineTo(this._map.getSize().x-t,a),this._ctx.stroke()},_draw_lon_tick:function(e,t,i){var a=this._latLngToCanvasPoint(L.latLng(0,e)).x;this._ctx.lineWidth=i,this._ctx.beginPath(),this._ctx.moveTo(a,0),this._ctx.lineTo(a,t),this._ctx.stroke()},_merLength:function(e){var t=Math.cos(2*e);return this._A*(e+Math.sin(2*e)*(this._c1+(this._c2+(this._c3+(this._c4+this._c5*t)*t)*t)*t))},_invmerLength:function(e){var t=e/this._A,i=Math.cos(2*t);return t+Math.sin(2*t)*(this._ic1+(this._ic2+(this._ic3+(this._ic4+this._ic5*i)*i)*i)*i)}}),L.edgeScaleBar=function(e){return new L.EdgeScaleBar(e)};
